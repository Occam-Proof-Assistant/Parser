'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var necessary = require('necessary');

var bnfUtilities = require('../../utilities/bnf'),
    OptionalPartPart = require('../part/nonTerminal/optionalPart'),
    ZeroOrMorePartsPart = require('../part/nonTerminal/zeroOrMoreParts'),
    OneOrMorePartsPart = require('../part/nonTerminal/oneOrMoreParts'),
    GroupOfPartsPart = require('../part/nonTerminal/groupOfParts'),
    ChoiceOfPartsPart = require('../part/nonTerminal/choiceOfParts'),
    NonTerminalNode = require('../../common/node/nonTerminal');

var array = necessary.array,
    first = array.first,
    last = array.last;

var PartNode = function (_NonTerminalNode) {
  _inherits(PartNode, _NonTerminalNode);

  function PartNode() {
    _classCallCheck(this, PartNode);

    return _possibleConstructorReturn(this, (PartNode.__proto__ || Object.getPrototypeOf(PartNode)).apply(this, arguments));
  }

  _createClass(PartNode, [{
    key: 'generatePart',
    value: function generatePart(noWhitespace) {
      var part = null;

      var childNodes = this.getChildNodes(),
          nodes = childNodes.slice(); ///

      removeLastNullifiedNodeFromNodes(nodes);

      var quantifiers = quantifiersFromNodes(nodes);

      noWhitespace = noWhitespaceFromNodes(nodes, noWhitespace);

      var nodesLength = nodes.length;

      if (nodesLength === 1) {
        var firstNode = first(nodes),
            node = firstNode; ///

        part = partFromNode(node, noWhitespace);
      } else {
        part = partFromNodes(nodes);
      }

      part = partFromPartAndQuantifiers(part, quantifiers);

      return part;
    }
  }], [{
    key: 'fromNodesAndRuleName',
    value: function fromNodesAndRuleName(nodes, ruleName) {
      return NonTerminalNode.fromNodesAndRuleName(PartNode, nodes, ruleName);
    }
  }]);

  return PartNode;
}(NonTerminalNode);

module.exports = PartNode;

function removeLastNullifiedNodeFromNodes(nodes) {
  var lastNodeNullifiedNode = false;

  var lastNode = last(nodes),
      lastNodeTerminalNode = lastNode.isTerminalNode(),
      lastNodeNonTerminalNode = !lastNodeTerminalNode;

  if (lastNodeNonTerminalNode) {
    var nonTerminalNode = lastNode,
        ///
    childNodes = nonTerminalNode.getChildNodes(),
        childNodesLength = childNodes.length;

    if (childNodesLength === 1) {
      var firstChildNode = first(childNodes),
          firstChildNodeTerminalNode = firstChildNode.isTerminalNode();

      if (firstChildNodeTerminalNode) {
        var firstChildNodeEpsilonNode = firstChildNode.isEpsilonNode(),
            _lastNodeNullifiedNode = firstChildNodeEpsilonNode; ///

        if (_lastNodeNullifiedNode) {
          nodes.pop();
        }
      }
    }
  }

  return lastNodeNullifiedNode;
}

function noWhitespaceFromNodes(nodes, noWhitespace) {
  var firstNode = first(nodes),
      firstNodeNoWhitespaceNode = bnfUtilities.isNodeNoWhitespaceNode(firstNode);

  if (firstNodeNoWhitespaceNode) {
    noWhitespace = true;

    var begin = 0,
        deleteCount = 1;

    nodes.splice(begin, deleteCount);
  }

  return noWhitespace;
}

function quantifiersFromNodes(nodes) {
  var quantifiers = [];

  var lastNode = last(nodes),
      lastNodeQuantifiersNode = bnfUtilities.isNodeQuantifiersNode(lastNode);

  if (lastNodeQuantifiersNode) {
    var quantifiersNode = lastNode; ///

    quantifiers = bnfUtilities.quantifiersFromQuantifiersNode(quantifiersNode);

    var begin = -1,
        deleteCount = 1;

    nodes.splice(begin, deleteCount);
  }

  return quantifiers;
}

function partFromNode(node, noWhitespace) {
  var part = node.generatePart(noWhitespace);

  return part;
}

function partFromNodes(nodes) {
  var part = null;

  var choiceOfPartsPart = ChoiceOfPartsPart.fromNodes(nodes);

  if (choiceOfPartsPart !== null) {
    part = choiceOfPartsPart; ///
  } else {
    var groupOfPartsPart = GroupOfPartsPart.fromNodes(nodes);

    if (groupOfPartsPart !== null) {
      part = groupOfPartsPart; ///
    }
  }

  return part;
}

function partFromPartAndQuantifiers(part, quantifiers) {
  var quantifiersLength = quantifiers.length;

  if (quantifiersLength > 0) {
    var quantifier = quantifiers.shift(),
        sequenceOfPartsPart = sequenceOfPartsPartFromPartAndQuantifier(part, quantifier);

    part = sequenceOfPartsPart; ///

    part = partFromPartAndQuantifiers(part, quantifiers);
  }

  return part;
}

function sequenceOfPartsPartFromPartAndQuantifier(part, quantifier) {
  var sequenceOfPartsPart = void 0;

  switch (quantifier) {
    case '?':
      var optionalPartPart = new OptionalPartPart(part);

      sequenceOfPartsPart = optionalPartPart; ///
      break;

    case '*':
      var zeroOrMorePartsPart = new ZeroOrMorePartsPart(part);

      sequenceOfPartsPart = zeroOrMorePartsPart; ///
      break;

    case '+':
      var oneOrMorePartsPart = new OneOrMorePartsPart(part);

      sequenceOfPartsPart = oneOrMorePartsPart; ///
      break;
  }

  return sequenceOfPartsPart;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2VzNi9ibmYvbm9kZS9wYXJ0LmpzIl0sIm5hbWVzIjpbIm5lY2Vzc2FyeSIsInJlcXVpcmUiLCJibmZVdGlsaXRpZXMiLCJPcHRpb25hbFBhcnRQYXJ0IiwiWmVyb09yTW9yZVBhcnRzUGFydCIsIk9uZU9yTW9yZVBhcnRzUGFydCIsIkdyb3VwT2ZQYXJ0c1BhcnQiLCJDaG9pY2VPZlBhcnRzUGFydCIsIk5vblRlcm1pbmFsTm9kZSIsImFycmF5IiwiZmlyc3QiLCJsYXN0IiwiUGFydE5vZGUiLCJub1doaXRlc3BhY2UiLCJwYXJ0IiwiY2hpbGROb2RlcyIsImdldENoaWxkTm9kZXMiLCJub2RlcyIsInNsaWNlIiwicmVtb3ZlTGFzdE51bGxpZmllZE5vZGVGcm9tTm9kZXMiLCJxdWFudGlmaWVycyIsInF1YW50aWZpZXJzRnJvbU5vZGVzIiwibm9XaGl0ZXNwYWNlRnJvbU5vZGVzIiwibm9kZXNMZW5ndGgiLCJsZW5ndGgiLCJmaXJzdE5vZGUiLCJub2RlIiwicGFydEZyb21Ob2RlIiwicGFydEZyb21Ob2RlcyIsInBhcnRGcm9tUGFydEFuZFF1YW50aWZpZXJzIiwicnVsZU5hbWUiLCJmcm9tTm9kZXNBbmRSdWxlTmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJsYXN0Tm9kZU51bGxpZmllZE5vZGUiLCJsYXN0Tm9kZSIsImxhc3ROb2RlVGVybWluYWxOb2RlIiwiaXNUZXJtaW5hbE5vZGUiLCJsYXN0Tm9kZU5vblRlcm1pbmFsTm9kZSIsIm5vblRlcm1pbmFsTm9kZSIsImNoaWxkTm9kZXNMZW5ndGgiLCJmaXJzdENoaWxkTm9kZSIsImZpcnN0Q2hpbGROb2RlVGVybWluYWxOb2RlIiwiZmlyc3RDaGlsZE5vZGVFcHNpbG9uTm9kZSIsImlzRXBzaWxvbk5vZGUiLCJwb3AiLCJmaXJzdE5vZGVOb1doaXRlc3BhY2VOb2RlIiwiaXNOb2RlTm9XaGl0ZXNwYWNlTm9kZSIsImJlZ2luIiwiZGVsZXRlQ291bnQiLCJzcGxpY2UiLCJsYXN0Tm9kZVF1YW50aWZpZXJzTm9kZSIsImlzTm9kZVF1YW50aWZpZXJzTm9kZSIsInF1YW50aWZpZXJzTm9kZSIsInF1YW50aWZpZXJzRnJvbVF1YW50aWZpZXJzTm9kZSIsImdlbmVyYXRlUGFydCIsImNob2ljZU9mUGFydHNQYXJ0IiwiZnJvbU5vZGVzIiwiZ3JvdXBPZlBhcnRzUGFydCIsInF1YW50aWZpZXJzTGVuZ3RoIiwicXVhbnRpZmllciIsInNoaWZ0Iiwic2VxdWVuY2VPZlBhcnRzUGFydCIsInNlcXVlbmNlT2ZQYXJ0c1BhcnRGcm9tUGFydEFuZFF1YW50aWZpZXIiLCJvcHRpb25hbFBhcnRQYXJ0IiwiemVyb09yTW9yZVBhcnRzUGFydCIsIm9uZU9yTW9yZVBhcnRzUGFydCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsZUFBZUQsUUFBUSxxQkFBUixDQUFyQjtBQUFBLElBQ01FLG1CQUFtQkYsUUFBUSxrQ0FBUixDQUR6QjtBQUFBLElBRU1HLHNCQUFzQkgsUUFBUSxxQ0FBUixDQUY1QjtBQUFBLElBR01JLHFCQUFxQkosUUFBUSxvQ0FBUixDQUgzQjtBQUFBLElBSU1LLG1CQUFtQkwsUUFBUSxrQ0FBUixDQUp6QjtBQUFBLElBS01NLG9CQUFvQk4sUUFBUSxtQ0FBUixDQUwxQjtBQUFBLElBTU1PLGtCQUFrQlAsUUFBUSwrQkFBUixDQU54Qjs7QUFRTSxJQUFFUSxLQUFGLEdBQVlULFNBQVosQ0FBRVMsS0FBRjtBQUFBLElBQ0VDLEtBREYsR0FDa0JELEtBRGxCLENBQ0VDLEtBREY7QUFBQSxJQUNTQyxJQURULEdBQ2tCRixLQURsQixDQUNTRSxJQURUOztJQUdBQyxROzs7Ozs7Ozs7OztpQ0FDU0MsWSxFQUFjO0FBQ3pCLFVBQUlDLE9BQU8sSUFBWDs7QUFFQSxVQUFNQyxhQUFhLEtBQUtDLGFBQUwsRUFBbkI7QUFBQSxVQUNNQyxRQUFRRixXQUFXRyxLQUFYLEVBRGQsQ0FIeUIsQ0FJUzs7QUFFbENDLHVD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QUFNSSxtQkFBbUIsSUFBSTdELGdCQUFKLENBQXFCVyxJQUFyQixDQUF6Qjs7QUFFQWdELDRCQUFzQkUsZ0JBQXRCLENBSEYsQ0FHMEM7QUFDeEM7O0FBRUYsU0FBSyxHQUFMO0FBQ0UsVUFBTUMsc0JBQXNCLElBQUk3RCxtQkFBSixDQUF3QlUsSUFBeEIsQ0FBNUI7O0FBRUFnRCw0QkFBc0JHLG1CQUF0QixDQUhGLENBRzhDO0FBQzVDOztBQUVGLFNBQUssR0FBTDtBQUNFLFVBQU1DLHFCQUFxQixJQUFJN0Qsa0JBQUosQ0FBdUJTLElBQXZCLENBQTNCOztBQUVBZ0QsNEJBQXNCSSxrQkFBdEIsQ0FIRixDQUc0QztBQUMxQztBQWpCSjs7QUFvQkEsU0FBT0osbUJBQVA7QUFDRCIsImZpbGUiOiJwYXJ0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgYm5mVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vLi4vdXRpbGl0aWVzL2JuZicpLFxuICAgICAgT3B0aW9uYWxQYXJ0UGFydCA9IHJlcXVpcmUoJy4uL3BhcnQvbm9uVGVybWluYWwvb3B0aW9uYWxQYXJ0JyksXG4gICAgICBaZXJvT3JNb3JlUGFydHNQYXJ0ID0gcmVxdWlyZSgnLi4vcGFydC9ub25UZXJtaW5hbC96ZXJvT3JNb3JlUGFydHMnKSxcbiAgICAgIE9uZU9yTW9yZVBhcnRzUGFydCA9IHJlcXVpcmUoJy4uL3BhcnQvbm9uVGVybWluYWwvb25lT3JNb3JlUGFydHMnKSxcbiAgICAgIEdyb3VwT2ZQYXJ0c1BhcnQgPSByZXF1aXJlKCcuLi9wYXJ0L25vblRlcm1pbmFsL2dyb3VwT2ZQYXJ0cycpLFxuICAgICAgQ2hvaWNlT2ZQYXJ0c1BhcnQgPSByZXF1aXJlKCcuLi9wYXJ0L25vblRlcm1pbmFsL2Nob2ljZU9mUGFydHMnKSxcbiAgICAgIE5vblRlcm1pbmFsTm9kZSA9IHJlcXVpcmUoJy4uLy4uL2NvbW1vbi9ub2RlL25vblRlcm1pbmFsJyk7XG5cbmNvbnN0IHsgYXJyYXkgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgZmlyc3QsIGxhc3QgfSA9IGFycmF5O1xuXG5jbGFzcyBQYXJ0Tm9kZSBleHRlbmRzIE5vblRlcm1pbmFsTm9kZSB7XG4gIGdlbmVyYXRlUGFydChub1doaXRlc3BhY2UpIHtcbiAgICBsZXQgcGFydCA9IG51bGw7XG5cbiAgICBjb25zdCBjaGlsZE5vZGVzID0gdGhpcy5nZXRDaGlsZE5vZGVzKCksXG4gICAgICAgICAgbm9kZXMgPSBjaGlsZE5vZGVzLnNsaWNlKCk7IC8vL1xuXG4gICAgcmVtb3ZlTGFzdE51bGxpZmllZE5vZGVGcm9tTm9kZXMobm9kZXMpO1xuXG4gICAgY29uc3QgcXVhbnRpZmllcnMgPSBxdWFudGlmaWVyc0Zyb21Ob2Rlcyhub2Rlcyk7XG5cbiAgICBub1doaXRlc3BhY2UgPSBub1doaXRlc3BhY2VGcm9tTm9kZXMobm9kZXMsIG5vV2hpdGVzcGFjZSk7XG5cbiAgICBjb25zdCBub2Rlc0xlbmd0aCA9IG5vZGVzLmxlbmd0aDtcbiAgICBcbiAgICBpZiAobm9kZXNMZW5ndGggPT09IDEpIHtcbiAgICAgIGNvbnN0IGZpcnN0Tm9kZSA9IGZpcnN0KG5vZGVzKSxcbiAgICAgICAgICAgIG5vZGUgPSBmaXJzdE5vZGU7ICAvLy9cblxuICAgICAgcGFydCA9IHBhcnRGcm9tTm9kZShub2RlLCBub1doaXRlc3BhY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJ0ID0gcGFydEZyb21Ob2Rlcyhub2Rlcyk7XG4gICAgfVxuICAgIFxuICAgIHBhcnQgPSBwYXJ0RnJvbVBhcnRBbmRRdWFudGlmaWVycyhwYXJ0LCBxdWFudGlmaWVycyk7XG5cbiAgICByZXR1cm4gcGFydDtcbiAgfVxuICBcbiAgc3RhdGljIGZyb21Ob2Rlc0FuZFJ1bGVOYW1lKG5vZGVzLCBydWxlTmFtZSkgeyByZXR1cm4gTm9uVGVybWluYWxOb2RlLmZyb21Ob2Rlc0FuZFJ1bGVOYW1lKFBhcnROb2RlLCBub2RlcywgcnVsZU5hbWUpOyB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUGFydE5vZGU7XG5cbmZ1bmN0aW9uIHJlbW92ZUxhc3ROdWxsaWZpZWROb2RlRnJvbU5vZGVzKG5vZGVzKSB7XG4gIGxldCBsYXN0Tm9kZU51bGxpZmllZE5vZGUgPSBmYWxzZTtcblxuICBjb25zdCBsYXN0Tm9kZSA9IGxhc3Qobm9kZXMpLFxuICAgICAgICBsYXN0Tm9kZVRlcm1pbmFsTm9kZSA9IGxhc3ROb2RlLmlzVGVybWluYWxOb2RlKCksXG4gICAgICAgIGxhc3ROb2RlTm9uVGVybWluYWxOb2RlID0gIWxhc3ROb2RlVGVybWluYWxOb2RlO1xuXG4gIGlmIChsYXN0Tm9kZU5vblRlcm1pbmFsTm9kZSkge1xuICAgIGNvbnN0IG5vblRlcm1pbmFsTm9kZSA9IGxhc3ROb2RlLCAvLy9cbiAgICAgICAgICBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKSxcbiAgICAgICAgICBjaGlsZE5vZGVzTGVuZ3RoID0gY2hpbGROb2Rlcy5sZW5ndGg7XG5cbiAgICBpZiAoY2hpbGROb2Rlc0xlbmd0aCA9PT0gMSkge1xuICAgICAgY29uc3QgZmlyc3RDaGlsZE5vZGUgPSBmaXJzdChjaGlsZE5vZGVzKSxcbiAgICAgICAgICAgIGZpcnN0Q2hpbGROb2RlVGVybWluYWxOb2RlID0gZmlyc3RDaGlsZE5vZGUuaXNUZXJtaW5hbE5vZGUoKTtcblxuICAgICAgaWYgKGZpcnN0Q2hpbGROb2RlVGVybWluYWxOb2RlKSB7XG4gICAgICAgIGNvbnN0IGZpcnN0Q2hpbGROb2RlRXBzaWxvbk5vZGUgPSBmaXJzdENoaWxkTm9kZS5pc0Vwc2lsb25Ob2RlKCksXG4gICAgICAgICAgICAgIGxhc3ROb2RlTnVsbGlmaWVkTm9kZSA9IGZpcnN0Q2hpbGROb2RlRXBzaWxvbk5vZGU7ICAvLy9cblxuICAgICAgICBpZiAobGFzdE5vZGVOdWxsaWZpZWROb2RlKSB7XG4gICAgICAgICAgbm9kZXMucG9wKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gbGFzdE5vZGVOdWxsaWZpZWROb2RlO1xufVxuXG5mdW5jdGlvbiBub1doaXRlc3BhY2VGcm9tTm9kZXMobm9kZXMsIG5vV2hpdGVzcGFjZSkge1xuICBjb25zdCBmaXJzdE5vZGUgPSBmaXJzdChub2RlcyksXG4gICAgICAgIGZpcnN0Tm9kZU5vV2hpdGVzcGFjZU5vZGUgPSBibmZVdGlsaXRpZXMuaXNOb2RlTm9XaGl0ZXNwYWNlTm9kZShmaXJzdE5vZGUpO1xuXG4gIGlmIChmaXJzdE5vZGVOb1doaXRlc3BhY2VOb2RlKSB7XG4gICAgbm9XaGl0ZXNwYWNlID0gdHJ1ZTtcblxuICAgIGNvbnN0IGJlZ2luID0gMCxcbiAgICAgICAgICBkZWxldGVDb3VudCA9IDE7XG5cbiAgICBub2Rlcy5zcGxpY2UoYmVnaW4sIGRlbGV0ZUNvdW50KTtcbiAgfVxuXG4gIHJldHVybiBub1doaXRlc3BhY2U7XG59XG5cbmZ1bmN0aW9uIHF1YW50aWZpZXJzRnJvbU5vZGVzKG5vZGVzKSB7XG4gIGxldCAgcXVhbnRpZmllcnMgPSBbXTtcblxuICBjb25zdCBsYXN0Tm9kZSA9IGxhc3Qobm9kZXMpLFxuICAgICAgICBsYXN0Tm9kZVF1YW50aWZpZXJzTm9kZSA9IGJuZlV0aWxpdGllcy5pc05vZGVRdWFudGlmaWVyc05vZGUobGFzdE5vZGUpO1xuXG4gIGlmIChsYXN0Tm9kZVF1YW50aWZpZXJzTm9kZSkge1xuICAgIGNvbnN0IHF1YW50aWZpZXJzTm9kZSA9IGxhc3ROb2RlOyAgLy8vXG5cbiAgICBxdWFudGlmaWVycyA9IGJuZlV0aWxpdGllcy5xdWFudGlmaWVyc0Zyb21RdWFudGlmaWVyc05vZGUocXVhbnRpZmllcnNOb2RlKTtcblxuICAgIGNvbnN0IGJlZ2luID0gLTEsXG4gICAgICAgICAgZGVsZXRlQ291bnQgPSAxO1xuXG4gICAgbm9kZXMuc3BsaWNlKGJlZ2luLCBkZWxldGVDb3VudCk7XG4gIH1cblxuICByZXR1cm4gcXVhbnRpZmllcnM7XG59XG5cbmZ1bmN0aW9uIHBhcnRGcm9tTm9kZShub2RlLCBub1doaXRlc3BhY2UpIHtcbiAgY29uc3QgcGFydCA9IG5vZGUuZ2VuZXJhdGVQYXJ0KG5vV2hpdGVzcGFjZSk7XG5cbiAgcmV0dXJuIHBhcnQ7XG59XG5cbmZ1bmN0aW9uIHBhcnRGcm9tTm9kZXMobm9kZXMpIHtcbiAgbGV0IHBhcnQgPSBudWxsO1xuXG4gIGNvbnN0IGNob2ljZU9mUGFydHNQYXJ0ID0gQ2hvaWNlT2ZQYXJ0c1BhcnQuZnJvbU5vZGVzKG5vZGVzKTtcblxuICBpZiAoY2hvaWNlT2ZQYXJ0c1BhcnQgIT09IG51bGwpIHtcbiAgICBwYXJ0ID0gY2hvaWNlT2ZQYXJ0c1BhcnQ7IC8vL1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGdyb3VwT2ZQYXJ0c1BhcnQgPSBHcm91cE9mUGFydHNQYXJ0LmZyb21Ob2Rlcyhub2Rlcyk7XG5cbiAgICBpZiAoZ3JvdXBPZlBhcnRzUGFydCAhPT0gbnVsbCkge1xuICAgICAgcGFydCA9IGdyb3VwT2ZQYXJ0c1BhcnQ7ICAvLy9cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcGFydDtcbn1cblxuZnVuY3Rpb24gcGFydEZyb21QYXJ0QW5kUXVhbnRpZmllcnMocGFydCwgcXVhbnRpZmllcnMpIHtcbiAgY29uc3QgcXVhbnRpZmllcnNMZW5ndGggPSBxdWFudGlmaWVycy5sZW5ndGg7XG5cbiAgaWYgKHF1YW50aWZpZXJzTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHF1YW50aWZpZXIgPSBxdWFudGlmaWVycy5zaGlmdCgpLFxuICAgICAgICAgIHNlcXVlbmNlT2ZQYXJ0c1BhcnQgPSBzZXF1ZW5jZU9mUGFydHNQYXJ0RnJvbVBhcnRBbmRRdWFudGlmaWVyKHBhcnQsIHF1YW50aWZpZXIpO1xuXG4gICAgcGFydCA9IHNlcXVlbmNlT2ZQYXJ0c1BhcnQ7IC8vL1xuXG4gICAgcGFydCA9IHBhcnRGcm9tUGFydEFuZFF1YW50aWZpZXJzKHBhcnQsIHF1YW50aWZpZXJzKTtcbiAgfVxuXG4gIHJldHVybiBwYXJ0O1xufVxuXG5mdW5jdGlvbiBzZXF1ZW5jZU9mUGFydHNQYXJ0RnJvbVBhcnRBbmRRdWFudGlmaWVyKHBhcnQsIHF1YW50aWZpZXIpIHtcbiAgbGV0IHNlcXVlbmNlT2ZQYXJ0c1BhcnQ7XG5cbiAgc3dpdGNoIChxdWFudGlmaWVyKSB7XG4gICAgY2FzZSAnPyc6XG4gICAgICBjb25zdCBvcHRpb25hbFBhcnRQYXJ0ID0gbmV3IE9wdGlvbmFsUGFydFBhcnQocGFydCk7XG5cbiAgICAgIHNlcXVlbmNlT2ZQYXJ0c1BhcnQgPSBvcHRpb25hbFBhcnRQYXJ0OyAvLy9cbiAgICAgIGJyZWFrO1xuXG4gICAgY2FzZSAnKic6XG4gICAgICBjb25zdCB6ZXJvT3JNb3JlUGFydHNQYXJ0ID0gbmV3IFplcm9Pck1vcmVQYXJ0c1BhcnQocGFydCk7XG5cbiAgICAgIHNlcXVlbmNlT2ZQYXJ0c1BhcnQgPSB6ZXJvT3JNb3JlUGFydHNQYXJ0OyAgLy8vXG4gICAgICBicmVhaztcblxuICAgIGNhc2UgJysnOlxuICAgICAgY29uc3Qgb25lT3JNb3JlUGFydHNQYXJ0ID0gbmV3IE9uZU9yTW9yZVBhcnRzUGFydChwYXJ0KTtcblxuICAgICAgc2VxdWVuY2VPZlBhcnRzUGFydCA9IG9uZU9yTW9yZVBhcnRzUGFydDsgLy8vXG4gICAgICBicmVhaztcbiAgfVxuXG4gIHJldHVybiBzZXF1ZW5jZU9mUGFydHNQYXJ0O1xufVxuIl19