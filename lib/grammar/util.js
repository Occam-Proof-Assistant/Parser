'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Graph = require('./graph'),
    parserUtil = require('../util/parser'),
    UnitRuleProduction = require('./production/unitRule'),
    UnitRulesProduction = require('./production/unitRules'),
    NonUnitRulesProduction = require('./production/nonUnitRules'),
    RightRecursiveProduction = require('./production/rightRecursive'),
    NonLeftRecursiveProduction = require('./production/nonLeftRecursive'),
    NonImplicitlyLeftRecursiveProduction = require('./production/nonImplicitlyLeftRecursive');

var grammarUtil = function () {
  function grammarUtil() {
    _classCallCheck(this, grammarUtil);
  }

  _createClass(grammarUtil, null, [{
    key: 'eliminateCycles',
    value: function eliminateCycles(productions) {
      var unitRulesProductions = unitRulesProductionsFromProductions(productions),
          graph = graphFromUnitRulesProductions(unitRulesProductions),
          nonCyclicProductions = nonCyclicProductionsFromGraph(graph, productions);

      productions = nonCyclicProductions; ///

      return productions;
    }
  }, {
    key: 'eliminateLeftRecursion',
    value: function eliminateLeftRecursion(productions) {
      var nonLeftRecursiveProductions = [],
          rightRecursiveProductions = [];

      productions.forEach(function (production, index) {
        var begin = 0,
            end = index,
            ///
        previousNonLeftRecursiveProductions = nonLeftRecursiveProductions.slice(begin, end),
            previousProductions = previousNonLeftRecursiveProductions,
            ///
        productionImplicitlyLeftRecursive = production.isImplicitlyLeftRecursive(previousProductions);

        if (productionImplicitlyLeftRecursive) {
          var nonImplicitlyLeftRecursiveProduction = NonImplicitlyLeftRecursiveProduction.fromProductionAndPreviousProductions(production, previousProductions);

          production = nonImplicitlyLeftRecursiveProduction; ///
        }

        var productionLeftRecursive = production.isLeftRecursive();

        if (productionLeftRecursive) {
          var nonLeftRecursiveProduction = NonLeftRecursiveProduction.fromProduction(production),
              rightRecursiveProduction = RightRecursiveProduction.fromProduction(production);

          nonLeftRecursiveProductions.push(nonLeftRecursiveProduction);

          rightRecursiveProductions.push(rightRecursiveProduction);
        } else {
          var _nonLeftRecursiveProduction = production; ///

          nonLeftRecursiveProductions.push(_nonLeftRecursiveProduction);
        }
      });

      productions = [].concat(nonLeftRecursiveProductions).concat(rightRecursiveProductions);

      return productions;
    }
  }]);

  return grammarUtil;
}();

module.exports = grammarUtil;

function unitRulesProductionsFromProductions(productions) {
  var unitRulesProductions = productions.reduce(function (unitRulesProductions, production) {
    var unitRulesProduction = UnitRulesProduction.fromProduction(production);

    if (unitRulesProduction !== null) {
      unitRulesProductions.push(unitRulesProduction);
    }

    return unitRulesProductions;
  }, []);

  return unitRulesProductions;
}

function graphFromUnitRulesProductions(unitRulesProductions) {
  var graph = new Graph();

  unitRulesProductions.forEach(function (unitRulesProduction) {
    var productionName = unitRulesProduction.getName(),
        productionNames = unitRulesProduction.getProductionNames(),
        vertexName = productionName,
        ///
    descendantVertexNames = productionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function nonCyclicProductionsFromGraph(graph, productions) {
  var components = graph.getComponents(),
      nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      var nonCyclicComponent = component,
          ///
      nonCyclicComponentNonCyclicProduction = nonCyclicProductionFromNonCyclicComponent(nonCyclicComponent, productions);

      nonCyclicProductions.push(nonCyclicComponentNonCyclicProduction);
    } else {
      var cyclicComponent = component,
          ///
      cyclicComponentNonCyclicProductions = nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions);

      nonCyclicProductions = nonCyclicProductions.concat(cyclicComponentNonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function nonCyclicProductionFromNonCyclicComponent(nonCyclicComponent, productions) {
  var firstVertex = nonCyclicComponent.getFirstVertex(),
      firstVertexName = firstVertex.getName(),
      nonCyclicProductionName = firstVertexName,
      ///
  nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, productions);

  return nonCyclicProduction;
}

function nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions) {
  productions = productionsFromCyclicComponent(cyclicComponent, productions); ///

  var unitRuleProductions = unitRuleProductionsFromProductions(productions),
      nonUnitRulesProductions = nonUnitRulesProductionsFromProductions(productions);

  debugger;
}

function productionsFromCyclicComponent(cyclicComponent, productions) {
  productions = cyclicComponent.mapVertices(function (vertex) {
    var vertexName = vertex.getName(),
        productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions);

    return production;
  });

  return productions;
}

function unitRuleProductionsFromProductions(productions) {
  var unitRuleProductions = productions.reduce(function (unitRuleProductions, production) {
    var name = production.getName(),
        unitRulesProduction = UnitRulesProduction.fromProduction(production),
        unitRulesProductionUnitRuleProductions = unitRulesProduction.mapUnitRules(function (unitRule) {
      var unitRulesProductionUnitRuleProduction = UnitRuleProduction.fromNameAndUnitRule(name, unitRule);

      return unitRulesProductionUnitRuleProduction;
    });

    unitRuleProductions = unitRuleProductions.concat(unitRulesProductionUnitRuleProductions);

    return unitRuleProductions;
  }, []);

  return unitRuleProductions;
}

function nonUnitRulesProductionsFromProductions(productions) {
  var nonUnitProductions = productions.map(function (production) {
    var nonUnitProduction = NonUnitRulesProduction.fromProduction(production);

    return nonUnitProduction;
  });

  return nonUnitProductions;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL3V0aWwuanMiXSwibmFtZXMiOlsiR3JhcGgiLCJyZXF1aXJlIiwicGFyc2VyVXRpbCIsIlVuaXRSdWxlUHJvZHVjdGlvbiIsIlVuaXRSdWxlc1Byb2R1Y3Rpb24iLCJOb25Vbml0UnVsZXNQcm9kdWN0aW9uIiwiUmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uIiwiTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24iLCJOb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24iLCJncmFtbWFyVXRpbCIsInByb2R1Y3Rpb25zIiwidW5pdFJ1bGVzUHJvZHVjdGlvbnMiLCJ1bml0UnVsZXNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyIsImdyYXBoIiwiZ3JhcGhGcm9tVW5pdFJ1bGVzUHJvZHVjdGlvbnMiLCJub25DeWNsaWNQcm9kdWN0aW9ucyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUdyYXBoIiwibm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zIiwicmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9ucyIsImZvckVhY2giLCJwcm9kdWN0aW9uIiwiaW5kZXgiLCJiZWdpbiIsImVuZCIsInByZXZpb3VzTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zIiwic2xpY2UiLCJwcmV2aW91c1Byb2R1Y3Rpb25zIiwicHJvZHVjdGlvbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlIiwiaXNJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZSIsIm5vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uQW5kUHJldmlvdXNQcm9kdWN0aW9ucyIsInByb2R1Y3Rpb25MZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwibm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24iLCJmcm9tUHJvZHVjdGlvbiIsInJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbiIsInB1c2giLCJjb25jYXQiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVkdWNlIiwidW5pdFJ1bGVzUHJvZHVjdGlvbiIsInByb2R1Y3Rpb25OYW1lIiwiZ2V0TmFtZSIsInByb2R1Y3Rpb25OYW1lcyIsImdldFByb2R1Y3Rpb25OYW1lcyIsInZlcnRleE5hbWUiLCJkZXNjZW5kYW50VmVydGV4TmFtZXMiLCJhZGRWZXJ0ZXgiLCJjb21wb25lbnRzIiwiZ2V0Q29tcG9uZW50cyIsImNvbXBvbmVudCIsImNvbXBvbmVudE5vbkN5Y2xpYyIsImlzTm9uQ3ljbGljIiwibm9uQ3ljbGljQ29tcG9uZW50Iiwibm9uQ3ljbGljQ29tcG9uZW50Tm9uQ3ljbGljUHJvZHVjdGlvbiIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tTm9uQ3ljbGljQ29tcG9uZW50IiwiY3ljbGljQ29tcG9uZW50IiwiY3ljbGljQ29tcG9uZW50Tm9uQ3ljbGljUHJvZHVjdGlvbnMiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQiLCJmaXJzdFZlcnRleCIsImdldEZpcnN0VmVydGV4IiwiZmlyc3RWZXJ0ZXhOYW1lIiwibm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUiLCJub25DeWNsaWNQcm9kdWN0aW9uIiwiZmluZFByb2R1Y3Rpb24iLCJwcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQiLCJ1bml0UnVsZVByb2R1Y3Rpb25zIiwidW5pdFJ1bGVQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyIsIm5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zIiwibm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMiLCJtYXBWZXJ0aWNlcyIsInZlcnRleCIsIm5hbWUiLCJ1bml0UnVsZXNQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9ucyIsIm1hcFVuaXRSdWxlcyIsInVuaXRSdWxlIiwidW5pdFJ1bGVzUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbiIsImZyb21OYW1lQW5kVW5pdFJ1bGUiLCJub25Vbml0UHJvZHVjdGlvbnMiLCJtYXAiLCJub25Vbml0UHJv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QnJDLG9CQUFvQjhCLGNBQXBCLENBQW1DZCxVQUFuQyxDQUQ1QjtBQUFBLFFBRU1zRCx5Q0FBeUNqQyxvQkFBb0JrQyxZQUFwQixDQUFpQyxVQUFTQyxRQUFULEVBQW1CO0FBQzNGLFVBQU1DLHdDQUF3QzFFLG1CQUFtQjJFLG1CQUFuQixDQUF1Q0wsSUFBdkMsRUFBNkNHLFFBQTdDLENBQTlDOztBQUVBLGFBQU9DLHFDQUFQO0FBQ0QsS0FKd0MsQ0FGL0M7O0FBUUFWLDBCQUFzQkEsb0JBQW9COUIsTUFBcEIsQ0FBMkJxQyxzQ0FBM0IsQ0FBdEI7O0FBRUEsV0FBT1AsbUJBQVA7QUFDRCxHQVoyQixFQVl6QixFQVp5QixDQUE1Qjs7QUFjQSxTQUFPQSxtQkFBUDtBQUNEOztBQUVELFNBQVNHLHNDQUFULENBQWdENUQsV0FBaEQsRUFBNkQ7QUFDM0QsTUFBTXFFLHFCQUFxQnJFLFlBQVlzRSxHQUFaLENBQWdCLFVBQVM1RCxVQUFULEVBQXFCO0FBQzlELFFBQU02RCxvQkFBb0I1RSx1QkFBdUI2QixjQUF2QixDQUFzQ2QsVUFBdEMsQ0FBMUI7O0FBRUEsV0FBTzZELGlCQUFQO0FBQ0QsR0FKMEIsQ0FBM0I7O0FBTUEsU0FBT0Ysa0JBQVA7QUFDRCIsImZpbGUiOiJ1dGlsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBHcmFwaCA9IHJlcXVpcmUoJy4vZ3JhcGgnKSxcbiAgICAgIHBhcnNlclV0aWwgPSByZXF1aXJlKCcuLi91dGlsL3BhcnNlcicpLFxuICAgICAgVW5pdFJ1bGVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlJyksXG4gICAgICBVbml0UnVsZXNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlcycpLFxuICAgICAgTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9ub25Vbml0UnVsZXMnKSxcbiAgICAgIFJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9yaWdodFJlY3Vyc2l2ZScpLFxuICAgICAgTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vbm9uTGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgTm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL25vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlJyk7XG5cbmNsYXNzIGdyYW1tYXJVdGlsIHtcbiAgc3RhdGljIGVsaW1pbmF0ZUN5Y2xlcyhwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25zID0gdW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGdyYXBoID0gZ3JhcGhGcm9tVW5pdFJ1bGVzUHJvZHVjdGlvbnModW5pdFJ1bGVzUHJvZHVjdGlvbnMpLFxuICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tR3JhcGgoZ3JhcGgsIHByb2R1Y3Rpb25zKTtcblxuICAgIHByb2R1Y3Rpb25zID0gbm9uQ3ljbGljUHJvZHVjdGlvbnM7IC8vL1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25zO1xuICB9XG5cbiAgc3RhdGljIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocHJvZHVjdGlvbnMpIHtcbiAgICBjb25zdCBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMgPSBbXSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb25zID0gW107XG5cbiAgICBwcm9kdWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHByb2R1Y3Rpb24sIGluZGV4KSB7XG4gICAgICBjb25zdCBiZWdpbiA9IDAsXG4gICAgICAgICAgICBlbmQgPSBpbmRleCwgIC8vL1xuICAgICAgICAgICAgcHJldmlvdXNOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMgPSBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMuc2xpY2UoYmVnaW4sIGVuZCksXG4gICAgICAgICAgICBwcmV2aW91c1Byb2R1Y3Rpb25zID0gcHJldmlvdXNOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMsICAvLy9cbiAgICAgICAgICAgIHByb2R1Y3Rpb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZSA9IHByb2R1Y3Rpb24uaXNJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZShwcmV2aW91c1Byb2R1Y3Rpb25zKTtcblxuICAgICAgaWYgKHByb2R1Y3Rpb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBub25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSBOb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb25BbmRQcmV2aW91c1Byb2R1Y3Rpb25zKHByb2R1Y3Rpb24sIHByZXZpb3VzUHJvZHVjdGlvbnMpO1xuXG4gICAgICAgIHByb2R1Y3Rpb24gPSBub25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb247ICAvLy9cbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvZHVjdGlvbkxlZnRSZWN1cnNpdmUgPSBwcm9kdWN0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgICBpZiAocHJvZHVjdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgY29uc3Qgbm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSBOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKSxcbiAgICAgICAgICAgICAgcmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uID0gUmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuXG4gICAgICAgIG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucy5wdXNoKG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uKTtcblxuICAgICAgICByaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb25zLnB1c2gocmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcHJvZHVjdGlvbjsgIC8vL1xuXG4gICAgICAgIG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucy5wdXNoKG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHByb2R1Y3Rpb25zID0gW10uY29uY2F0KG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucykuY29uY2F0KHJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25zO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZ3JhbW1hclV0aWw7XG5cbmZ1bmN0aW9uIHVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRSdWxlc1Byb2R1Y3Rpb25zLCBwcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgdW5pdFJ1bGVzUHJvZHVjdGlvbiA9IFVuaXRSdWxlc1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG5cbiAgICBpZiAodW5pdFJ1bGVzUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgdW5pdFJ1bGVzUHJvZHVjdGlvbnMucHVzaCh1bml0UnVsZXNQcm9kdWN0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5pdFJ1bGVzUHJvZHVjdGlvbnM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gdW5pdFJ1bGVzUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGdyYXBoRnJvbVVuaXRSdWxlc1Byb2R1Y3Rpb25zKHVuaXRSdWxlc1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGdyYXBoID0gbmV3IEdyYXBoKCk7XG5cbiAgdW5pdFJ1bGVzUHJvZHVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbih1bml0UnVsZXNQcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgcHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZXNQcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICBwcm9kdWN0aW9uTmFtZXMgPSB1bml0UnVsZXNQcm9kdWN0aW9uLmdldFByb2R1Y3Rpb25OYW1lcygpLFxuICAgICAgICAgIHZlcnRleE5hbWUgPSBwcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyA9IHByb2R1Y3Rpb25OYW1lczsgLy8vXG5cbiAgICBncmFwaC5hZGRWZXJ0ZXgodmVydGV4TmFtZSwgZGVzY2VuZGFudFZlcnRleE5hbWVzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIGdyYXBoO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21HcmFwaChncmFwaCwgcHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgY29tcG9uZW50cyA9IGdyYXBoLmdldENvbXBvbmVudHMoKSxcbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnMgPSBjb21wb25lbnRzLnJlZHVjZShmdW5jdGlvbihub25DeWNsaWNQcm9kdWN0aW9ucywgY29tcG9uZW50KSB7XG4gICAgICAgICAgY29uc3QgY29tcG9uZW50Tm9uQ3ljbGljID0gY29tcG9uZW50LmlzTm9uQ3ljbGljKCk7XG5cbiAgICAgICAgICBpZiAoY29tcG9uZW50Tm9uQ3ljbGljKSB7XG4gICAgICAgICAgICBjb25zdCBub25DeWNsaWNDb21wb25lbnQgPSBjb21wb25lbnQsIC8vL1xuICAgICAgICAgICAgICAgICAgbm9uQ3ljbGljQ29tcG9uZW50Tm9uQ3ljbGljUHJvZHVjdGlvbiA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tTm9uQ3ljbGljQ29tcG9uZW50KG5vbkN5Y2xpY0NvbXBvbmVudCwgcHJvZHVjdGlvbnMpO1xuXG4gICAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9ucy5wdXNoKG5vbkN5Y2xpY0NvbXBvbmVudE5vbkN5Y2xpY1Byb2R1Y3Rpb24pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBjeWNsaWNDb21wb25lbnQgPSBjb21wb25lbnQsICAvLy9cbiAgICAgICAgICAgICAgICAgIGN5Y2xpY0NvbXBvbmVudE5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ3ljbGljQ29tcG9uZW50KGN5Y2xpY0NvbXBvbmVudCwgcHJvZHVjdGlvbnMpO1xuXG4gICAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9ucyA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLmNvbmNhdChjeWNsaWNDb21wb25lbnROb25DeWNsaWNQcm9kdWN0aW9ucyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zO1xuICAgICAgICB9LCBbXSk7XG5cbiAgcmV0dXJuIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uRnJvbU5vbkN5Y2xpY0NvbXBvbmVudChub25DeWNsaWNDb21wb25lbnQsIHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0VmVydGV4ID0gbm9uQ3ljbGljQ29tcG9uZW50LmdldEZpcnN0VmVydGV4KCksXG4gICAgICAgIGZpcnN0VmVydGV4TmFtZSA9IGZpcnN0VmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUgPSBmaXJzdFZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTtcblxuICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbjtcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ3ljbGljQ29tcG9uZW50KGN5Y2xpY0NvbXBvbmVudCwgcHJvZHVjdGlvbnMpIHtcbiAgcHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQoY3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucyk7IC8vL1xuXG4gIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbnMgPSB1bml0UnVsZVByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgbm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMgPSBub25Vbml0UnVsZXNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucyk7XG5cbiAgZGVidWdnZXJcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbnNGcm9tQ3ljbGljQ29tcG9uZW50KGN5Y2xpY0NvbXBvbmVudCwgcHJvZHVjdGlvbnMpIHtcbiAgcHJvZHVjdGlvbnMgPSBjeWNsaWNDb21wb25lbnQubWFwVmVydGljZXMoZnVuY3Rpb24odmVydGV4KSB7XG4gICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCksXG4gICAgICAgICAgcHJvZHVjdGlvbk5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgcHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24ocHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTtcblxuICAgIHJldHVybiBwcm9kdWN0aW9uO1xuICB9KTtcblxuICByZXR1cm4gcHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIHVuaXRSdWxlUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLnJlZHVjZShmdW5jdGlvbih1bml0UnVsZVByb2R1Y3Rpb25zLCBwcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgbmFtZSA9IHByb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIHVuaXRSdWxlc1Byb2R1Y3Rpb24gPSBVbml0UnVsZXNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pLFxuICAgICAgICAgIHVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25zID0gdW5pdFJ1bGVzUHJvZHVjdGlvbi5tYXBVbml0UnVsZXMoZnVuY3Rpb24odW5pdFJ1bGUpIHtcbiAgICAgICAgICAgIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb24gPSBVbml0UnVsZVByb2R1Y3Rpb24uZnJvbU5hbWVBbmRVbml0UnVsZShuYW1lLCB1bml0UnVsZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB1bml0UnVsZXNQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uO1xuICAgICAgICAgIH0pO1xuXG4gICAgdW5pdFJ1bGVQcm9kdWN0aW9ucyA9IHVuaXRSdWxlUHJvZHVjdGlvbnMuY29uY2F0KHVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25zKTtcblxuICAgIHJldHVybiB1bml0UnVsZVByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IG5vblVuaXRQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLm1hcChmdW5jdGlvbihwcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uVW5pdFByb2R1Y3Rpb24gPSBOb25Vbml0UnVsZXNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuICAgIFxuICAgIHJldHVybiBub25Vbml0UHJvZHVjdGlvbjtcbiAgfSk7XG4gIFxuICByZXR1cm4gbm9uVW5pdFByb2R1Y3Rpb25zO1xufVxuXG4iXX0=