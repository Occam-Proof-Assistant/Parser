'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Graph = require('./graph'),
    parserUtil = require('../util/parser'),
    NonUnitProduction = require('./production/nonUnit'),
    UnitRulesProduction = require('./production/unitRules'),
    RightRecursiveProduction = require('./production/rightRecursive'),
    NonLeftRecursiveProduction = require('./production/nonLeftRecursive'),
    NonImplicitlyLeftRecursiveProduction = require('./production/nonImplicitlyLeftRecursive');

var grammarUtil = function () {
  function grammarUtil() {
    _classCallCheck(this, grammarUtil);
  }

  _createClass(grammarUtil, null, [{
    key: 'eliminateCycles',
    value: function eliminateCycles(productions) {
      var unitRulesProductions = unitRulesProductionsFromProductions(productions),
          graph = graphFromUnitRulesProductions(unitRulesProductions),
          components = graph.getComponents();

      productions = productionsFromComponents(components, productions);

      return productions;
    }
  }, {
    key: 'eliminateLeftRecursion',
    value: function eliminateLeftRecursion(productions) {
      var nonLeftRecursiveProductions = [],
          rightRecursiveProductions = [];

      productions.forEach(function (production, index) {
        var begin = 0,
            end = index,
            ///
        previousNonLeftRecursiveProductions = nonLeftRecursiveProductions.slice(begin, end),
            previousProductions = previousNonLeftRecursiveProductions,
            ///
        productionImplicitlyLeftRecursive = production.isImplicitlyLeftRecursive(previousProductions);

        if (productionImplicitlyLeftRecursive) {
          var nonImplicitlyLeftRecursiveProduction = NonImplicitlyLeftRecursiveProduction.fromProductionAndPreviousProductions(production, previousProductions);

          production = nonImplicitlyLeftRecursiveProduction; ///
        }

        var productionLeftRecursive = production.isLeftRecursive();

        if (productionLeftRecursive) {
          var nonLeftRecursiveProduction = NonLeftRecursiveProduction.fromProduction(production),
              rightRecursiveProduction = RightRecursiveProduction.fromProduction(production);

          nonLeftRecursiveProductions.push(nonLeftRecursiveProduction);

          rightRecursiveProductions.push(rightRecursiveProduction);
        } else {
          var _nonLeftRecursiveProduction = production; ///

          nonLeftRecursiveProductions.push(_nonLeftRecursiveProduction);
        }
      });

      productions = [].concat(nonLeftRecursiveProductions).concat(rightRecursiveProductions);

      return productions;
    }
  }]);

  return grammarUtil;
}();

module.exports = grammarUtil;

function unitRulesProductionsFromProductions(productions) {
  var unitRulesProductions = productions.reduce(function (unitRulesProductions, production) {
    var unitRulesProduction = UnitRulesProduction.fromProduction(production);

    if (unitRulesProduction !== null) {
      unitRulesProductions.push(unitRulesProduction);
    }

    return unitRulesProductions;
  }, []);

  return unitRulesProductions;
}

function graphFromUnitRulesProductions(unitRulesProductions) {
  var graph = new Graph();

  unitRulesProductions.forEach(function (unitRulesProduction) {
    var productionName = unitRulesProduction.getName(),
        productionNames = unitRulesProduction.getProductionNames(),
        vertexName = productionName,
        ///
    descendantVertexNames = productionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function productionsFromComponents(components, productions) {
  var componentProductions = components.reduce(function (componentProductions, component) {
    var componentCyclic = component.isCyclic();

    if (componentCyclic) {
      var cyclicComponent = component,
          ///
      nonCyclicProductions = nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions);

      componentProductions = componentProductions.concat(nonCyclicProductions);
    } else {
      var nonCyclicComponent = component,
          ///
      production = productionFromNonCyclicComponent(nonCyclicComponent, productions);

      componentProductions.push(production);
    }

    return componentProductions;
  }, []);

  productions = componentProductions; ///

  return productions;
}

function nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions) {
  var cyclicProductions = cyclicComponent.mapVertex(function (vertex) {
    var vertexName = vertex.getName(),
        cyclicProductionName = vertexName,
        ///
    production = parserUtil.findProduction(cyclicProductionName, productions),
        cyclicProduction = UnitRulesProduction.fromProduction(production);

    return cyclicProduction;
  }),
      unitProductions = unitProductionsFromCyclicProductions(cyclicProductions),
      nonUnitProductions = nonUnitProductionsFromCyclicProductions(cyclicProductions);

  debugger;
}

function unitProductionsFromCyclicProductions(cyclicProductions) {
  var unitProductions = cyclicProductions.reduce(function (unitProductions, cyclicProduction) {
    var cyclicProductionEdges = cyclicProduction.getUnitProductions();

    unitProductions = unitProductions.concat(cyclicProductionEdges);

    return unitProductions;
  }, []);

  return unitProductions;
}

function nonUnitProductionsFromCyclicProductions(cyclicProductions) {
  var nonUnitProductions = cyclicProductions.map(function (cyclicProduction) {
    var nonUnitProduction = NonUnitProduction.fromCyclicProduction(cyclicProduction);

    return nonUnitProduction;
  });

  return nonUnitProductions;
}

function productionFromNonCyclicComponent(nonCyclicComponent, productions) {
  var nonCyclicComponentFirstVertex = nonCyclicComponent.getFirstVertex(),
      nonCyclicComponentFirstVertexName = nonCyclicComponentFirstVertex.getName(),
      productionName = nonCyclicComponentFirstVertexName,
      ///
  production = parserUtil.findProduction(productionName, productions);

  return production;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL3V0aWwuanMiXSwibmFtZXMiOlsiR3JhcGgiLCJyZXF1aXJlIiwicGFyc2VyVXRpbCIsIk5vblVuaXRQcm9kdWN0aW9uIiwiVW5pdFJ1bGVzUHJvZHVjdGlvbiIsIlJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbiIsIk5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uIiwiTm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uIiwiZ3JhbW1hclV0aWwiLCJwcm9kdWN0aW9ucyIsInVuaXRSdWxlc1Byb2R1Y3Rpb25zIiwidW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMiLCJncmFwaCIsImdyYXBoRnJvbVVuaXRSdWxlc1Byb2R1Y3Rpb25zIiwiY29tcG9uZW50cyIsImdldENvbXBvbmVudHMiLCJwcm9kdWN0aW9uc0Zyb21Db21wb25lbnRzIiwibm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zIiwicmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9ucyIsImZvckVhY2giLCJwcm9kdWN0aW9uIiwiaW5kZXgiLCJiZWdpbiIsImVuZCIsInByZXZpb3VzTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zIiwic2xpY2UiLCJwcmV2aW91c1Byb2R1Y3Rpb25zIiwicHJvZHVjdGlvbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlIiwiaXNJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZSIsIm5vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uQW5kUHJldmlvdXNQcm9kdWN0aW9ucyIsInByb2R1Y3Rpb25MZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwibm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24iLCJmcm9tUHJvZHVjdGlvbiIsInJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbiIsInB1c2giLCJjb25jYXQiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVkdWNlIiwidW5pdFJ1bGVzUHJvZHVjdGlvbiIsInByb2R1Y3Rpb25OYW1lIiwiZ2V0TmFtZSIsInByb2R1Y3Rpb25OYW1lcyIsImdldFByb2R1Y3Rpb25OYW1lcyIsInZlcnRleE5hbWUiLCJkZXNjZW5kYW50VmVydGV4TmFtZXMiLCJhZGRWZXJ0ZXgiLCJjb21wb25lbnRQcm9kdWN0aW9ucyIsImNvbXBvbmVudCIsImNvbXBvbmVudEN5Y2xpYyIsImlzQ3ljbGljIiwiY3ljbGljQ29tcG9uZW50Iiwibm9uQ3ljbGljUHJvZHVjdGlvbnMiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQiLCJub25DeWNsaWNDb21wb25lbnQiLCJwcm9kdWN0aW9uRnJvbU5vbkN5Y2xpY0NvbXBvbmVudCIsImN5Y2xpY1Byb2R1Y3Rpb25zIiwibWFwVmVydGV4IiwidmVydGV4IiwiY3ljbGljUHJvZHVjdGlvbk5hbWUiLCJmaW5kUHJvZHVjdGlvbiIsImN5Y2xpY1Byb2R1Y3Rpb24iLCJ1bml0UHJvZHVjdGlvbnMiLCJ1bml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMiLCJub25Vbml0UHJvZHVjdGlvbnMiLCJub25Vbml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMiLCJjeWNsaWNQcm9kdWN0aW9uRWRnZXMiLCJnZXRVbml0UHJvZHVjdGlvbnMiLCJtYXAiLCJub25Vbml0UHJvZHVjdGlvbiIsImZyb21DeWNsaWNQcm9kdWN0aW9uIiwibm9uQ3ljbGljQ29tcG9uZW50Rmlyc3RWZXJ0ZXgiLCJnZXRGaXJzdFZlcnRleCIsIm5vbkN5Y2xpY0NvbXBvbmVudEZpcnN0VmVydGV4TmFtZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLFFBQVFDLFFBQVEsU0FBUixDQUFkO0FBQUEsSUFDTUMsYUFBYUQsUUFBUSxnQkFBUixDQURuQjtBQUFBLElBRU1FLG9CQUFvQkYsUUFBUSxzQkFBUixDQUYxQjtBQUFBLElBR01HLHNCQUFzQkgsUUFBUSx3QkFBUixDQUg1QjtBQUFBLElBSU1J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QUhuQjs7QUFLQSxTQUFPVyxVQUFQO0FBQ0QiLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgR3JhcGggPSByZXF1aXJlKCcuL2dyYXBoJyksXG4gICAgICBwYXJzZXJVdGlsID0gcmVxdWlyZSgnLi4vdXRpbC9wYXJzZXInKSxcbiAgICAgIE5vblVuaXRQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL25vblVuaXQnKSxcbiAgICAgIFVuaXRSdWxlc1Byb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vdW5pdFJ1bGVzJyksXG4gICAgICBSaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIE5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL25vbkxlZnRSZWN1cnNpdmUnKSxcbiAgICAgIE5vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9ub25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZScpO1xuXG5jbGFzcyBncmFtbWFyVXRpbCB7XG4gIHN0YXRpYyBlbGltaW5hdGVDeWNsZXMocHJvZHVjdGlvbnMpIHtcbiAgICBjb25zdCB1bml0UnVsZXNQcm9kdWN0aW9ucyA9IHVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgICBncmFwaCA9IGdyYXBoRnJvbVVuaXRSdWxlc1Byb2R1Y3Rpb25zKHVuaXRSdWxlc1Byb2R1Y3Rpb25zKSxcbiAgICAgICAgICBjb21wb25lbnRzID0gZ3JhcGguZ2V0Q29tcG9uZW50cygpO1xuXG4gICAgcHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9uc0Zyb21Db21wb25lbnRzKGNvbXBvbmVudHMsIHByb2R1Y3Rpb25zKTtcblxuICAgIHJldHVybiBwcm9kdWN0aW9ucztcbiAgfVxuXG4gIHN0YXRpYyBlbGltaW5hdGVMZWZ0UmVjdXJzaW9uKHByb2R1Y3Rpb25zKSB7XG4gICAgY29uc3Qgbm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zID0gW10sXG4gICAgICAgICAgcmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9ucyA9IFtdO1xuXG4gICAgcHJvZHVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbihwcm9kdWN0aW9uLCBpbmRleCkge1xuICAgICAgY29uc3QgYmVnaW4gPSAwLFxuICAgICAgICAgICAgZW5kID0gaW5kZXgsICAvLy9cbiAgICAgICAgICAgIHByZXZpb3VzTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zID0gbm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zLnNsaWNlKGJlZ2luLCBlbmQpLFxuICAgICAgICAgICAgcHJldmlvdXNQcm9kdWN0aW9ucyA9IHByZXZpb3VzTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zLCAgLy8vXG4gICAgICAgICAgICBwcm9kdWN0aW9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmUgPSBwcm9kdWN0aW9uLmlzSW1wbGljaXRseUxlZnRSZWN1cnNpdmUocHJldmlvdXNQcm9kdWN0aW9ucyk7XG5cbiAgICAgIGlmIChwcm9kdWN0aW9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgY29uc3Qgbm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gTm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uQW5kUHJldmlvdXNQcm9kdWN0aW9ucyhwcm9kdWN0aW9uLCBwcmV2aW91c1Byb2R1Y3Rpb25zKTtcblxuICAgICAgICBwcm9kdWN0aW9uID0gbm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uOyAgLy8vXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb2R1Y3Rpb25MZWZ0UmVjdXJzaXZlID0gcHJvZHVjdGlvbi5pc0xlZnRSZWN1cnNpdmUoKTtcblxuICAgICAgaWYgKHByb2R1Y3Rpb25MZWZ0UmVjdXJzaXZlKSB7XG4gICAgICAgIGNvbnN0IG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbiksXG4gICAgICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbiA9IFJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgICAgICBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMucHVzaChub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbik7XG5cbiAgICAgICAgcmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9ucy5wdXNoKHJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiA9IHByb2R1Y3Rpb247ICAvLy9cblxuICAgICAgICBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMucHVzaChub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBwcm9kdWN0aW9ucyA9IFtdLmNvbmNhdChub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMpLmNvbmNhdChyaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb25zKTtcblxuICAgIHJldHVybiBwcm9kdWN0aW9ucztcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGdyYW1tYXJVdGlsO1xuXG5mdW5jdGlvbiB1bml0UnVsZXNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0UnVsZXNQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLnJlZHVjZShmdW5jdGlvbih1bml0UnVsZXNQcm9kdWN0aW9ucywgcHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb24gPSBVbml0UnVsZXNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuXG4gICAgaWYgKHVuaXRSdWxlc1Byb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIHVuaXRSdWxlc1Byb2R1Y3Rpb25zLnB1c2godW5pdFJ1bGVzUHJvZHVjdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuaXRSdWxlc1Byb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlc1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBncmFwaEZyb21Vbml0UnVsZXNQcm9kdWN0aW9ucyh1bml0UnVsZXNQcm9kdWN0aW9ucykge1xuICBjb25zdCBncmFwaCA9IG5ldyBHcmFwaCgpO1xuXG4gIHVuaXRSdWxlc1Byb2R1Y3Rpb25zLmZvckVhY2goZnVuY3Rpb24odW5pdFJ1bGVzUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gdW5pdFJ1bGVzUHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgcHJvZHVjdGlvbk5hbWVzID0gdW5pdFJ1bGVzUHJvZHVjdGlvbi5nZXRQcm9kdWN0aW9uTmFtZXMoKSxcbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gcHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSBwcm9kdWN0aW9uTmFtZXM7IC8vL1xuXG4gICAgZ3JhcGguYWRkVmVydGV4KHZlcnRleE5hbWUsIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyk7XG4gIH0pO1xuXG4gIHJldHVybiBncmFwaDtcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBjb21wb25lbnRQcm9kdWN0aW9ucyA9IGNvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKGNvbXBvbmVudFByb2R1Y3Rpb25zLCBjb21wb25lbnQpIHtcbiAgICBjb25zdCBjb21wb25lbnRDeWNsaWMgPSBjb21wb25lbnQuaXNDeWNsaWMoKTtcblxuICAgIGlmIChjb21wb25lbnRDeWNsaWMpIHtcbiAgICAgIGNvbnN0IGN5Y2xpY0NvbXBvbmVudCA9IGNvbXBvbmVudCwgIC8vL1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnMgPSBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQoY3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucyk7XG5cbiAgICAgIGNvbXBvbmVudFByb2R1Y3Rpb25zID0gY29tcG9uZW50UHJvZHVjdGlvbnMuY29uY2F0KG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbm9uQ3ljbGljQ29tcG9uZW50ID0gY29tcG9uZW50LCAgLy8vXG4gICAgICAgICAgICBwcm9kdWN0aW9uID0gcHJvZHVjdGlvbkZyb21Ob25DeWNsaWNDb21wb25lbnQobm9uQ3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucyk7XG5cbiAgICAgIGNvbXBvbmVudFByb2R1Y3Rpb25zLnB1c2gocHJvZHVjdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbXBvbmVudFByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcHJvZHVjdGlvbnMgPSBjb21wb25lbnRQcm9kdWN0aW9uczsgLy8vXG5cbiAgcmV0dXJuIHByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQoY3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBjeWNsaWNQcm9kdWN0aW9ucyA9IGN5Y2xpY0NvbXBvbmVudC5tYXBWZXJ0ZXgoZnVuY3Rpb24odmVydGV4KSB7XG4gICAgICAgICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCksXG4gICAgICAgICAgICAgICAgY3ljbGljUHJvZHVjdGlvbk5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oY3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKSxcbiAgICAgICAgICAgICAgICBjeWNsaWNQcm9kdWN0aW9uID0gVW5pdFJ1bGVzUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgICAgICAgIHJldHVybiBjeWNsaWNQcm9kdWN0aW9uO1xuICAgICAgICB9KSxcbiAgICAgICAgdW5pdFByb2R1Y3Rpb25zID0gdW5pdFByb2R1Y3Rpb25zRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zKGN5Y2xpY1Byb2R1Y3Rpb25zKSxcbiAgICAgICAgbm9uVW5pdFByb2R1Y3Rpb25zID0gbm9uVW5pdFByb2R1Y3Rpb25zRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zKGN5Y2xpY1Byb2R1Y3Rpb25zKTtcblxuICBkZWJ1Z2dlclxufVxuXG5mdW5jdGlvbiB1bml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMoY3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdFByb2R1Y3Rpb25zID0gY3ljbGljUHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRQcm9kdWN0aW9ucywgY3ljbGljUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IGN5Y2xpY1Byb2R1Y3Rpb25FZGdlcyA9IGN5Y2xpY1Byb2R1Y3Rpb24uZ2V0VW5pdFByb2R1Y3Rpb25zKCk7XG5cbiAgICB1bml0UHJvZHVjdGlvbnMgPSB1bml0UHJvZHVjdGlvbnMuY29uY2F0KGN5Y2xpY1Byb2R1Y3Rpb25FZGdlcyk7XG5cbiAgICByZXR1cm4gdW5pdFByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gbm9uVW5pdFByb2R1Y3Rpb25zRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zKGN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IG5vblVuaXRQcm9kdWN0aW9ucyA9IGN5Y2xpY1Byb2R1Y3Rpb25zLm1hcChmdW5jdGlvbihjeWNsaWNQcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uVW5pdFByb2R1Y3Rpb24gPSBOb25Vbml0UHJvZHVjdGlvbi5mcm9tQ3ljbGljUHJvZHVjdGlvbihjeWNsaWNQcm9kdWN0aW9uKTtcbiAgICBcbiAgICByZXR1cm4gbm9uVW5pdFByb2R1Y3Rpb247XG4gIH0pO1xuICBcbiAgcmV0dXJuIG5vblVuaXRQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbkZyb21Ob25DeWNsaWNDb21wb25lbnQobm9uQ3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleCA9IG5vbkN5Y2xpY0NvbXBvbmVudC5nZXRGaXJzdFZlcnRleCgpLFxuICAgICAgICBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleE5hbWUgPSBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleC5nZXROYW1lKCksXG4gICAgICAgIHByb2R1Y3Rpb25OYW1lID0gbm9uQ3ljbGljQ29tcG9uZW50Rmlyc3RWZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgIHByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyk7XG5cbiAgcmV0dXJuIHByb2R1Y3Rpb247XG59Il19