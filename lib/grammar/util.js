'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Graph = require('./graph'),
    parserUtil = require('../util/parser'),
    CyclicProduction = require('./production/unitRules'),
    NonUnitProduction = require('./production/nonUnit'),
    RightRecursiveProduction = require('./production/rightRecursive'),
    NonLeftRecursiveProduction = require('./production/nonLeftRecursive'),
    NonImplicitlyLeftRecursiveProduction = require('./production/nonImplicitlyLeftRecursive');

var grammarUtil = function () {
  function grammarUtil() {
    _classCallCheck(this, grammarUtil);
  }

  _createClass(grammarUtil, null, [{
    key: 'eliminateCycles',
    value: function eliminateCycles(productions) {
      var cyclicProductions = cyclicProductionsFromProductions(productions),
          graph = graphFromCyclicProductions(cyclicProductions),
          components = graph.getComponents();

      productions = productionsFromComponents(components, productions);

      return productions;
    }
  }, {
    key: 'eliminateLeftRecursion',
    value: function eliminateLeftRecursion(productions) {
      var nonLeftRecursiveProductions = [],
          rightRecursiveProductions = [];

      productions.forEach(function (production, index) {
        var begin = 0,
            end = index,
            ///
        previousNonLeftRecursiveProductions = nonLeftRecursiveProductions.slice(begin, end),
            previousProductions = previousNonLeftRecursiveProductions,
            ///
        productionImplicitlyLeftRecursive = production.isImplicitlyLeftRecursive(previousProductions);

        if (productionImplicitlyLeftRecursive) {
          var nonImplicitlyLeftRecursiveProduction = NonImplicitlyLeftRecursiveProduction.fromProductionAndPreviousProductions(production, previousProductions);

          production = nonImplicitlyLeftRecursiveProduction; ///
        }

        var productionLeftRecursive = production.isLeftRecursive();

        if (productionLeftRecursive) {
          var nonLeftRecursiveProduction = NonLeftRecursiveProduction.fromProduction(production),
              rightRecursiveProduction = RightRecursiveProduction.fromProduction(production);

          nonLeftRecursiveProductions.push(nonLeftRecursiveProduction);

          rightRecursiveProductions.push(rightRecursiveProduction);
        } else {
          var _nonLeftRecursiveProduction = production; ///

          nonLeftRecursiveProductions.push(_nonLeftRecursiveProduction);
        }
      });

      productions = [].concat(nonLeftRecursiveProductions).concat(rightRecursiveProductions);

      return productions;
    }
  }]);

  return grammarUtil;
}();

module.exports = grammarUtil;

function cyclicProductionsFromProductions(productions) {
  var cyclicProductions = productions.reduce(function (cyclicProductions, production) {
    var cyclicProduction = CyclicProduction.fromProduction(production);

    if (cyclicProduction !== null) {
      cyclicProductions.push(cyclicProduction);
    }

    return cyclicProductions;
  }, []);

  return cyclicProductions;
}

function graphFromCyclicProductions(cyclicProductions) {
  var graph = new Graph();

  cyclicProductions.forEach(function (cyclicProduction) {
    var cyclicProductionName = cyclicProduction.getName(),
        cyclicProductionRulesProductionNames = cyclicProduction.getRulesProductionNames(),
        vertexName = cyclicProductionName,
        ///
    descendantVertexNames = cyclicProductionRulesProductionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function productionsFromComponents(components, productions) {
  var componentProductions = components.reduce(function (componentProductions, component) {
    var componentCyclic = component.isCyclic();

    if (componentCyclic) {
      var cyclicComponent = component,
          ///
      nonCyclicProductions = nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions);

      componentProductions = componentProductions.concat(nonCyclicProductions);
    } else {
      var nonCyclicComponent = component,
          ///
      production = productionFromNonCyclicComponent(nonCyclicComponent, productions);

      componentProductions.push(production);
    }

    return componentProductions;
  }, []);

  productions = componentProductions; ///

  return productions;
}

function nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions) {
  var cyclicProductions = cyclicComponent.mapVertex(function (vertex) {
    var vertexName = vertex.getName(),
        cyclicProductionName = vertexName,
        ///
    production = parserUtil.findProduction(cyclicProductionName, productions),
        cyclicProduction = CyclicProduction.fromProduction(production);

    return cyclicProduction;
  }),
      unitProductions = unitProductionsFromCyclicProductions(cyclicProductions),
      nonUnitProductions = nonUnitProductionsFromCyclicProductions(cyclicProductions);

  debugger;
}

function unitProductionsFromCyclicProductions(cyclicProductions) {
  var unitProductions = cyclicProductions.reduce(function (unitProductions, cyclicProduction) {
    var cyclicProductionEdges = cyclicProduction.getUnitProductions();

    unitProductions = unitProductions.concat(cyclicProductionEdges);

    return unitProductions;
  }, []);

  return unitProductions;
}

function nonUnitProductionsFromCyclicProductions(cyclicProductions) {
  var nonUnitProductions = cyclicProductions.map(function (cyclicProduction) {
    var nonUnitProduction = NonUnitProduction.fromCyclicProduction(cyclicProduction);

    return nonUnitProduction;
  });

  return nonUnitProductions;
}

function productionFromNonCyclicComponent(nonCyclicComponent, productions) {
  var nonCyclicComponentFirstVertex = nonCyclicComponent.getFirstVertex(),
      nonCyclicComponentFirstVertexName = nonCyclicComponentFirstVertex.getName(),
      productionName = nonCyclicComponentFirstVertexName,
      ///
  production = parserUtil.findProduction(productionName, productions);

  return production;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL3V0aWwuanMiXSwibmFtZXMiOlsiR3JhcGgiLCJyZXF1aXJlIiwicGFyc2VyVXRpbCIsIkN5Y2xpY1Byb2R1Y3Rpb24iLCJOb25Vbml0UHJvZHVjdGlvbiIsIlJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbiIsIk5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uIiwiTm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uIiwiZ3JhbW1hclV0aWwiLCJwcm9kdWN0aW9ucyIsImN5Y2xpY1Byb2R1Y3Rpb25zIiwiY3ljbGljUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMiLCJncmFwaCIsImdyYXBoRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zIiwiY29tcG9uZW50cyIsImdldENvbXBvbmVudHMiLCJwcm9kdWN0aW9uc0Zyb21Db21wb25lbnRzIiwibm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zIiwicmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9ucyIsImZvckVhY2giLCJwcm9kdWN0aW9uIiwiaW5kZXgiLCJiZWdpbiIsImVuZCIsInByZXZpb3VzTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zIiwic2xpY2UiLCJwcmV2aW91c1Byb2R1Y3Rpb25zIiwicHJvZHVjdGlvbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlIiwiaXNJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZSIsIm5vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uQW5kUHJldmlvdXNQcm9kdWN0aW9ucyIsInByb2R1Y3Rpb25MZWZ0UmVjdXJzaXZlIiwiaXNMZWZ0UmVjdXJzaXZlIiwibm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24iLCJmcm9tUHJvZHVjdGlvbiIsInJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbiIsInB1c2giLCJjb25jYXQiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVkdWNlIiwiY3ljbGljUHJvZHVjdGlvbiIsImN5Y2xpY1Byb2R1Y3Rpb25OYW1lIiwiZ2V0TmFtZSIsImN5Y2xpY1Byb2R1Y3Rpb25SdWxlc1Byb2R1Y3Rpb25OYW1lcyIsImdldFJ1bGVzUHJvZHVjdGlvbk5hbWVzIiwidmVydGV4TmFtZSIsImRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyIsImFkZFZlcnRleCIsImNvbXBvbmVudFByb2R1Y3Rpb25zIiwiY29tcG9uZW50IiwiY29tcG9uZW50Q3ljbGljIiwiaXNDeWNsaWMiLCJjeWNsaWNDb21wb25lbnQiLCJub25DeWNsaWNQcm9kdWN0aW9ucyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUN5Y2xpY0NvbXBvbmVudCIsIm5vbkN5Y2xpY0NvbXBvbmVudCIsInByb2R1Y3Rpb25Gcm9tTm9uQ3ljbGljQ29tcG9uZW50IiwibWFwVmVydGV4IiwidmVydGV4IiwiZmluZFByb2R1Y3Rpb24iLCJ1bml0UHJvZHVjdGlvbnMiLCJ1bml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMiLCJub25Vbml0UHJvZHVjdGlvbnMiLCJub25Vbml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMiLCJjeWNsaWNQcm9kdWN0aW9uRWRnZXMiLCJnZXRVbml0UHJvZHVjdGlvbnMiLCJtYXAiLCJub25Vbml0UHJvZHVjdGlvbiIsImZyb21DeWNsaWNQcm9kdWN0aW9uIiwibm9uQ3ljbGljQ29tcG9uZW50Rmlyc3RWZXJ0ZXgiLCJnZXRGaXJzdFZlcnRleCIsIm5vbkN5Y2xpY0NvbXBvbmVudEZpcnN0VmVydGV4TmFtZSIsInByb2R1Y3Rpb25OYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsUUFBUUMsUUFBUSxTQUFSLENBQWQ7QUFBQSxJQUNNQyxhQUFhRCxRQUFRLGdCQUFSLENBRG5CO0FBQUEsSUFFTUUsbUJBQW1CRixRQUFRLHdCQUFSLENBRnpCO0FBQUEsSUFHTUcsb0JBQW9CSCxRQUFRLHNCQUFSLENBSDFCO0FBQUEsSUFJTUksMkJBQTJCSixRQUFRLDZCQUFSLENBSmpDO0FB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S0EsU0FBT1csVUFBUDtBQUNEIiwiZmlsZSI6InV0aWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IEdyYXBoID0gcmVxdWlyZSgnLi9ncmFwaCcpLFxuICAgICAgcGFyc2VyVXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwvcGFyc2VyJyksXG4gICAgICBDeWNsaWNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlcycpLFxuICAgICAgTm9uVW5pdFByb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vbm9uVW5pdCcpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3JpZ2h0UmVjdXJzaXZlJyksXG4gICAgICBOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9ub25MZWZ0UmVjdXJzaXZlJyksXG4gICAgICBOb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vbm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmUnKTtcblxuY2xhc3MgZ3JhbW1hclV0aWwge1xuICBzdGF0aWMgZWxpbWluYXRlQ3ljbGVzKHByb2R1Y3Rpb25zKSB7XG4gICAgY29uc3QgY3ljbGljUHJvZHVjdGlvbnMgPSBjeWNsaWNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucyksXG4gICAgICAgICAgZ3JhcGggPSBncmFwaEZyb21DeWNsaWNQcm9kdWN0aW9ucyhjeWNsaWNQcm9kdWN0aW9ucyksXG4gICAgICAgICAgY29tcG9uZW50cyA9IGdyYXBoLmdldENvbXBvbmVudHMoKTtcblxuICAgIHByb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucyk7XG5cbiAgICByZXR1cm4gcHJvZHVjdGlvbnM7XG4gIH1cblxuICBzdGF0aWMgZWxpbWluYXRlTGVmdFJlY3Vyc2lvbihwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucyA9IFtdLFxuICAgICAgICAgIHJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbnMgPSBbXTtcblxuICAgIHByb2R1Y3Rpb25zLmZvckVhY2goZnVuY3Rpb24ocHJvZHVjdGlvbiwgaW5kZXgpIHtcbiAgICAgIGNvbnN0IGJlZ2luID0gMCxcbiAgICAgICAgICAgIGVuZCA9IGluZGV4LCAgLy8vXG4gICAgICAgICAgICBwcmV2aW91c05vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucyA9IG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucy5zbGljZShiZWdpbiwgZW5kKSxcbiAgICAgICAgICAgIHByZXZpb3VzUHJvZHVjdGlvbnMgPSBwcmV2aW91c05vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucywgIC8vL1xuICAgICAgICAgICAgcHJvZHVjdGlvbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlID0gcHJvZHVjdGlvbi5pc0ltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlKHByZXZpb3VzUHJvZHVjdGlvbnMpO1xuXG4gICAgICBpZiAocHJvZHVjdGlvbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlKSB7XG4gICAgICAgIGNvbnN0IG5vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiA9IE5vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbkFuZFByZXZpb3VzUHJvZHVjdGlvbnMocHJvZHVjdGlvbiwgcHJldmlvdXNQcm9kdWN0aW9ucyk7XG5cbiAgICAgICAgcHJvZHVjdGlvbiA9IG5vbkltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbjsgIC8vL1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwcm9kdWN0aW9uTGVmdFJlY3Vyc2l2ZSA9IHByb2R1Y3Rpb24uaXNMZWZ0UmVjdXJzaXZlKCk7XG5cbiAgICAgIGlmIChwcm9kdWN0aW9uTGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiA9IE5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pLFxuICAgICAgICAgICAgICByaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSBSaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG5cbiAgICAgICAgbm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zLnB1c2gobm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24pO1xuXG4gICAgICAgIHJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbnMucHVzaChyaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb24pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgbm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSBwcm9kdWN0aW9uOyAgLy8vXG5cbiAgICAgICAgbm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zLnB1c2gobm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcHJvZHVjdGlvbnMgPSBbXS5jb25jYXQobm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb25zKS5jb25jYXQocmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9ucyk7XG5cbiAgICByZXR1cm4gcHJvZHVjdGlvbnM7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBncmFtbWFyVXRpbDtcblxuZnVuY3Rpb24gY3ljbGljUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgY3ljbGljUHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24oY3ljbGljUHJvZHVjdGlvbnMsIHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBjeWNsaWNQcm9kdWN0aW9uID0gQ3ljbGljUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgIGlmIChjeWNsaWNQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjeWNsaWNQcm9kdWN0aW9ucy5wdXNoKGN5Y2xpY1Byb2R1Y3Rpb24pO1xuICAgIH1cblxuICAgIHJldHVybiBjeWNsaWNQcm9kdWN0aW9ucztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBjeWNsaWNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gZ3JhcGhGcm9tQ3ljbGljUHJvZHVjdGlvbnMoY3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgZ3JhcGggPSBuZXcgR3JhcGgoKTtcblxuICBjeWNsaWNQcm9kdWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGN5Y2xpY1Byb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBjeWNsaWNQcm9kdWN0aW9uTmFtZSA9IGN5Y2xpY1Byb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIGN5Y2xpY1Byb2R1Y3Rpb25SdWxlc1Byb2R1Y3Rpb25OYW1lcyA9IGN5Y2xpY1Byb2R1Y3Rpb24uZ2V0UnVsZXNQcm9kdWN0aW9uTmFtZXMoKSxcbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gY3ljbGljUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSBjeWNsaWNQcm9kdWN0aW9uUnVsZXNQcm9kdWN0aW9uTmFtZXM7IC8vL1xuXG4gICAgZ3JhcGguYWRkVmVydGV4KHZlcnRleE5hbWUsIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyk7XG4gIH0pO1xuXG4gIHJldHVybiBncmFwaDtcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBjb21wb25lbnRQcm9kdWN0aW9ucyA9IGNvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKGNvbXBvbmVudFByb2R1Y3Rpb25zLCBjb21wb25lbnQpIHtcbiAgICBjb25zdCBjb21wb25lbnRDeWNsaWMgPSBjb21wb25lbnQuaXNDeWNsaWMoKTtcblxuICAgIGlmIChjb21wb25lbnRDeWNsaWMpIHtcbiAgICAgIGNvbnN0IGN5Y2xpY0NvbXBvbmVudCA9IGNvbXBvbmVudCwgIC8vL1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnMgPSBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQoY3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucyk7XG5cbiAgICAgIGNvbXBvbmVudFByb2R1Y3Rpb25zID0gY29tcG9uZW50UHJvZHVjdGlvbnMuY29uY2F0KG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbm9uQ3ljbGljQ29tcG9uZW50ID0gY29tcG9uZW50LCAgLy8vXG4gICAgICAgICAgICBwcm9kdWN0aW9uID0gcHJvZHVjdGlvbkZyb21Ob25DeWNsaWNDb21wb25lbnQobm9uQ3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucyk7XG5cbiAgICAgIGNvbXBvbmVudFByb2R1Y3Rpb25zLnB1c2gocHJvZHVjdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbXBvbmVudFByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcHJvZHVjdGlvbnMgPSBjb21wb25lbnRQcm9kdWN0aW9uczsgLy8vXG5cbiAgcmV0dXJuIHByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQoY3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBjeWNsaWNQcm9kdWN0aW9ucyA9IGN5Y2xpY0NvbXBvbmVudC5tYXBWZXJ0ZXgoZnVuY3Rpb24odmVydGV4KSB7XG4gICAgICAgICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCksXG4gICAgICAgICAgICAgICAgY3ljbGljUHJvZHVjdGlvbk5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oY3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKSxcbiAgICAgICAgICAgICAgICBjeWNsaWNQcm9kdWN0aW9uID0gQ3ljbGljUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgICAgICAgIHJldHVybiBjeWNsaWNQcm9kdWN0aW9uO1xuICAgICAgICB9KSxcbiAgICAgICAgdW5pdFByb2R1Y3Rpb25zID0gdW5pdFByb2R1Y3Rpb25zRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zKGN5Y2xpY1Byb2R1Y3Rpb25zKSxcbiAgICAgICAgbm9uVW5pdFByb2R1Y3Rpb25zID0gbm9uVW5pdFByb2R1Y3Rpb25zRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zKGN5Y2xpY1Byb2R1Y3Rpb25zKTtcblxuICBkZWJ1Z2dlclxufVxuXG5mdW5jdGlvbiB1bml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMoY3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdFByb2R1Y3Rpb25zID0gY3ljbGljUHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRQcm9kdWN0aW9ucywgY3ljbGljUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IGN5Y2xpY1Byb2R1Y3Rpb25FZGdlcyA9IGN5Y2xpY1Byb2R1Y3Rpb24uZ2V0VW5pdFByb2R1Y3Rpb25zKCk7XG5cbiAgICB1bml0UHJvZHVjdGlvbnMgPSB1bml0UHJvZHVjdGlvbnMuY29uY2F0KGN5Y2xpY1Byb2R1Y3Rpb25FZGdlcyk7XG5cbiAgICByZXR1cm4gdW5pdFByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gbm9uVW5pdFByb2R1Y3Rpb25zRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zKGN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IG5vblVuaXRQcm9kdWN0aW9ucyA9IGN5Y2xpY1Byb2R1Y3Rpb25zLm1hcChmdW5jdGlvbihjeWNsaWNQcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uVW5pdFByb2R1Y3Rpb24gPSBOb25Vbml0UHJvZHVjdGlvbi5mcm9tQ3ljbGljUHJvZHVjdGlvbihjeWNsaWNQcm9kdWN0aW9uKTtcbiAgICBcbiAgICByZXR1cm4gbm9uVW5pdFByb2R1Y3Rpb247XG4gIH0pO1xuICBcbiAgcmV0dXJuIG5vblVuaXRQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbkZyb21Ob25DeWNsaWNDb21wb25lbnQobm9uQ3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleCA9IG5vbkN5Y2xpY0NvbXBvbmVudC5nZXRGaXJzdFZlcnRleCgpLFxuICAgICAgICBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleE5hbWUgPSBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleC5nZXROYW1lKCksXG4gICAgICAgIHByb2R1Y3Rpb25OYW1lID0gbm9uQ3ljbGljQ29tcG9uZW50Rmlyc3RWZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgIHByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyk7XG5cbiAgcmV0dXJuIHByb2R1Y3Rpb247XG59Il19