'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var tarjan = require('occam-tarjan');

var parserUtil = require('../util/parser'),
    Production = require('../extendedBNF/production'),
    UnitProduction = require('./production/unit'),
    UnitsProduction = require('./production/units'),
    FixedProduction = require('./production/fixed'),
    NonCyclicProduction = require('./production/nonCyclic');

var Graph = tarjan.Graph;

var cycles = function () {
  function cycles() {
    _classCallCheck(this, cycles);
  }

  _createClass(cycles, null, [{
    key: 'eliminate',
    value: function eliminate(productions) {
      var graph = graphFromProductions(productions),
          components = graph.generateComponents(),
          nonCyclicProductions = nonCyclicProductionsFromComponents(components, productions);

      productions = productions.map(function (production) {
        var productionName = production.getName(),
            nonCyclicProductionName = productionName,
            ///
        nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, nonCyclicProductions);

        if (nonCyclicProduction !== null) {
          production = nonCyclicProduction; ///
        } else {
          var alreadyNonCyclicProductionName = productionName,
              ///
          alreadyNonCyclicProduction = parserUtil.findProduction(alreadyNonCyclicProductionName, productions); ///

          production = alreadyNonCyclicProduction; ///
        }

        return production;
      });

      return productions;
    }
  }]);

  return cycles;
}();

module.exports = cycles;

function graphFromProductions(productions) {
  var graph = new Graph(),
      unitsProductions = unitsProductionsFromProductions(productions);

  unitsProductions.forEach(function (unitsProduction) {
    var productionName = unitsProduction.getName(),
        unitDefinitionsProductionNames = unitsProduction.getUnitDefinitionProductionNames(),
        vertexName = productionName,
        ///
    descendantVertexNames = unitDefinitionsProductionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function unitsProductionsFromProductions(productions) {
  var unitsProductions = productions.reduce(function (unitsProductions, production) {
    var unitsProduction = UnitsProduction.fromProduction(production);

    if (unitsProduction !== null) {
      unitsProductions.push(unitsProduction);
    }

    return unitsProductions;
  }, []);

  return unitsProductions;
}

function nonCyclicProductionsFromComponents(components, productions) {
  var nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      nonCyclicProductionFromComponent(component, productions, nonCyclicProductions);
    } else {
      nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function nonCyclicProductionFromComponent(component, productions, nonCyclicProductions) {
  var firstVertexName = component.getFirstVertexName(),
      productionName = firstVertexName,
      ///
  production = parserUtil.findProduction(productionName, productions);

  if (production !== null) {
    var nonCyclicProduction = NonCyclicProduction.fromProduction(production);

    nonCyclicProductions.push(nonCyclicProduction);
  }
}

function nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions) {
  var unitProductions = unitProductionsFromComponent(component, productions),
      fixedProductions = fixedProductionsFromComponent(component, productions),
      addedProductions = addedProductionsFromUnitProductionsAndFixedProductions(unitProductions, fixedProductions);

  nonCyclicProductionsFromFixedProductionsAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions);
}

function addedProductionsFromUnitProductionsAndFixedProductions(unitProductions, fixedProductions) {
  var addedProductions = [],
      removedUnitProductions = [];

  var unitProductionsLength = unitProductions.length;

  while (unitProductionsLength > 0) {
    var unitProduction = unitProductions.shift(),
        unitProductionName = unitProduction.getName();

    var removedUnitProduction = unitProduction; ///

    removedUnitProductions.push(removedUnitProduction);

    var unitProductionUnitProductionName = unitProduction.getUnitProductionName(),
        fixedProductionName = unitProductionUnitProductionName,
        ///
    fixedProduction = parserUtil.findProduction(fixedProductionName, fixedProductions),
        addedProductionName = unitProductionName; ///

    var addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction === null) {
      addedProduction = Production.fromProduction(fixedProduction);

      addedProduction.setName(addedProductionName);

      addedProductions.push(addedProduction);
    } else {
      var fixedProductionDefinitions = fixedProduction.getDefinitions();

      addedProduction.addDefinitions(fixedProductionDefinitions);
    }

    var intermediateUnitProductionName = unitProductionUnitProductionName,
        ///
    intermediateUnitProduction = parserUtil.findProduction(intermediateUnitProductionName, unitProductions);

    if (intermediateUnitProduction !== null) {
      var intermediateUnitProductionUnitProductionName = intermediateUnitProduction.getUnitProductionName(),
          firstProductionName = unitProductionName,
          ///
      secondProductionName = intermediateUnitProductionUnitProductionName,
          ///
      unitProductionNonCyclic = firstProductionName !== secondProductionName;

      if (unitProductionNonCyclic) {
        unitProduction = findUnitProduction(firstProductionName, secondProductionName, removedUnitProductions);

        if (unitProduction === null) {
          unitProduction = UnitProduction.fromProductionNames(firstProductionName, secondProductionName);

          unitProductions.unshift(unitProduction);
        }
      }
    }

    unitProductionsLength = unitProductions.length;
  }

  return addedProductions;
}

function nonCyclicProductionsFromFixedProductionsAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions) {
  fixedProductions.forEach(function (fixedProduction) {
    var nonCyclicProduction = fixedProduction,
        ///
    nonCyclicProductionName = nonCyclicProduction.getName(),
        addedProductionName = nonCyclicProductionName,
        ///
    addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction !== null) {
      var addedProductionDefinitions = addedProduction.getDefinitions();

      nonCyclicProduction.addDefinitions(addedProductionDefinitions);
    }

    var nonCyclicProductionDefinitionsExist = nonCyclicProduction.doDefinitionsExist();

    if (nonCyclicProductionDefinitionsExist) {
      nonCyclicProductions.push(nonCyclicProduction);
    }
  });
}

function unitProductionsFromComponent(component, productions) {
  var componentVertexNames = component.getVertexNames(),
      unitsProductions = unitsProductionsFromComponent(component, productions),
      productionNames = componentVertexNames,
      ///
  unitProductions = unitProductionsFromUnitsProductionsAndProductionNames(unitsProductions, productionNames);

  return unitProductions;
}

function unitsProductionsFromComponent(component, productions) {
  var unitsProductions = component.reduceVertexNames(function (unitsProductions, vertexName) {
    var productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions),
        unitsProduction = UnitsProduction.fromProduction(production);

    if (unitsProduction !== null) {
      unitsProductions.push(unitsProduction);
    }

    return unitsProductions;
  }, []);

  return unitsProductions;
}

function unitProductionsFromUnitsProductionsAndProductionNames(unitsProductions, productionNames) {
  var unitProductions = unitsProductions.reduce(function (unitProductions, unitsProduction) {
    var unitsProductionName = unitsProduction.getName();

    unitsProduction.forEachUnitDefinition(function (unitDefinition) {
      var name = unitsProductionName,
          ///
      unitProduction = UnitProduction.fromNameAndUnitDefinition(name, unitDefinition),
          unitProductionNotCyclic = unitProduction.isNotCyclic(),
          unitProductionIncludedInProductionNames = unitProduction.isIncludedInProductionNames(productionNames);

      if (unitProductionNotCyclic && unitProductionIncludedInProductionNames) {
        unitProductions.push(unitProduction);
      }
    });

    return unitProductions;
  }, []);

  return unitProductions;
}

function fixedProductionsFromComponent(component, productions) {
  var componentVertexNames = component.getVertexNames(),
      productionNames = componentVertexNames,
      ///
  fixedProductions = component.mapVertexNames(function (vertexName) {
    var productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions),
        fixedProduction = FixedProduction.fromProductionAndProductionNames(production, productionNames);

    return fixedProduction;
  });

  return fixedProductions;
}

function findUnitProduction(firstProductionName, secondProductionName, unitProductions) {
  var foundUnitProduction = null;

  unitProductions.some(function (unitProduction) {
    var unitProductionFound = unitProduction.isFoundByProductionNames(firstProductionName, secondProductionName);

    if (unitProductionFound) {
      foundUnitProduction = unitProduction;

      return true;
    }
  });

  var unitProduction = foundUnitProduction; ///

  return unitProduction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL2N5Y2xlcy5qcyJdLCJuYW1lcyI6WyJ0YXJqYW4iLCJyZXF1aXJlIiwicGFyc2VyVXRpbCIsIlByb2R1Y3Rpb24iLCJVbml0UHJvZHVjdGlvbiIsIlVuaXRzUHJvZHVjdGlvbiIsIkZpeGVkUHJvZHVjdGlvbiIsIk5vbkN5Y2xpY1Byb2R1Y3Rpb24iLCJHcmFwaCIsImN5Y2xlcyIsInByb2R1Y3Rpb25zIiwiZ3JhcGgiLCJncmFwaEZyb21Qcm9kdWN0aW9ucyIsImNvbXBvbmVudHMiLCJnZW5lcmF0ZUNvbXBvbmVudHMiLCJub25DeWNsaWNQcm9kdWN0aW9ucyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMiLCJtYXAiLCJwcm9kdWN0aW9uIiwicHJvZHVjdGlvbk5hbWUiLCJnZXROYW1lIiwibm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUiLCJub25DeWNsaWNQcm9kdWN0aW9uIiwiZmluZFByb2R1Y3Rpb24iLCJhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUiLCJhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJ1bml0c1Byb2R1Y3Rpb25zIiwidW5pdHNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyIsImZvckVhY2giLCJ1bml0c1Byb2R1Y3Rpb24iLCJ1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uTmFtZXMiLCJnZXRVbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcyIsInZlcnRleE5hbWUiLCJkZXNjZW5kYW50VmVydGV4TmFtZXMiLCJhZGRWZXJ0ZXgiLCJyZWR1Y2UiLCJmcm9tUHJvZHVjdGlvbiIsInB1c2giLCJjb21wb25lbnQiLCJjb21wb25lbnROb25DeWNsaWMiLCJpc05vbkN5Y2xpYyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50Iiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50IiwiZmlyc3RWZXJ0ZXhOYW1lIiwiZ2V0Rmlyc3RWZXJ0ZXhOYW1lIiwidW5pdFByb2R1Y3Rpb25zIiwidW5pdFByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImZpeGVkUHJvZHVjdGlvbnMiLCJmaXhlZFByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImFkZGVkUHJvZHVjdGlvbnMiLCJhZGRlZFByb2R1Y3Rpb25zRnJvbVVuaXRQcm9kdWN0aW9uc0FuZEZpeGVkUHJvZHVjdGlvbnMiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZFByb2R1Y3Rpb25zQW5kQWRkZWRQcm9kdWN0aW9ucyIsInJlbW92ZWRVbml0UHJvZHVjdGlvbnMiLCJ1bml0UHJvZHVjdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJ1bml0UHJvZHVjdGlvbiIsInNoaWZ0IiwidW5pdFByb2R1Y3Rpb25OYW1lIiwicmVtb3ZlZFVuaXRQcm9kdWN0aW9uIiwidW5pdFByb2R1Y3Rpb25Vbml0UHJvZHVjdGlvbk5hbWUiLCJnZXRVbml0UHJvZHVjdGlvbk5hbWUiLCJmaXhlZFByb2R1Y3Rpb25OYW1lIiwiZml4ZWRQcm9kdWN0aW9uIiwiYWRkZWRQcm9kdWN0aW9uTmFtZSIsImFkZGVkUHJvZHVjdGlvbiIsInNldE5hbWUiLCJmaXhlZFByb2R1Y3Rpb25EZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiYWRkRGVmaW5pdGlvbnMiLCJpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbk5hbWUiLCJpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbiIsImludGVybWVkaWF0ZVVuaXRQcm9kdWN0aW9uVW5pdFByb2R1Y3Rpb25OYW1lIiwiZmlyc3RQcm9kdWN0aW9uTmFtZSIsInNlY29uZFByb2R1Y3Rpb25OYW1lIiwidW5pdFByb2R1Y3Rpb25Ob25DeWNsaWMiLCJmaW5kVW5pdFByb2R1Y3Rpb24iLCJmcm9tUHJvZHVjdGlvbk5hbWVzIiwidW5zaGlmdCIsImFkZGVkUHJvZHVjdGlvbkRlZmluaXRpb25zIiwibm9uQ3ljbGljUHJvZHVjdGlvbkRlZmluaXRpb25zRXhpc3QiLCJkb0RlZmluaXRpb25zRXhpc3QiLCJjb21wb25lbnRWZXJ0ZXhOYW1lcyIsImdldFZlcnRleE5hbWVzIiwidW5pdHNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQiLCJwcm9kdWN0aW9uTmFtZXMiLCJ1bml0UHJvZHVjdGlvbnNGcm9tVW5pdHNQcm9kdWN0aW9uc0FuZFByb2R1Y3Rpb25OYW1lcyIsInJlZHVjZVZlcnRleE5hbWVzIiwidW5pdHNQcm9kdWN0aW9uTmFtZSIsImZvckVhY2hVbml0RGVmaW5pdGlvbiIsInVuaXREZWZpbml0aW9uIiwibmFtZSIsImZyb21OYW1lQW5kVW5pdERlZmluaXRpb24iLCJ1bml0UHJvZHVjdGlvbk5vdEN5Y2xpYyIsImlzTm90Q3ljbGljIiwidW5pdFByb2R1Y3Rpb25JbmNsdWRlZEluUHJvZHVjdGlvbk5hbWVzIiwiaXNJbmNsdWRlZEluUHJvZHVjdGlvbk5hbWVzIiwibWFwVmVydGV4TmFtZXMiLCJmcm9tUHJvZHVjdGlvbkFuZFByb2R1Y3Rpb25OYW1lcyIsImZvdW5kVW5pdFByb2R1Y3Rpb24iLCJzb21lIiwidW5pdFByb2R1Y3Rpb25Gb3VuZCIsImlzRm91bmRCeVByb2R1Y3Rpb25OYW1lcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLFNBQVNDLFFBQVEsY0FBUixDQUFmOztBQUVBLElBQU1DLGFBQWFELFFBQVEsZ0JBQVIsQ0FBbkI7QUFBQSxJQUNNRSxhQUFhRixRQUFRLDJCQUFSLENBRG5CO0FBQUEsSUFFTUcsaUJBQWlCSCxRQUFRLG1CQUFSLENBRnZCO0FBQUEsSUFHTUksa0JBQWtCSixRQUFRLG9CQUFSLENBSHhCO0FBQUEsSUFJTUssa0JBQWtCTCxRQUFRLG9CQUFSLENBSnhCO0FBQUEsSUFLTU0sc0JBQXNCTixRQUFRLHdCQUFSLENBTDVCOztJQU9RTyxLLEdBQVVSLE0sQ0FBVlEsSzs7SUFFRkMsTTs7Ozs7Ozs4QkFDYUMsVyxFQUFhO0FBQzVCLFVBQU1DLFFBQVFDLHFCQUFxQkYsV0FBckIsQ0FBZDtBQUFBLFVBQ01HLGFBQWFG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QVNHLDZCQUFULENBQXVDVixTQUF2QyxFQUFrRDlCLFdBQWxELEVBQStEO0FBQzdELE1BQU15RSx1QkFBdUIzQyxVQUFVNEMsY0FBVixFQUE3QjtBQUFBLE1BQ01FLGtCQUFrQkgsb0JBRHhCO0FBQUEsTUFDOEM7QUFDeENsQyxxQkFBbUJULFVBQVUwRCxjQUFWLENBQXlCLFVBQVNoRSxVQUFULEVBQXFCO0FBQ3JFLFFBQU1mLGlCQUFpQmUsVUFBdkI7QUFBQSxRQUFvQztBQUM5QmhCLGlCQUFhaEIsV0FBV3FCLGNBQVgsQ0FBMEJKLGNBQTFCLEVBQTBDVCxXQUExQyxDQURuQjtBQUFBLFFBRU1zRCxrQkFBa0IxRCxnQkFBZ0I2RixnQ0FBaEIsQ0FBaURqRixVQUFqRCxFQUE2RG9FLGVBQTdELENBRnhCOztBQUlBLFdBQU90QixlQUFQO0FBQ0QsR0FOd0IsQ0FGekI7O0FBVUEsU0FBT2YsZ0JBQVA7QUFDRDs7QUFFRCxTQUFTNEIsa0JBQVQsQ0FBNEJILG1CQUE1QixFQUFpREMsb0JBQWpELEVBQXVFNUIsZUFBdkUsRUFBd0Y7QUFDdEYsTUFBSXFELHNCQUFzQixJQUExQjs7QUFFQXJELGtCQUFnQnNELElBQWhCLENBQXFCLFVBQVM1QyxjQUFULEVBQXlCO0FBQzVDLFFBQU02QyxzQkFBc0I3QyxlQUFlOEMsd0JBQWYsQ0FBd0M3QixtQkFBeEMsRUFBNkRDLG9CQUE3RCxDQUE1Qjs7QUFFQSxRQUFJMkIsbUJBQUosRUFBeUI7QUFDdkJGLDRCQUFzQjNDLGNBQXRCOztBQUVBLGFBQU8sSUFBUDtBQUNEO0FBQ0YsR0FSRDs7QUFVQSxNQUFNQSxpQkFBaUIyQyxtQkFBdkIsQ0Fic0YsQ0FhMUM7O0FBRTVDLFNBQU8zQyxjQUFQO0FBQ0QiLCJmaWxlIjoiY3ljbGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCB0YXJqYW4gPSByZXF1aXJlKCdvY2NhbS10YXJqYW4nKTtcblxuY29uc3QgcGFyc2VyVXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwvcGFyc2VyJyksXG4gICAgICBQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi4vZXh0ZW5kZWRCTkYvcHJvZHVjdGlvbicpLFxuICAgICAgVW5pdFByb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vdW5pdCcpLFxuICAgICAgVW5pdHNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRzJyksXG4gICAgICBGaXhlZFByb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vZml4ZWQnKSxcbiAgICAgIE5vbkN5Y2xpY1Byb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vbm9uQ3ljbGljJyk7XG5cbmNvbnN0IHsgR3JhcGggfSA9IHRhcmphbjtcblxuY2xhc3MgY3ljbGVzIHtcbiAgc3RhdGljIGVsaW1pbmF0ZShwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IGdyYXBoID0gZ3JhcGhGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGNvbXBvbmVudHMgPSBncmFwaC5nZW5lcmF0ZUNvbXBvbmVudHMoKSxcbiAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9ucyA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMoY29tcG9uZW50cywgcHJvZHVjdGlvbnMpO1xuXG4gICAgcHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5tYXAoZnVuY3Rpb24ocHJvZHVjdGlvbikge1xuICAgICAgY29uc3QgcHJvZHVjdGlvbk5hbWUgPSBwcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lID0gcHJvZHVjdGlvbk5hbWUsIC8vL1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgIFxuICAgICAgaWYgKG5vbkN5Y2xpY1Byb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgICAgcHJvZHVjdGlvbiA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb247IC8vL1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lID0gcHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICAgICAgYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uTmFtZSwgcHJvZHVjdGlvbnMpOyAgLy8vXG5cbiAgICAgICAgcHJvZHVjdGlvbiA9IGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uOyAvLy9cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHByb2R1Y3Rpb247XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcHJvZHVjdGlvbnM7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBjeWNsZXM7XG5cbmZ1bmN0aW9uIGdyYXBoRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGdyYXBoID0gbmV3IEdyYXBoKCksXG4gICAgICAgIHVuaXRzUHJvZHVjdGlvbnMgPSB1bml0c1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKTtcblxuICB1bml0c1Byb2R1Y3Rpb25zLmZvckVhY2goZnVuY3Rpb24odW5pdHNQcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgcHJvZHVjdGlvbk5hbWUgPSB1bml0c1Byb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25OYW1lcyA9IHVuaXRzUHJvZHVjdGlvbi5nZXRVbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcygpLFxuICAgICAgICAgIHZlcnRleE5hbWUgPSBwcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyA9IHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25OYW1lczsgLy8vXG5cbiAgICBncmFwaC5hZGRWZXJ0ZXgodmVydGV4TmFtZSwgZGVzY2VuZGFudFZlcnRleE5hbWVzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIGdyYXBoO1xufVxuXG5mdW5jdGlvbiB1bml0c1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXRzUHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24odW5pdHNQcm9kdWN0aW9ucywgcHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXRzUHJvZHVjdGlvbiA9IFVuaXRzUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgIGlmICh1bml0c1Byb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIHVuaXRzUHJvZHVjdGlvbnMucHVzaCh1bml0c1Byb2R1Y3Rpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB1bml0c1Byb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRzUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMoY29tcG9uZW50cywgcHJvZHVjdGlvbnMpIHtcbiAgY29uc3Qgbm9uQ3ljbGljUHJvZHVjdGlvbnMgPSBjb21wb25lbnRzLnJlZHVjZShmdW5jdGlvbihub25DeWNsaWNQcm9kdWN0aW9ucywgY29tcG9uZW50KSB7XG4gICAgICAgICAgY29uc3QgY29tcG9uZW50Tm9uQ3ljbGljID0gY29tcG9uZW50LmlzTm9uQ3ljbGljKCk7XG5cbiAgICAgICAgICBpZiAoY29tcG9uZW50Tm9uQ3ljbGljKSB7XG4gICAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9uRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zO1xuICAgICAgICB9LCBbXSk7XG5cbiAgcmV0dXJuIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucykge1xuICBjb25zdCBmaXJzdFZlcnRleE5hbWUgPSBjb21wb25lbnQuZ2V0Rmlyc3RWZXJ0ZXhOYW1lKCksXG4gICAgICAgIHByb2R1Y3Rpb25OYW1lID0gZmlyc3RWZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgIHByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyk7XG5cbiAgaWYgKHByb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9uID0gTm9uQ3ljbGljUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLnB1c2gobm9uQ3ljbGljUHJvZHVjdGlvbik7XG4gIH1cbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXRQcm9kdWN0aW9ucyA9IHVuaXRQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucyksXG4gICAgICAgIGZpeGVkUHJvZHVjdGlvbnMgPSBmaXhlZFByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zKSxcbiAgICAgICAgYWRkZWRQcm9kdWN0aW9ucyA9IGFkZGVkUHJvZHVjdGlvbnNGcm9tVW5pdFByb2R1Y3Rpb25zQW5kRml4ZWRQcm9kdWN0aW9ucyh1bml0UHJvZHVjdGlvbnMsIGZpeGVkUHJvZHVjdGlvbnMpO1xuXG4gIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUZpeGVkUHJvZHVjdGlvbnNBbmRBZGRlZFByb2R1Y3Rpb25zKGZpeGVkUHJvZHVjdGlvbnMsIGFkZGVkUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbn1cblxuZnVuY3Rpb24gYWRkZWRQcm9kdWN0aW9uc0Zyb21Vbml0UHJvZHVjdGlvbnNBbmRGaXhlZFByb2R1Y3Rpb25zKHVuaXRQcm9kdWN0aW9ucywgZml4ZWRQcm9kdWN0aW9ucykge1xuICBjb25zdCBhZGRlZFByb2R1Y3Rpb25zID0gW10sXG4gICAgICAgIHJlbW92ZWRVbml0UHJvZHVjdGlvbnMgPSBbXTtcblxuICBsZXQgdW5pdFByb2R1Y3Rpb25zTGVuZ3RoID0gdW5pdFByb2R1Y3Rpb25zLmxlbmd0aDtcblxuICB3aGlsZSAodW5pdFByb2R1Y3Rpb25zTGVuZ3RoID4gMCkge1xuICAgIGxldCB1bml0UHJvZHVjdGlvbiA9IHVuaXRQcm9kdWN0aW9ucy5zaGlmdCgpLFxuICAgICAgICB1bml0UHJvZHVjdGlvbk5hbWUgPSB1bml0UHJvZHVjdGlvbi5nZXROYW1lKCk7XG5cbiAgICBjb25zdCByZW1vdmVkVW5pdFByb2R1Y3Rpb24gPSB1bml0UHJvZHVjdGlvbjsgLy8vXG5cbiAgICByZW1vdmVkVW5pdFByb2R1Y3Rpb25zLnB1c2gocmVtb3ZlZFVuaXRQcm9kdWN0aW9uKTtcblxuICAgIGNvbnN0IHVuaXRQcm9kdWN0aW9uVW5pdFByb2R1Y3Rpb25OYW1lID0gdW5pdFByb2R1Y3Rpb24uZ2V0VW5pdFByb2R1Y3Rpb25OYW1lKCksXG4gICAgICAgICAgZml4ZWRQcm9kdWN0aW9uTmFtZSA9IHVuaXRQcm9kdWN0aW9uVW5pdFByb2R1Y3Rpb25OYW1lLCAgLy8vXG4gICAgICAgICAgZml4ZWRQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihmaXhlZFByb2R1Y3Rpb25OYW1lLCBmaXhlZFByb2R1Y3Rpb25zKSxcbiAgICAgICAgICBhZGRlZFByb2R1Y3Rpb25OYW1lID0gdW5pdFByb2R1Y3Rpb25OYW1lOyAgLy8vXG5cbiAgICBsZXQgYWRkZWRQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhZGRlZFByb2R1Y3Rpb25OYW1lLCBhZGRlZFByb2R1Y3Rpb25zKTtcblxuICAgIGlmIChhZGRlZFByb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgIGFkZGVkUHJvZHVjdGlvbiA9IFByb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24oZml4ZWRQcm9kdWN0aW9uKTtcblxuICAgICAgYWRkZWRQcm9kdWN0aW9uLnNldE5hbWUoYWRkZWRQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICAgIGFkZGVkUHJvZHVjdGlvbnMucHVzaChhZGRlZFByb2R1Y3Rpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBmaXhlZFByb2R1Y3Rpb25EZWZpbml0aW9ucyA9IGZpeGVkUHJvZHVjdGlvbi5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICBhZGRlZFByb2R1Y3Rpb24uYWRkRGVmaW5pdGlvbnMoZml4ZWRQcm9kdWN0aW9uRGVmaW5pdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IGludGVybWVkaWF0ZVVuaXRQcm9kdWN0aW9uTmFtZSA9IHVuaXRQcm9kdWN0aW9uVW5pdFByb2R1Y3Rpb25OYW1lLCAvLy9cbiAgICAgICAgICBpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oaW50ZXJtZWRpYXRlVW5pdFByb2R1Y3Rpb25OYW1lLCB1bml0UHJvZHVjdGlvbnMpO1xuXG4gICAgaWYgKGludGVybWVkaWF0ZVVuaXRQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvblVuaXRQcm9kdWN0aW9uTmFtZSA9IGludGVybWVkaWF0ZVVuaXRQcm9kdWN0aW9uLmdldFVuaXRQcm9kdWN0aW9uTmFtZSgpLFxuICAgICAgICAgICAgZmlyc3RQcm9kdWN0aW9uTmFtZSA9IHVuaXRQcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgICAgc2Vjb25kUHJvZHVjdGlvbk5hbWUgPSBpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvblVuaXRQcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgICAgdW5pdFByb2R1Y3Rpb25Ob25DeWNsaWMgPSAoZmlyc3RQcm9kdWN0aW9uTmFtZSAhPT0gc2Vjb25kUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICBpZiAodW5pdFByb2R1Y3Rpb25Ob25DeWNsaWMpIHtcbiAgICAgICAgdW5pdFByb2R1Y3Rpb24gPSBmaW5kVW5pdFByb2R1Y3Rpb24oZmlyc3RQcm9kdWN0aW9uTmFtZSwgc2Vjb25kUHJvZHVjdGlvbk5hbWUsIHJlbW92ZWRVbml0UHJvZHVjdGlvbnMpO1xuXG4gICAgICAgIGlmICh1bml0UHJvZHVjdGlvbiA9PT0gbnVsbCkge1xuICAgICAgICAgIHVuaXRQcm9kdWN0aW9uID0gVW5pdFByb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb25OYW1lcyhmaXJzdFByb2R1Y3Rpb25OYW1lLCBzZWNvbmRQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICAgICAgICB1bml0UHJvZHVjdGlvbnMudW5zaGlmdCh1bml0UHJvZHVjdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB1bml0UHJvZHVjdGlvbnNMZW5ndGggPSB1bml0UHJvZHVjdGlvbnMubGVuZ3RoO1xuICB9XG5cbiAgcmV0dXJuIGFkZGVkUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUZpeGVkUHJvZHVjdGlvbnNBbmRBZGRlZFByb2R1Y3Rpb25zKGZpeGVkUHJvZHVjdGlvbnMsIGFkZGVkUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGZpeGVkUHJvZHVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbihmaXhlZFByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9uID0gZml4ZWRQcm9kdWN0aW9uLCAvLy9cbiAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9uTmFtZSA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIGFkZGVkUHJvZHVjdGlvbk5hbWUgPSBub25DeWNsaWNQcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgICAgYWRkZWRQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhZGRlZFByb2R1Y3Rpb25OYW1lLCBhZGRlZFByb2R1Y3Rpb25zKTtcblxuICAgIGlmIChhZGRlZFByb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGFkZGVkUHJvZHVjdGlvbkRlZmluaXRpb25zID0gYWRkZWRQcm9kdWN0aW9uLmdldERlZmluaXRpb25zKCk7XG5cbiAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb24uYWRkRGVmaW5pdGlvbnMoYWRkZWRQcm9kdWN0aW9uRGVmaW5pdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IG5vbkN5Y2xpY1Byb2R1Y3Rpb25EZWZpbml0aW9uc0V4aXN0ID0gbm9uQ3ljbGljUHJvZHVjdGlvbi5kb0RlZmluaXRpb25zRXhpc3QoKTtcblxuICAgIGlmIChub25DeWNsaWNQcm9kdWN0aW9uRGVmaW5pdGlvbnNFeGlzdCkge1xuICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnMucHVzaChub25DeWNsaWNQcm9kdWN0aW9uKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiB1bml0UHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgY29tcG9uZW50VmVydGV4TmFtZXMgPSBjb21wb25lbnQuZ2V0VmVydGV4TmFtZXMoKSxcbiAgICAgICAgdW5pdHNQcm9kdWN0aW9ucyA9IHVuaXRzUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMpLFxuICAgICAgICBwcm9kdWN0aW9uTmFtZXMgPSBjb21wb25lbnRWZXJ0ZXhOYW1lcywgIC8vL1xuICAgICAgICB1bml0UHJvZHVjdGlvbnMgPSB1bml0UHJvZHVjdGlvbnNGcm9tVW5pdHNQcm9kdWN0aW9uc0FuZFByb2R1Y3Rpb25OYW1lcyh1bml0c1Byb2R1Y3Rpb25zLCBwcm9kdWN0aW9uTmFtZXMpO1xuXG4gIHJldHVybiB1bml0UHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIHVuaXRzUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdHNQcm9kdWN0aW9ucyA9IGNvbXBvbmVudC5yZWR1Y2VWZXJ0ZXhOYW1lcyhmdW5jdGlvbih1bml0c1Byb2R1Y3Rpb25zLCB2ZXJ0ZXhOYW1lKSB7XG4gICAgY29uc3QgcHJvZHVjdGlvbk5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgcHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24ocHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKSxcbiAgICAgICAgICB1bml0c1Byb2R1Y3Rpb24gPSBVbml0c1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG5cbiAgICBpZiAodW5pdHNQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICB1bml0c1Byb2R1Y3Rpb25zLnB1c2godW5pdHNQcm9kdWN0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5pdHNQcm9kdWN0aW9ucztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0c1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiB1bml0UHJvZHVjdGlvbnNGcm9tVW5pdHNQcm9kdWN0aW9uc0FuZFByb2R1Y3Rpb25OYW1lcyh1bml0c1Byb2R1Y3Rpb25zLCBwcm9kdWN0aW9uTmFtZXMpIHtcbiAgY29uc3QgdW5pdFByb2R1Y3Rpb25zID0gdW5pdHNQcm9kdWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24odW5pdFByb2R1Y3Rpb25zLCB1bml0c1Byb2R1Y3Rpb24pIHtcbiAgICBjb25zdCB1bml0c1Byb2R1Y3Rpb25OYW1lID0gdW5pdHNQcm9kdWN0aW9uLmdldE5hbWUoKTtcblxuICAgIHVuaXRzUHJvZHVjdGlvbi5mb3JFYWNoVW5pdERlZmluaXRpb24oZnVuY3Rpb24odW5pdERlZmluaXRpb24pIHtcbiAgICAgIGNvbnN0IG5hbWUgPSB1bml0c1Byb2R1Y3Rpb25OYW1lLCAvLy9cbiAgICAgICAgICAgIHVuaXRQcm9kdWN0aW9uID0gVW5pdFByb2R1Y3Rpb24uZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbihuYW1lLCB1bml0RGVmaW5pdGlvbiksXG4gICAgICAgICAgICB1bml0UHJvZHVjdGlvbk5vdEN5Y2xpYyA9IHVuaXRQcm9kdWN0aW9uLmlzTm90Q3ljbGljKCksXG4gICAgICAgICAgICB1bml0UHJvZHVjdGlvbkluY2x1ZGVkSW5Qcm9kdWN0aW9uTmFtZXMgPSB1bml0UHJvZHVjdGlvbi5pc0luY2x1ZGVkSW5Qcm9kdWN0aW9uTmFtZXMocHJvZHVjdGlvbk5hbWVzKTtcbiAgICAgIFxuICAgICAgaWYgKHVuaXRQcm9kdWN0aW9uTm90Q3ljbGljICYmIHVuaXRQcm9kdWN0aW9uSW5jbHVkZWRJblByb2R1Y3Rpb25OYW1lcykge1xuICAgICAgICB1bml0UHJvZHVjdGlvbnMucHVzaCh1bml0UHJvZHVjdGlvbik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdW5pdFByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gZml4ZWRQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBjb21wb25lbnRWZXJ0ZXhOYW1lcyA9IGNvbXBvbmVudC5nZXRWZXJ0ZXhOYW1lcygpLFxuICAgICAgICBwcm9kdWN0aW9uTmFtZXMgPSBjb21wb25lbnRWZXJ0ZXhOYW1lcywgLy8vXG4gICAgICAgIGZpeGVkUHJvZHVjdGlvbnMgPSBjb21wb25lbnQubWFwVmVydGV4TmFtZXMoZnVuY3Rpb24odmVydGV4TmFtZSkge1xuICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gdmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyksXG4gICAgICAgICAgZml4ZWRQcm9kdWN0aW9uID0gRml4ZWRQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uQW5kUHJvZHVjdGlvbk5hbWVzKHByb2R1Y3Rpb24sIHByb2R1Y3Rpb25OYW1lcyk7XG5cbiAgICByZXR1cm4gZml4ZWRQcm9kdWN0aW9uO1xuICB9KTtcblxuICByZXR1cm4gZml4ZWRQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gZmluZFVuaXRQcm9kdWN0aW9uKGZpcnN0UHJvZHVjdGlvbk5hbWUsIHNlY29uZFByb2R1Y3Rpb25OYW1lLCB1bml0UHJvZHVjdGlvbnMpIHtcbiAgbGV0IGZvdW5kVW5pdFByb2R1Y3Rpb24gPSBudWxsO1xuXG4gIHVuaXRQcm9kdWN0aW9ucy5zb21lKGZ1bmN0aW9uKHVuaXRQcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgdW5pdFByb2R1Y3Rpb25Gb3VuZCA9IHVuaXRQcm9kdWN0aW9uLmlzRm91bmRCeVByb2R1Y3Rpb25OYW1lcyhmaXJzdFByb2R1Y3Rpb25OYW1lLCBzZWNvbmRQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICBpZiAodW5pdFByb2R1Y3Rpb25Gb3VuZCkge1xuICAgICAgZm91bmRVbml0UHJvZHVjdGlvbiA9IHVuaXRQcm9kdWN0aW9uO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHVuaXRQcm9kdWN0aW9uID0gZm91bmRVbml0UHJvZHVjdGlvbjsgLy8vXG5cbiAgcmV0dXJuIHVuaXRQcm9kdWN0aW9uO1xufVxuIl19