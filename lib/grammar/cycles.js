'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var tarjan = require('occam-tarjan');

var parserUtil = require('../util/parser'),
    Production = require('../common/production'),
    UnitRuleProduction = require('./production/unitRule'),
    UnitRulesProduction = require('./production/unitRules'),
    NonUnitRulesProduction = require('./production/nonUnitRules');

var Graph = tarjan.Graph;

var cycles = function () {
  function cycles() {
    _classCallCheck(this, cycles);
  }

  _createClass(cycles, null, [{
    key: 'eliminate',
    value: function eliminate(productions) {
      var graph = graphFromProductions(productions),
          components = graph.generateComponents(),
          nonCyclicProductions = nonCyclicProductionsFromComponents(components, productions),
          alreadyNonCyclicProductions = alreadyNonCyclicProductionsFromGraph(graph, productions);

      productions = [].concat(nonCyclicProductions).concat(alreadyNonCyclicProductions);

      return productions;
    }
  }]);

  return cycles;
}();

module.exports = cycles;

function graphFromProductions(productions) {
  var unitRulesProductions = unitRulesProductionsFromProductions(productions),
      graph = graphFromUnitRulesProductions(unitRulesProductions);

  return graph;
}

function unitRulesProductionsFromProductions(productions) {
  var unitRulesProductions = productions.reduce(function (unitRulesProductions, production) {
    var unitRulesProduction = UnitRulesProduction.fromProduction(production);

    if (unitRulesProduction !== null) {
      unitRulesProductions.push(unitRulesProduction);
    }

    return unitRulesProductions;
  }, []);

  return unitRulesProductions;
}

function graphFromUnitRulesProductions(unitRulesProductions) {
  var graph = new Graph();

  unitRulesProductions.forEach(function (unitRulesProduction) {
    var productionName = unitRulesProduction.getName(),
        productionNames = unitRulesProduction.getProductionNames(),
        vertexName = productionName,
        ///
    descendantVertexNames = productionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function nonCyclicProductionsFromComponents(components, productions) {
  var nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      nonCyclicProductionFromComponent(component, productions, nonCyclicProductions);
    } else {
      nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function alreadyNonCyclicProductionsFromGraph(graph, productions) {
  var alreadyNonCyclicProductions = productions.filter(function (production) {
    var productionName = production.getName(),
        vertexName = productionName,
        ///
    vertexPresent = graph.isVertexPresent(vertexName),
        productionAlreadyNonCyclic = !vertexPresent; ///

    return productionAlreadyNonCyclic;
  });

  return alreadyNonCyclicProductions;
}

function nonCyclicProductionFromComponent(component, productions, nonCyclicProductions) {
  var firstVertex = component.getFirstVertex(),
      firstVertexName = firstVertex.getName(),
      nonCyclicProductionName = firstVertexName,
      ///
  nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, productions);

  nonCyclicProductions.push(nonCyclicProduction);
}

function nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions) {
  productions = productionsFromComponent(component, productions); ///

  var fixedProductions = fixedProductionsFromProductions(productions),
      unitRuleProductions = unitRuleProductionsFromProductions(productions),
      removedProductions = [],
      addedProductions = [];

  var unitRuleProductionsLength = unitRuleProductions.length;

  while (unitRuleProductionsLength > 0) {
    var unitRuleProduction = unitRuleProductions.shift(),
        unitRuleProductionName = unitRuleProduction.getName();

    var removedProduction = unitRuleProduction;

    removedProductions.push(removedProduction);

    var unitRuleProductionUnitRuleProductionName = unitRuleProduction.getUnitRuleProductionName(),
        fixedProductionName = unitRuleProductionUnitRuleProductionName,
        ///
    addedProductionName = unitRuleProductionName,
        ///
    fixedProduction = parserUtil.findProduction(fixedProductionName, fixedProductions);

    var addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction === null) {
      addedProduction = Production.fromProduction(fixedProduction);

      addedProduction.setName(addedProductionName);

      addedProductions.push(addedProduction);
    } else {
      var fixedProductionRules = fixedProduction.getRules();

      addedProduction.concatRules(fixedProductionRules);
    }

    var intermediateProductionName = unitRuleProductionUnitRuleProductionName,
        ///
    intermediateProduction = parserUtil.findProduction(intermediateProductionName, unitRuleProductions);

    if (intermediateProduction !== null) {
      var intermediateProductionUnitRuleProductionName = intermediateProduction.getUnitRuleProductionName(),
          _unitRuleProductionUnitRuleProductionName = intermediateProductionUnitRuleProductionName,
          ///
      unitRuleProductionNonCyclic = unitRuleProductionName !== _unitRuleProductionUnitRuleProductionName;

      if (unitRuleProductionNonCyclic) {
        unitRuleProduction = findUnitRuleProduction(unitRuleProductionName, _unitRuleProductionUnitRuleProductionName, removedProductions);

        if (unitRuleProduction === null) {
          unitRuleProduction = UnitRuleProduction.fromNameAndUnitRuleProductionName(unitRuleProductionName, _unitRuleProductionUnitRuleProductionName);

          unitRuleProductions.unshift(unitRuleProduction);
        }
      }
    }

    unitRuleProductionsLength = unitRuleProductions.length;
  }

  nonCyclicProductionsFromFixedAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions);
}

function nonCyclicProductionsFromFixedAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions) {
  fixedProductions.forEach(function (fixedProduction) {
    var nonCyclicProduction = fixedProduction,
        ///
    nonCyclicProductionName = nonCyclicProduction.getName(),
        addedProductionName = nonCyclicProductionName,
        ///
    addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction !== null) {
      var addedProductionRules = addedProduction.getRules();

      nonCyclicProduction.concatRules(addedProductionRules);
    }

    nonCyclicProductions.push(nonCyclicProduction);
  });
}

function productionsFromComponent(component, productions) {
  productions = component.mapVertices(function (vertex) {
    var vertexName = vertex.getName(),
        productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions);

    return production;
  });

  return productions;
}

function unitRuleProductionsFromProductions(productions) {
  var unitRuleProductions = productions.reduce(function (unitRuleProductions, production) {
    var name = production.getName(),
        unitRulesProduction = UnitRulesProduction.fromProduction(production);

    unitRulesProduction.forEachUnitRule(function (unitRule) {
      var unitRuleProduction = UnitRuleProduction.fromNameAndUnitRule(name, unitRule);

      unitRuleProductions.push(unitRuleProduction);
    });

    return unitRuleProductions;
  }, []);

  return unitRuleProductions;
}

function fixedProductionsFromProductions(productions) {
  var fixedProductions = productions.map(function (production) {
    var nonUnitProduction = NonUnitRulesProduction.fromProduction(production),
        fixedProduction = nonUnitProduction; ///

    return fixedProduction;
  });

  return fixedProductions;
}

function findUnitRuleProduction(productionName, unitRuleProductionName, unitRuleProductions) {
  var firstProductionName = productionName,
      ///
  secondProductionName = unitRuleProductionName; ///

  var foundUnitRuleProduction = null;

  unitRuleProductions.some(function (unitRuleProduction) {
    var unitRuleProductionFound = unitRuleProduction.isFoundByProductionNames(firstProductionName, secondProductionName);

    if (unitRuleProductionFound) {
      foundUnitRuleProduction = unitRuleProduction;

      return true;
    }
  });

  var unitRuleProduction = foundUnitRuleProduction; ///

  return unitRuleProduction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL2N5Y2xlcy5qcyJdLCJuYW1lcyI6WyJ0YXJqYW4iLCJyZXF1aXJlIiwicGFyc2VyVXRpbCIsIlByb2R1Y3Rpb24iLCJVbml0UnVsZVByb2R1Y3Rpb24iLCJVbml0UnVsZXNQcm9kdWN0aW9uIiwiTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiIsIkdyYXBoIiwiY3ljbGVzIiwicHJvZHVjdGlvbnMiLCJncmFwaCIsImdyYXBoRnJvbVByb2R1Y3Rpb25zIiwiY29tcG9uZW50cyIsImdlbmVyYXRlQ29tcG9uZW50cyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zIiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyIsImFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9ucyIsImFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uc0Zyb21HcmFwaCIsImNvbmNhdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJ1bml0UnVsZXNQcm9kdWN0aW9ucyIsInVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwiZ3JhcGhGcm9tVW5pdFJ1bGVzUHJvZHVjdGlvbnMiLCJyZWR1Y2UiLCJwcm9kdWN0aW9uIiwidW5pdFJ1bGVzUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uIiwicHVzaCIsImZvckVhY2giLCJwcm9kdWN0aW9uTmFtZSIsImdldE5hbWUiLCJwcm9kdWN0aW9uTmFtZXMiLCJnZXRQcm9kdWN0aW9uTmFtZXMiLCJ2ZXJ0ZXhOYW1lIiwiZGVzY2VuZGFudFZlcnRleE5hbWVzIiwiYWRkVmVydGV4IiwiY29tcG9uZW50IiwiY29tcG9uZW50Tm9uQ3ljbGljIiwiaXNOb25DeWNsaWMiLCJub25DeWNsaWNQcm9kdWN0aW9uRnJvbUNvbXBvbmVudCIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImZpbHRlciIsInZlcnRleFByZXNlbnQiLCJpc1ZlcnRleFByZXNlbnQiLCJwcm9kdWN0aW9uQWxyZWFkeU5vbkN5Y2xpYyIsImZpcnN0VmVydGV4IiwiZ2V0Rmlyc3RWZXJ0ZXgiLCJmaXJzdFZlcnRleE5hbWUiLCJub25DeWNsaWNQcm9kdWN0aW9uTmFtZSIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb24iLCJmaW5kUHJvZHVjdGlvbiIsInByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImZpeGVkUHJvZHVjdGlvbnMiLCJmaXhlZFByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwidW5pdFJ1bGVQcm9kdWN0aW9ucyIsInVuaXRSdWxlUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMiLCJyZW1vdmVkUHJvZHVjdGlvbnMiLCJhZGRlZFByb2R1Y3Rpb25zIiwidW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCIsImxlbmd0aCIsInVuaXRSdWxlUHJvZHVjdGlvbiIsInNoaWZ0IiwidW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsInJlbW92ZWRQcm9kdWN0aW9uIiwidW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsImdldFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJmaXhlZFByb2R1Y3Rpb25OYW1lIiwiYWRkZWRQcm9kdWN0aW9uTmFtZSIsImZpeGVkUHJvZHVjdGlvbiIsImFkZGVkUHJvZHVjdGlvbiIsInNldE5hbWUiLCJmaXhlZFByb2R1Y3Rpb25SdWxlcyIsImdldFJ1bGVzIiwiY29uY2F0UnVsZXMiLCJpbnRlcm1lZGlhdGVQcm9kdWN0aW9uTmFtZSIsImludGVybWVkaWF0ZVByb2R1Y3Rpb24iLCJpbnRlcm1lZGlhdGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsInVuaXRSdWxlUHJvZHVjdGlvbk5vbkN5Y2xpYyIsImZpbmRVbml0UnVsZVByb2R1Y3Rpb24iLCJmcm9tTmFtZUFuZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJ1bnNoaWZ0Iiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tRml4ZWRBbmRBZGRlZFByb2R1Y3Rpb25zIiwiYWRkZWRQcm9kdWN0aW9uUnVsZXMiLCJtYXBWZXJ0aWNlcyIsInZlcnRleCIsIm5hbWUiLCJmb3JFYWNoVW5pdFJ1bGUiLCJ1bml0UnVsZSIsImZyb21OYW1lQW5kVW5pdFJ1bGUiLCJtYXAiLCJub25Vbml0UHJvZHVjdGlvbiIsImZpcnN0UHJvZHVjdGlvbk5hbWUiLCJzZWNvbmRQcm9kdWN0aW9uTmFtZSIsImZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uIiwic29tZSIsInVuaXRSdWxlUHJvZHVjdGlvbkZvdW5kIiwiaXNGb3VuZEJ5UHJvZHVjdGlvbk5hbWVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsU0FBU0MsUUFBUSxjQUFSLENBQWY7O0FBRUEsSUFBTUMsYUFBYUQsUUFBUSxnQkFBUixDQUFuQjtBQUFBLElBQ01FLGFBQWFGLFFBQVEsc0JBQVIsQ0FEbkI7QUFBQSxJQUVNRyxxQkFBcUJILFFBQVEsdUJBQVIsQ0FGM0I7QUFBQSxJQUdNSSxzQkFBc0JKLFFBQVEsd0JBQVIsQ0FINUI7QUFBQSxJQUlNSyx5QkFBeUJMLFFBQVEsMkJBQVIsQ0FKL0I7O0lBTVFNLEssR0FBVVAsTSxDQUFWTyxLOztJQUVGQyxNOzs7Ozs7OzhCQUNhQyxXLEVBQWE7QUFDNUIsVUFBTUMsUUFBUUMscUJBQXFCRixXQUFyQixDQUFkO0FBQUEsVUFDTUcsYUFBYUYsTUFBTUcsa0JBQU4sRUFEbkI7QUFBQSxVQUVNQyx1QkFBdUJDLG1DQUFtQ0gsVUFBbkMsRUFBK0NILFdBQS9DLENBRjdCO0FBQUEsVUFHTU8sOEJBQThCQyxxQ0FBcUNQLEtBQXJDLEVBQTRDRCxXQUE1QyxDQUhwQzs7QUFLQUEsb0JBQWMsR0FBR1MsTUFBSCxDQUFVSixvQkFBVixFQUFnQ0ksTUFBaEMsQ0FBdUNGLDJCQUF2QyxDQUFkOztBQUVBLGFBQU9QLFdBQVA7QUFDRDs7Ozs7O0FBR0hVLE9BQU9DLE9BQVAsR0FBaUJaLE1BQWpCOztBQUVBLFNBQVNHLG9CQUFULENBQThCRixXQUE5QixFQUEyQztBQUN6QyxNQUFNWSx1QkFBdUJDLG9DQUFvQ2IsV0FBcEMsQ0FBN0I7QUFB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QW9CckYsdUJBQXVCcUIsY0FBdkIsQ0FBc0NGLFVBQXRDLENBQTFCO0FBQUEsUUFDTTRDLGtCQUFrQnNCLGlCQUR4QixDQUQ0RCxDQUVqQjs7QUFFM0MsV0FBT3RCLGVBQVA7QUFDRCxHQUx3QixDQUF6Qjs7QUFPQSxTQUFPaEIsZ0JBQVA7QUFDRDs7QUFFRCxTQUFTMEIsc0JBQVQsQ0FBZ0NqRCxjQUFoQyxFQUFnRGlDLHNCQUFoRCxFQUF3RVIsbUJBQXhFLEVBQTZGO0FBQzNGLE1BQU1xQyxzQkFBc0I5RCxjQUE1QjtBQUFBLE1BQTRDO0FBQ3RDK0QseUJBQXVCOUIsc0JBRDdCLENBRDJGLENBRXJDOztBQUV0RCxNQUFJK0IsMEJBQTBCLElBQTlCOztBQUVBdkMsc0JBQW9Cd0MsSUFBcEIsQ0FBeUIsVUFBU2xDLGtCQUFULEVBQTZCO0FBQ3BELFFBQU1tQywwQkFBMEJuQyxtQkFBbUJvQyx3QkFBbkIsQ0FBNENMLG1CQUE1QyxFQUFpRUMsb0JBQWpFLENBQWhDOztBQUVBLFFBQUlHLHVCQUFKLEVBQTZCO0FBQzNCRixnQ0FBMEJqQyxrQkFBMUI7O0FBRUEsYUFBTyxJQUFQO0FBQ0Q7QUFDRixHQVJEOztBQVVBLE1BQU1BLHFCQUFxQmlDLHVCQUEzQixDQWhCMkYsQ0FnQnZDOztBQUVwRCxTQUFPakMsa0JBQVA7QUFDRCIsImZpbGUiOiJjeWNsZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHRhcmphbiA9IHJlcXVpcmUoJ29jY2FtLXRhcmphbicpO1xuXG5jb25zdCBwYXJzZXJVdGlsID0gcmVxdWlyZSgnLi4vdXRpbC9wYXJzZXInKSxcbiAgICAgIFByb2R1Y3Rpb24gPSByZXF1aXJlKCcuLi9jb21tb24vcHJvZHVjdGlvbicpLFxuICAgICAgVW5pdFJ1bGVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlJyksXG4gICAgICBVbml0UnVsZXNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlcycpLFxuICAgICAgTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9ub25Vbml0UnVsZXMnKTtcblxuY29uc3QgeyBHcmFwaCB9ID0gdGFyamFuO1xuXG5jbGFzcyBjeWNsZXMge1xuICBzdGF0aWMgZWxpbWluYXRlKHByb2R1Y3Rpb25zKSB7XG4gICAgY29uc3QgZ3JhcGggPSBncmFwaEZyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucyksXG4gICAgICAgICAgY29tcG9uZW50cyA9IGdyYXBoLmdlbmVyYXRlQ29tcG9uZW50cygpLFxuICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucyksXG4gICAgICAgICAgYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUdyYXBoKGdyYXBoLCBwcm9kdWN0aW9ucyk7XG5cbiAgICBwcm9kdWN0aW9ucyA9IFtdLmNvbmNhdChub25DeWNsaWNQcm9kdWN0aW9ucykuY29uY2F0KGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9ucyk7XG5cbiAgICByZXR1cm4gcHJvZHVjdGlvbnM7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBjeWNsZXM7XG5cbmZ1bmN0aW9uIGdyYXBoRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25zID0gdW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICBncmFwaCA9IGdyYXBoRnJvbVVuaXRSdWxlc1Byb2R1Y3Rpb25zKHVuaXRSdWxlc1Byb2R1Y3Rpb25zKTtcblxuICByZXR1cm4gZ3JhcGg7XG59XG5cbmZ1bmN0aW9uIHVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRSdWxlc1Byb2R1Y3Rpb25zLCBwcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgdW5pdFJ1bGVzUHJvZHVjdGlvbiA9IFVuaXRSdWxlc1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG5cbiAgICBpZiAodW5pdFJ1bGVzUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgdW5pdFJ1bGVzUHJvZHVjdGlvbnMucHVzaCh1bml0UnVsZXNQcm9kdWN0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5pdFJ1bGVzUHJvZHVjdGlvbnM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gdW5pdFJ1bGVzUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGdyYXBoRnJvbVVuaXRSdWxlc1Byb2R1Y3Rpb25zKHVuaXRSdWxlc1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGdyYXBoID0gbmV3IEdyYXBoKCk7XG5cbiAgdW5pdFJ1bGVzUHJvZHVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbih1bml0UnVsZXNQcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgcHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZXNQcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICBwcm9kdWN0aW9uTmFtZXMgPSB1bml0UnVsZXNQcm9kdWN0aW9uLmdldFByb2R1Y3Rpb25OYW1lcygpLFxuICAgICAgICAgIHZlcnRleE5hbWUgPSBwcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyA9IHByb2R1Y3Rpb25OYW1lczsgLy8vXG5cbiAgICBncmFwaC5hZGRWZXJ0ZXgodmVydGV4TmFtZSwgZGVzY2VuZGFudFZlcnRleE5hbWVzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIGdyYXBoO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnRzKGNvbXBvbmVudHMsIHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gY29tcG9uZW50cy5yZWR1Y2UoZnVuY3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbnMsIGNvbXBvbmVudCkge1xuICAgICAgICAgIGNvbnN0IGNvbXBvbmVudE5vbkN5Y2xpYyA9IGNvbXBvbmVudC5pc05vbkN5Y2xpYygpO1xuXG4gICAgICAgICAgaWYgKGNvbXBvbmVudE5vbkN5Y2xpYykge1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbkZyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBub25DeWNsaWNQcm9kdWN0aW9ucztcbiAgICAgICAgfSwgW10pO1xuXG4gIHJldHVybiBub25DeWNsaWNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUdyYXBoKGdyYXBoLCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5maWx0ZXIoZnVuY3Rpb24ocHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gcHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgdmVydGV4TmFtZSA9IHByb2R1Y3Rpb25OYW1lLCAgLy8vXG4gICAgICAgICAgdmVydGV4UHJlc2VudCA9IGdyYXBoLmlzVmVydGV4UHJlc2VudCh2ZXJ0ZXhOYW1lKSxcbiAgICAgICAgICBwcm9kdWN0aW9uQWxyZWFkeU5vbkN5Y2xpYyA9ICF2ZXJ0ZXhQcmVzZW50OyAvLy9cbiAgICBcbiAgICByZXR1cm4gcHJvZHVjdGlvbkFscmVhZHlOb25DeWNsaWM7XG4gIH0pO1xuXG4gIHJldHVybiBhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0VmVydGV4ID0gY29tcG9uZW50LmdldEZpcnN0VmVydGV4KCksXG4gICAgICAgIGZpcnN0VmVydGV4TmFtZSA9IGZpcnN0VmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUgPSBmaXJzdFZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTtcblxuICBub25DeWNsaWNQcm9kdWN0aW9ucy5wdXNoKG5vbkN5Y2xpY1Byb2R1Y3Rpb24pO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgcHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucyk7IC8vL1xuXG4gIGNvbnN0IGZpeGVkUHJvZHVjdGlvbnMgPSBmaXhlZFByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9ucyA9IHVuaXRSdWxlUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICByZW1vdmVkUHJvZHVjdGlvbnMgPSBbXSxcbiAgICAgICAgYWRkZWRQcm9kdWN0aW9ucyA9IFtdO1xuXG4gIGxldCB1bml0UnVsZVByb2R1Y3Rpb25zTGVuZ3RoID0gdW5pdFJ1bGVQcm9kdWN0aW9ucy5sZW5ndGg7XG5cbiAgd2hpbGUgKHVuaXRSdWxlUHJvZHVjdGlvbnNMZW5ndGggPiAwKSB7XG4gICAgbGV0IHVuaXRSdWxlUHJvZHVjdGlvbiA9IHVuaXRSdWxlUHJvZHVjdGlvbnMuc2hpZnQoKSxcbiAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSA9IHVuaXRSdWxlUHJvZHVjdGlvbi5nZXROYW1lKCk7XG5cbiAgICBjb25zdCByZW1vdmVkUHJvZHVjdGlvbiA9IHVuaXRSdWxlUHJvZHVjdGlvbjtcblxuICAgIHJlbW92ZWRQcm9kdWN0aW9ucy5wdXNoKHJlbW92ZWRQcm9kdWN0aW9uKTtcblxuICAgIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZVByb2R1Y3Rpb24uZ2V0VW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSgpLFxuICAgICAgICAgIGZpeGVkUHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lLCAgLy8vXG4gICAgICAgICAgYWRkZWRQcm9kdWN0aW9uTmFtZSA9IHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBmaXhlZFByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKGZpeGVkUHJvZHVjdGlvbk5hbWUsIGZpeGVkUHJvZHVjdGlvbnMpO1xuXG4gICAgbGV0IGFkZGVkUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oYWRkZWRQcm9kdWN0aW9uTmFtZSwgYWRkZWRQcm9kdWN0aW9ucyk7XG5cbiAgICBpZiAoYWRkZWRQcm9kdWN0aW9uID09PSBudWxsKSB7XG4gICAgICBhZGRlZFByb2R1Y3Rpb24gPSBQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKGZpeGVkUHJvZHVjdGlvbik7XG5cbiAgICAgIGFkZGVkUHJvZHVjdGlvbi5zZXROYW1lKGFkZGVkUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICBhZGRlZFByb2R1Y3Rpb25zLnB1c2goYWRkZWRQcm9kdWN0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZml4ZWRQcm9kdWN0aW9uUnVsZXMgPSBmaXhlZFByb2R1Y3Rpb24uZ2V0UnVsZXMoKTtcblxuICAgICAgYWRkZWRQcm9kdWN0aW9uLmNvbmNhdFJ1bGVzKGZpeGVkUHJvZHVjdGlvblJ1bGVzKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnRlcm1lZGlhdGVQcm9kdWN0aW9uTmFtZSA9IHVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIC8vL1xuICAgICAgICAgIGludGVybWVkaWF0ZVByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKGludGVybWVkaWF0ZVByb2R1Y3Rpb25OYW1lLCB1bml0UnVsZVByb2R1Y3Rpb25zKTtcblxuICAgIGlmIChpbnRlcm1lZGlhdGVQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBpbnRlcm1lZGlhdGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSA9IGludGVybWVkaWF0ZVByb2R1Y3Rpb24uZ2V0VW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSgpLFxuICAgICAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSA9IGludGVybWVkaWF0ZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lLCAgLy8vXG4gICAgICAgICAgICB1bml0UnVsZVByb2R1Y3Rpb25Ob25DeWNsaWMgPSAodW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSAhPT0gdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb25Ob25DeWNsaWMpIHtcbiAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9uID0gZmluZFVuaXRSdWxlUHJvZHVjdGlvbih1bml0UnVsZVByb2R1Y3Rpb25OYW1lLCB1bml0UnVsZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lLCByZW1vdmVkUHJvZHVjdGlvbnMpO1xuXG4gICAgICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgICAgICB1bml0UnVsZVByb2R1Y3Rpb24gPSBVbml0UnVsZVByb2R1Y3Rpb24uZnJvbU5hbWVBbmRVbml0UnVsZVByb2R1Y3Rpb25OYW1lKHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9ucy51bnNoaWZ0KHVuaXRSdWxlUHJvZHVjdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB1bml0UnVsZVByb2R1Y3Rpb25zTGVuZ3RoID0gdW5pdFJ1bGVQcm9kdWN0aW9ucy5sZW5ndGg7XG4gIH1cblxuICBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZEFuZEFkZGVkUHJvZHVjdGlvbnMoZml4ZWRQcm9kdWN0aW9ucywgYWRkZWRQcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZEFuZEFkZGVkUHJvZHVjdGlvbnMoZml4ZWRQcm9kdWN0aW9ucywgYWRkZWRQcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgZml4ZWRQcm9kdWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGZpeGVkUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IG5vbkN5Y2xpY1Byb2R1Y3Rpb24gPSBmaXhlZFByb2R1Y3Rpb24sIC8vL1xuICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lID0gbm9uQ3ljbGljUHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgYWRkZWRQcm9kdWN0aW9uTmFtZSA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lLCAvLy9cbiAgICAgICAgICBhZGRlZFByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKGFkZGVkUHJvZHVjdGlvbk5hbWUsIGFkZGVkUHJvZHVjdGlvbnMpO1xuXG4gICAgaWYgKGFkZGVkUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgYWRkZWRQcm9kdWN0aW9uUnVsZXMgPSBhZGRlZFByb2R1Y3Rpb24uZ2V0UnVsZXMoKTtcblxuICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbi5jb25jYXRSdWxlcyhhZGRlZFByb2R1Y3Rpb25SdWxlcyk7XG4gICAgfVxuXG4gICAgbm9uQ3ljbGljUHJvZHVjdGlvbnMucHVzaChub25DeWNsaWNQcm9kdWN0aW9uKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zKSB7XG4gIHByb2R1Y3Rpb25zID0gY29tcG9uZW50Lm1hcFZlcnRpY2VzKGZ1bmN0aW9uKHZlcnRleCkge1xuICAgIGNvbnN0IHZlcnRleE5hbWUgPSB2ZXJ0ZXguZ2V0TmFtZSgpLFxuICAgICAgICAgIHByb2R1Y3Rpb25OYW1lID0gdmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyk7XG5cbiAgICByZXR1cm4gcHJvZHVjdGlvbjtcbiAgfSk7XG5cbiAgcmV0dXJuIHByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiB1bml0UnVsZVByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24odW5pdFJ1bGVQcm9kdWN0aW9ucywgcHJvZHVjdGlvbikge1xuICAgIGNvbnN0IG5hbWUgPSBwcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICB1bml0UnVsZXNQcm9kdWN0aW9uID0gVW5pdFJ1bGVzUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgIHVuaXRSdWxlc1Byb2R1Y3Rpb24uZm9yRWFjaFVuaXRSdWxlKGZ1bmN0aW9uKHVuaXRSdWxlKSB7XG4gICAgICBjb25zdCB1bml0UnVsZVByb2R1Y3Rpb24gPSBVbml0UnVsZVByb2R1Y3Rpb24uZnJvbU5hbWVBbmRVbml0UnVsZShuYW1lLCB1bml0UnVsZSk7XG5cbiAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbnMucHVzaCh1bml0UnVsZVByb2R1Y3Rpb24pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVuaXRSdWxlUHJvZHVjdGlvbnM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gdW5pdFJ1bGVQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gZml4ZWRQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCBmaXhlZFByb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMubWFwKGZ1bmN0aW9uKHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBub25Vbml0UHJvZHVjdGlvbiA9IE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbiksXG4gICAgICAgICAgZml4ZWRQcm9kdWN0aW9uID0gbm9uVW5pdFByb2R1Y3Rpb247IC8vL1xuICAgIFxuICAgIHJldHVybiBmaXhlZFByb2R1Y3Rpb247XG4gIH0pO1xuICBcbiAgcmV0dXJuIGZpeGVkUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGZpbmRVbml0UnVsZVByb2R1Y3Rpb24ocHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgZmlyc3RQcm9kdWN0aW9uTmFtZSA9IHByb2R1Y3Rpb25OYW1lLCAvLy9cbiAgICAgICAgc2Vjb25kUHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZVByb2R1Y3Rpb25OYW1lOyAgLy8vXG5cbiAgbGV0IGZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uID0gbnVsbDtcblxuICB1bml0UnVsZVByb2R1Y3Rpb25zLnNvbWUoZnVuY3Rpb24odW5pdFJ1bGVQcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9uRm91bmQgPSB1bml0UnVsZVByb2R1Y3Rpb24uaXNGb3VuZEJ5UHJvZHVjdGlvbk5hbWVzKGZpcnN0UHJvZHVjdGlvbk5hbWUsIHNlY29uZFByb2R1Y3Rpb25OYW1lKTtcblxuICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb25Gb3VuZCkge1xuICAgICAgZm91bmRVbml0UnVsZVByb2R1Y3Rpb24gPSB1bml0UnVsZVByb2R1Y3Rpb247XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9uID0gZm91bmRVbml0UnVsZVByb2R1Y3Rpb247IC8vL1xuXG4gIHJldHVybiB1bml0UnVsZVByb2R1Y3Rpb247XG59XG4iXX0=