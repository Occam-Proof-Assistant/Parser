'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Graph = require('./graph'),
    arrayUtil = require('../util/array'),
    parserUtil = require('../util/parser'),
    Production = require('../common/production'),
    UnitRuleProduction = require('./production/unitRule'),
    UnitRulesProduction = require('./production/unitRules'),
    NonUnitRulesProduction = require('./production/nonUnitRules');

var cycles = function () {
  function cycles() {
    _classCallCheck(this, cycles);
  }

  _createClass(cycles, null, [{
    key: 'eliminate',
    value: function eliminate(productions) {
      var unitRulesProductions = unitRulesProductionsFromProductions(productions),
          graph = Graph.fromUnitRulesProductions(unitRulesProductions),
          components = graph.getComponents(),
          nonCyclicProductions = nonCyclicProductionsFromComponents(components, productions);

      productions = nonCyclicProductions; ///

      return productions;
    }
  }]);

  return cycles;
}();

module.exports = cycles;

function unitRulesProductionsFromProductions(productions) {
  var unitRulesProductions = productions.reduce(function (unitRulesProductions, production) {
    var unitRulesProduction = UnitRulesProduction.fromProduction(production);

    if (unitRulesProduction !== null) {
      unitRulesProductions.push(unitRulesProduction);
    }

    return unitRulesProductions;
  }, []);

  return unitRulesProductions;
}

function nonCyclicProductionsFromComponents(components, productions) {
  var nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      nonCyclicProductionFromComponent(component, productions, nonCyclicProductions);
    } else {
      nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function nonCyclicProductionFromComponent(component, productions, nonCyclicProductions) {
  var firstVertex = component.getFirstVertex(),
      firstVertexName = firstVertex.getName(),
      nonCyclicProductionName = firstVertexName,
      ///
  nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, productions);

  nonCyclicProductions.push(nonCyclicProduction);
}

function nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions) {
  productions = productionsFromComponent(component, productions); ///

  var unitRuleProductions = unitRuleProductionsFromProductions(productions),
      nonUnitRulesProductions = nonUnitRulesProductionsFromProductions(productions),
      removedUnitRuleProductions = [],
      addedNonUnitRulesProductions = [];

  var unitRuleProductionsLength = unitRuleProductions.length;

  while (unitRuleProductionsLength > 0) {
    var removedUnitRuleProduction = unitRuleProductions.shift();

    removedUnitRuleProductions.push(removedUnitRuleProduction);

    var removedUnitRuleProductionName = removedUnitRuleProduction.getName(),
        removedUnitRuleProductionUnitRuleProductionName = removedUnitRuleProduction.getUnitRuleProductionName(),
        nonUnitRulesProductionName = removedUnitRuleProductionUnitRuleProductionName,
        ///
    nonUnitRulesProduction = parserUtil.findProduction(nonUnitRulesProductionName, nonUnitRulesProductions),
        nonUnitRulesProductionRules = nonUnitRulesProduction.getRules(),
        addedNonUnitRulesProductionName = removedUnitRuleProductionName,
        ///
    addedNonUnitRulesProductionRules = nonUnitRulesProductionRules; ///

    var addedNonUnitRulesProduction = parserUtil.findProduction(addedNonUnitRulesProductionName, addedNonUnitRulesProductions);

    if (addedNonUnitRulesProduction === null) {
      var removedUnitRuleProductionNode = removedUnitRuleProduction.getNode(),
          addedNonUnitRulesProductionNode = removedUnitRuleProductionNode;

      addedNonUnitRulesProduction = new Production(addedNonUnitRulesProductionName, addedNonUnitRulesProductionRules, addedNonUnitRulesProductionNode);

      addedNonUnitRulesProductions.push(addedNonUnitRulesProduction);
    } else {
      addedNonUnitRulesProduction.concatRules(nonUnitRulesProductionRules);
    }

    var unitRuleProductionName = removedUnitRuleProductionUnitRuleProductionName,
        ///
    unitRuleProduction = parserUtil.findProduction(unitRuleProductionName, unitRuleProductions);

    if (unitRuleProduction !== null) {
      var unitRuleProductionUnitRuleProductionName = unitRuleProduction.getUnitRuleProductionName();

      unitRuleProductionName = removedUnitRuleProductionName; ///

      if (unitRuleProductionName !== unitRuleProductionUnitRuleProductionName) {
        unitRuleProduction = findUnitRuleProduction(unitRuleProductionName, unitRuleProductionUnitRuleProductionName, removedUnitRuleProductions);

        if (unitRuleProduction === null) {
          unitRuleProduction = UnitRuleProduction.fromNameAndUnitRuleProductionName(unitRuleProductionName, unitRuleProductionUnitRuleProductionName);

          unitRuleProductions.unshift(unitRuleProduction);
        }
      }
    }

    unitRuleProductionsLength = unitRuleProductions.length;
  }

  nonCyclicProductionsFromFixedAndAddedNonUnitRulesProductions(nonUnitRulesProductions, addedNonUnitRulesProductions, nonCyclicProductions);
}

function nonCyclicProductionsFromFixedAndAddedNonUnitRulesProductions(fixedNonUnitRulesProductions, addedNonUnitRulesProductions, nonCyclicProductions) {
  fixedNonUnitRulesProductions.forEach(function (fixedNonUnitRulesProduction) {
    var nonCyclicProduction = fixedNonUnitRulesProduction,
        ///
    nonCyclicProductionName = nonCyclicProduction.getName(),
        addedNonUnitRulesProductionName = nonCyclicProductionName,
        ///
    addedNonUnitRulesProduction = parserUtil.findProduction(addedNonUnitRulesProductionName, addedNonUnitRulesProductions);

    if (addedNonUnitRulesProduction !== null) {
      var addedNonUnitRulesProductionRules = addedNonUnitRulesProduction.getRules();

      nonCyclicProduction.concatRules(addedNonUnitRulesProductionRules);
    }

    nonCyclicProductions.push(nonCyclicProduction);
  });
}

function productionsFromComponent(component, productions) {
  productions = component.mapVertices(function (vertex) {
    var vertexName = vertex.getName(),
        productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions);

    return production;
  });

  return productions;
}

function unitRuleProductionsFromProductions(productions) {
  var unitRuleProductions = productions.reduce(function (unitRuleProductions, production) {
    var name = production.getName(),
        unitRulesProduction = UnitRulesProduction.fromProduction(production),
        unitRulesProductionUnitRuleProductions = unitRulesProduction.mapUnitRules(function (unitRule) {
      var unitRulesProductionUnitRuleProduction = UnitRuleProduction.fromNameAndUnitRule(name, unitRule);

      return unitRulesProductionUnitRuleProduction;
    });

    unitRuleProductions = unitRuleProductions.concat(unitRulesProductionUnitRuleProductions);

    return unitRuleProductions;
  }, []);

  return unitRuleProductions;
}

function nonUnitRulesProductionsFromProductions(productions) {
  var nonUnitProductions = productions.map(function (production) {
    var nonUnitProduction = NonUnitRulesProduction.fromProduction(production);

    return nonUnitProduction;
  });

  return nonUnitProductions;
}

function findUnitRuleProduction(productionName, unitRuleProductionName, unitRuleProductions) {
  var firstProductionName = productionName,
      ///
  secondProductionName = unitRuleProductionName; ///

  var foundUnitRuleProduction = null;

  unitRuleProductions.some(function (unitRuleProduction) {
    var unitRuleProductionFound = unitRuleProduction.isFoundByProductionNames(firstProductionName, secondProductionName);

    if (unitRuleProductionFound) {
      foundUnitRuleProduction = unitRuleProduction;

      return true;
    }
  });

  var unitRuleProduction = foundUnitRuleProduction; ///

  return unitRuleProduction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL2N5Y2xlcy5qcyJdLCJuYW1lcyI6WyJHcmFwaCIsInJlcXVpcmUiLCJhcnJheVV0aWwiLCJwYXJzZXJVdGlsIiwiUHJvZHVjdGlvbiIsIlVuaXRSdWxlUHJvZHVjdGlvbiIsIlVuaXRSdWxlc1Byb2R1Y3Rpb24iLCJOb25Vbml0UnVsZXNQcm9kdWN0aW9uIiwiY3ljbGVzIiwicHJvZHVjdGlvbnMiLCJ1bml0UnVsZXNQcm9kdWN0aW9ucyIsInVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwiZ3JhcGgiLCJmcm9tVW5pdFJ1bGVzUHJvZHVjdGlvbnMiLCJjb21wb25lbnRzIiwiZ2V0Q29tcG9uZW50cyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zIiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZWR1Y2UiLCJwcm9kdWN0aW9uIiwidW5pdFJ1bGVzUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uIiwicHVzaCIsImNvbXBvbmVudCIsImNvbXBvbmVudE5vbkN5Y2xpYyIsImlzTm9uQ3ljbGljIiwibm9uQ3ljbGljUHJvZHVjdGlvbkZyb21Db21wb25lbnQiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQiLCJmaXJzdFZlcnRleCIsImdldEZpcnN0VmVydGV4IiwiZmlyc3RWZXJ0ZXhOYW1lIiwiZ2V0TmFtZSIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lIiwibm9uQ3ljbGljUHJvZHVjdGlvbiIsImZpbmRQcm9kdWN0aW9uIiwicHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50IiwidW5pdFJ1bGVQcm9kdWN0aW9ucyIsInVuaXRSdWxlUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMiLCJub25Vbml0UnVsZXNQcm9kdWN0aW9ucyIsIm5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwicmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbnMiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zIiwidW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24iLCJzaGlmdCIsInJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb25OYW1lIiwicmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJnZXRVbml0UnVsZVByb2R1Y3Rpb25OYW1lIiwibm9uVW5pdFJ1bGVzUHJvZHVjdGlvbk5hbWUiLCJub25Vbml0UnVsZXNQcm9kdWN0aW9uIiwibm9uVW5pdFJ1bGVzUHJvZHVjdGlvblJ1bGVzIiwiZ2V0UnVsZXMiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lIiwiYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uUnVsZXMiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24iLCJyZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uTm9kZSIsImdldE5vZGUiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25Ob2RlIiwiY29uY2F0UnVsZXMiLCJ1bml0UnVsZVByb2R1Y3Rpb25OYW1lIiwidW5pdFJ1bGVQcm9kdWN0aW9uIiwidW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsImZpbmRVbml0UnVsZVByb2R1Y3Rpb24iLCJmcm9tTmFtZUFuZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJ1bnNoaWZ0Iiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tRml4ZWRBbmRBZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zIiwiZml4ZWROb25Vbml0UnVsZXNQcm9kdWN0aW9ucyIsImZvckVhY2giLCJmaXhlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24iLCJtYXBWZXJ0aWNlcyIsInZlcnRleCIsInZlcnRleE5hbWUiLCJwcm9kdWN0aW9uTmFtZSIsIm5hbWUiLCJ1bml0UnVsZXNQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9ucyIsIm1hcFVuaXRSdWxlcyIsInVuaXRSdWxlIiwidW5pdFJ1bGVzUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbiIsImZyb21OYW1lQW5kVW5pdFJ1bGUiLCJjb25jYXQiLCJub25Vbml0UHJvZHVjdGlvbnMiLCJtYXAiLCJub25Vbml0UHJvZHVjdGlvbiIsImZpcnN0UHJvZHVjdGlvbk5hbWUiLCJzZWNvbmRQcm9kdWN0aW9uTmFtZSIsImZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uIiwic29tZSIsInVuaXRSdWxlUHJvZHVjdGlvbkZvdW5kIiwiaXNGb3VuZEJ5UHJvZHVjdGlvbk5hbWVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsUUFBUUMsUUFBUSxTQUFSLENBQWQ7QUFBQSxJQUNNQyxZQUFZRCxRQUFRLGVBQVIsQ0FEbEI7QUFBQSxJQUVNRSxhQUFhRixRQUFRLGdCQUFSLENBRm5CO0FBQUEsSUFHTUcsYUFBYUgsUUFBUSxzQkFBUixDQUhuQjtBQUFBLElBSU1JLHFCQUFxQkosUUFBUSx1QkFBUixDQUozQjtBQUFBLElBS01LLHNCQUFzQkwsUUFBUSx3QkFBUixDQUw1QjtBQUFBLElBTU1NLHlCQUF5Qk4sUUFBUSwyQkFBUixDQU4vQjs7SUFRTU8sTTs7Ozs7Ozs4QkFDYUMsVyxFQUFhO0FBQzVCLFVBQU1DLHVCQUF1QkMsb0NBQW9DRixXQUFwQyxDQUE3QjtBQUFBLFVBQ01HLFFBQVFaLE1BQU1hLHdCQUFOLENBQStCSCxvQkFBL0IsQ0FEZDtBQUFBLFVBRU1JLGFBQWFGLE1BQU1HLGFBQU4sRUFGbkI7QUFBQSxVQUdNQyx1QkFBdUJDLG1DQUFtQ0gsVUFBbkMsRUFBK0NMLFdBQS9DLENBSDdCOztBQUtBQSxvQkFBY08sb0JBQWQsQ0FONEIsQ0FNUTs7QUFFcEMsYUFBT1AsV0FBUDtBQUNEOzs7Ozs7QUFHSFMsT0FBT0MsT0FBUCxHQUFpQlgsTUFBakI7O0FBRUEsU0FBU0csbUNBQVQsQ0FBNkNGLFdBQTdDLEVBQTBEO0FBQ3hELE1BQU1DLHVCQUF1QkQsWUFBWVcsTUFBWixD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LENBQXRCOztBQUVBLFdBQU92QyxtQkFBUDtBQUNELEdBWjJCLEVBWXpCLEVBWnlCLENBQTVCOztBQWNBLFNBQU9BLG1CQUFQO0FBQ0Q7O0FBRUQsU0FBU0csc0NBQVQsQ0FBZ0RoQyxXQUFoRCxFQUE2RDtBQUMzRCxNQUFNMEUscUJBQXFCMUUsWUFBWTJFLEdBQVosQ0FBZ0IsVUFBUy9ELFVBQVQsRUFBcUI7QUFDOUQsUUFBTWdFLG9CQUFvQjlFLHVCQUF1QmdCLGNBQXZCLENBQXNDRixVQUF0QyxDQUExQjs7QUFFQSxXQUFPZ0UsaUJBQVA7QUFDRCxHQUowQixDQUEzQjs7QUFNQSxTQUFPRixrQkFBUDtBQUNEOztBQUVELFNBQVNsQixzQkFBVCxDQUFnQ1UsY0FBaEMsRUFBZ0RiLHNCQUFoRCxFQUF3RXhCLG1CQUF4RSxFQUE2RjtBQUMzRixNQUFNZ0Qsc0JBQXNCWCxjQUE1QjtBQUFBLE1BQTRDO0FBQ3RDWSx5QkFBdUJ6QixzQkFEN0IsQ0FEMkYsQ0FFckM7O0FBRXRELE1BQUkwQiwwQkFBMEIsSUFBOUI7O0FBRUFsRCxzQkFBb0JtRCxJQUFwQixDQUF5QixVQUFTMUIsa0JBQVQsRUFBNkI7QUFDcEQsUUFBTTJCLDBCQUEwQjNCLG1CQUFtQjRCLHdCQUFuQixDQUE0Q0wsbUJBQTVDLEVBQWlFQyxvQkFBakUsQ0FBaEM7O0FBRUEsUUFBSUcsdUJBQUosRUFBNkI7QUFDM0JGLGdDQUEwQnpCLGtCQUExQjs7QUFFQSxhQUFPLElBQVA7QUFDRDtBQUNGLEdBUkQ7O0FBVUEsTUFBTUEscUJBQXFCeUIsdUJBQTNCLENBaEIyRixDQWdCdkM7O0FBRXBELFNBQU96QixrQkFBUDtBQUNEIiwiZmlsZSI6ImN5Y2xlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgR3JhcGggPSByZXF1aXJlKCcuL2dyYXBoJyksXG4gICAgICBhcnJheVV0aWwgPSByZXF1aXJlKCcuLi91dGlsL2FycmF5JyksXG4gICAgICBwYXJzZXJVdGlsID0gcmVxdWlyZSgnLi4vdXRpbC9wYXJzZXInKSxcbiAgICAgIFByb2R1Y3Rpb24gPSByZXF1aXJlKCcuLi9jb21tb24vcHJvZHVjdGlvbicpLFxuICAgICAgVW5pdFJ1bGVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlJyksXG4gICAgICBVbml0UnVsZXNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlcycpLFxuICAgICAgTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9ub25Vbml0UnVsZXMnKTtcblxuY2xhc3MgY3ljbGVzIHtcbiAgc3RhdGljIGVsaW1pbmF0ZShwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25zID0gdW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGdyYXBoID0gR3JhcGguZnJvbVVuaXRSdWxlc1Byb2R1Y3Rpb25zKHVuaXRSdWxlc1Byb2R1Y3Rpb25zKSxcbiAgICAgICAgICBjb21wb25lbnRzID0gZ3JhcGguZ2V0Q29tcG9uZW50cygpLFxuICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucyk7XG5cbiAgICBwcm9kdWN0aW9ucyA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zOyAvLy9cblxuICAgIHJldHVybiBwcm9kdWN0aW9ucztcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGN5Y2xlcztcblxuZnVuY3Rpb24gdW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdFJ1bGVzUHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24odW5pdFJ1bGVzUHJvZHVjdGlvbnMsIHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCB1bml0UnVsZXNQcm9kdWN0aW9uID0gVW5pdFJ1bGVzUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgIGlmICh1bml0UnVsZXNQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICB1bml0UnVsZXNQcm9kdWN0aW9ucy5wdXNoKHVuaXRSdWxlc1Byb2R1Y3Rpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB1bml0UnVsZXNQcm9kdWN0aW9ucztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0UnVsZXNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9ucyA9IGNvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLCBjb21wb25lbnQpIHtcbiAgICAgICAgICBjb25zdCBjb21wb25lbnROb25DeWNsaWMgPSBjb21wb25lbnQuaXNOb25DeWNsaWMoKTtcblxuICAgICAgICAgIGlmIChjb21wb25lbnROb25DeWNsaWMpIHtcbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG4gICAgICAgIH0sIFtdKTtcblxuICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0VmVydGV4ID0gY29tcG9uZW50LmdldEZpcnN0VmVydGV4KCksXG4gICAgICAgIGZpcnN0VmVydGV4TmFtZSA9IGZpcnN0VmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUgPSBmaXJzdFZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTtcblxuICBub25DeWNsaWNQcm9kdWN0aW9ucy5wdXNoKG5vbkN5Y2xpY1Byb2R1Y3Rpb24pO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgcHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucyk7IC8vL1xuXG4gIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbnMgPSB1bml0UnVsZVByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgbm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMgPSBub25Vbml0UnVsZXNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucyksXG4gICAgICAgIHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb25zID0gW10sXG4gICAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMgPSBbXTtcblxuICBsZXQgdW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCA9IHVuaXRSdWxlUHJvZHVjdGlvbnMubGVuZ3RoO1xuXG4gIHdoaWxlICh1bml0UnVsZVByb2R1Y3Rpb25zTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24gPSB1bml0UnVsZVByb2R1Y3Rpb25zLnNoaWZ0KCk7XG5cbiAgICByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9ucy5wdXNoKHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24pO1xuXG4gICAgY29uc3QgcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSA9IHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24uZ2V0VW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSgpLFxuICAgICAgICAgIG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBub25Vbml0UnVsZXNQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihub25Vbml0UnVsZXNQcm9kdWN0aW9uTmFtZSwgbm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMpLFxuICAgICAgICAgIG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25SdWxlcyA9IG5vblVuaXRSdWxlc1Byb2R1Y3Rpb24uZ2V0UnVsZXMoKSxcbiAgICAgICAgICBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25SdWxlcyA9IG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25SdWxlczsgLy8vXG5cbiAgICBsZXQgYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lLCBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zKTtcblxuICAgIGlmIChhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb25Ob2RlID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbi5nZXROb2RlKCksXG4gICAgICAgICAgICBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25Ob2RlID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbk5vZGU7XG5cbiAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiA9IG5ldyBQcm9kdWN0aW9uKGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbk5hbWUsIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvblJ1bGVzLCBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25Ob2RlKTtcblxuICAgICAgYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9ucy5wdXNoKGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbi5jb25jYXRSdWxlcyhub25Vbml0UnVsZXNQcm9kdWN0aW9uUnVsZXMpO1xuICAgIH1cblxuICAgIGxldCB1bml0UnVsZVByb2R1Y3Rpb25OYW1lID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIC8vL1xuICAgICAgICB1bml0UnVsZVByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvbnMpO1xuXG4gICAgaWYgKHVuaXRSdWxlUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSA9IHVuaXRSdWxlUHJvZHVjdGlvbi5nZXRVbml0UnVsZVByb2R1Y3Rpb25OYW1lKCk7XG5cbiAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZTsgLy8vXG5cbiAgICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb25OYW1lICE9PSB1bml0UnVsZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lKSB7XG4gICAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbiA9IGZpbmRVbml0UnVsZVByb2R1Y3Rpb24odW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbnMpO1xuXG4gICAgICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgICAgICB1bml0UnVsZVByb2R1Y3Rpb24gPSBVbml0UnVsZVByb2R1Y3Rpb24uZnJvbU5hbWVBbmRVbml0UnVsZVByb2R1Y3Rpb25OYW1lKHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9ucy51bnNoaWZ0KHVuaXRSdWxlUHJvZHVjdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB1bml0UnVsZVByb2R1Y3Rpb25zTGVuZ3RoID0gdW5pdFJ1bGVQcm9kdWN0aW9ucy5sZW5ndGg7XG4gIH1cblxuICBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZEFuZEFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMobm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMsIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tRml4ZWRBbmRBZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zKGZpeGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMsIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGZpeGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbihmaXhlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9uID0gZml4ZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uLCAvLy9cbiAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9uTmFtZSA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbk5hbWUgPSBub25DeWNsaWNQcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgICAgYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lLCBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zKTtcblxuICAgIGlmIChhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvblJ1bGVzID0gYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uLmdldFJ1bGVzKCk7XG5cbiAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb24uY29uY2F0UnVsZXMoYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uUnVsZXMpO1xuICAgIH1cblxuICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLnB1c2gobm9uQ3ljbGljUHJvZHVjdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBwcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBwcm9kdWN0aW9ucyA9IGNvbXBvbmVudC5tYXBWZXJ0aWNlcyhmdW5jdGlvbih2ZXJ0ZXgpIHtcbiAgICBjb25zdCB2ZXJ0ZXhOYW1lID0gdmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgICBwcm9kdWN0aW9uTmFtZSA9IHZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgICBwcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihwcm9kdWN0aW9uTmFtZSwgcHJvZHVjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb247XG4gIH0pO1xuXG4gIHJldHVybiBwcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gdW5pdFJ1bGVQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0UnVsZVByb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRSdWxlUHJvZHVjdGlvbnMsIHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBuYW1lID0gcHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgdW5pdFJ1bGVzUHJvZHVjdGlvbiA9IFVuaXRSdWxlc1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbiksXG4gICAgICAgICAgdW5pdFJ1bGVzUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbnMgPSB1bml0UnVsZXNQcm9kdWN0aW9uLm1hcFVuaXRSdWxlcyhmdW5jdGlvbih1bml0UnVsZSkge1xuICAgICAgICAgICAgY29uc3QgdW5pdFJ1bGVzUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbiA9IFVuaXRSdWxlUHJvZHVjdGlvbi5mcm9tTmFtZUFuZFVuaXRSdWxlKG5hbWUsIHVuaXRSdWxlKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb247XG4gICAgICAgICAgfSk7XG5cbiAgICB1bml0UnVsZVByb2R1Y3Rpb25zID0gdW5pdFJ1bGVQcm9kdWN0aW9ucy5jb25jYXQodW5pdFJ1bGVzUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHVuaXRSdWxlUHJvZHVjdGlvbnM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gdW5pdFJ1bGVQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gbm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3Qgbm9uVW5pdFByb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMubWFwKGZ1bmN0aW9uKHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBub25Vbml0UHJvZHVjdGlvbiA9IE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG4gICAgXG4gICAgcmV0dXJuIG5vblVuaXRQcm9kdWN0aW9uO1xuICB9KTtcbiAgXG4gIHJldHVybiBub25Vbml0UHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGZpbmRVbml0UnVsZVByb2R1Y3Rpb24ocHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgZmlyc3RQcm9kdWN0aW9uTmFtZSA9IHByb2R1Y3Rpb25OYW1lLCAvLy9cbiAgICAgICAgc2Vjb25kUHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZVByb2R1Y3Rpb25OYW1lOyAgLy8vXG5cbiAgbGV0IGZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uID0gbnVsbDtcblxuICB1bml0UnVsZVByb2R1Y3Rpb25zLnNvbWUoZnVuY3Rpb24odW5pdFJ1bGVQcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9uRm91bmQgPSB1bml0UnVsZVByb2R1Y3Rpb24uaXNGb3VuZEJ5UHJvZHVjdGlvbk5hbWVzKGZpcnN0UHJvZHVjdGlvbk5hbWUsIHNlY29uZFByb2R1Y3Rpb25OYW1lKTtcblxuICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb25Gb3VuZCkge1xuICAgICAgZm91bmRVbml0UnVsZVByb2R1Y3Rpb24gPSB1bml0UnVsZVByb2R1Y3Rpb247XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9uID0gZm91bmRVbml0UnVsZVByb2R1Y3Rpb247IC8vL1xuXG4gIHJldHVybiB1bml0UnVsZVByb2R1Y3Rpb247XG59Il19