'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Graph = require('./graph'),
    arrayUtil = require('../util/array'),
    parserUtil = require('../util/parser'),
    Production = require('../common/production'),
    UnitRuleProduction = require('./production/unitRule'),
    UnitRulesProduction = require('./production/unitRules'),
    NonUnitRulesProduction = require('./production/nonUnitRules');

var cycles = function () {
  function cycles() {
    _classCallCheck(this, cycles);
  }

  _createClass(cycles, null, [{
    key: 'eliminate',
    value: function eliminate(productions) {
      var unitRulesProductions = unitRulesProductionsFromProductions(productions),
          graph = Graph.fromUnitRulesProductions(unitRulesProductions),
          components = graph.getComponents(),
          nonCyclicProductions = nonCyclicProductionsFromComponents(components, productions);

      productions = nonCyclicProductions; ///

      return productions;
    }
  }]);

  return cycles;
}();

module.exports = cycles;

function unitRulesProductionsFromProductions(productions) {
  var unitRulesProductions = productions.reduce(function (unitRulesProductions, production) {
    var unitRulesProduction = UnitRulesProduction.fromProduction(production);

    if (unitRulesProduction !== null) {
      unitRulesProductions.push(unitRulesProduction);
    }

    return unitRulesProductions;
  }, []);

  return unitRulesProductions;
}

function nonCyclicProductionsFromComponents(components, productions) {
  var nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      nonCyclicProductionFromComponent(component, productions, nonCyclicProductions);
    } else {
      nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function nonCyclicProductionFromComponent(component, productions, nonCyclicProductions) {
  var firstVertex = component.getFirstVertex(),
      firstVertexName = firstVertex.getName(),
      nonCyclicProductionName = firstVertexName,
      ///
  nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, productions);

  nonCyclicProductions.push(nonCyclicProduction);
}

function nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions) {
  productions = productionsFromComponent(component, productions); ///

  var unitRuleProductions = unitRuleProductionsFromProductions(productions),
      nonUnitRulesProductions = nonUnitRulesProductionsFromProductions(productions),
      removedUnitRuleProductions = [],
      addedNonUnitRulesProductions = [];

  var unitRuleProductionsLength = unitRuleProductions.length;

  while (unitRuleProductionsLength > 0) {
    var removedUnitRuleProduction = unitRuleProductions.shift();

    removedUnitRuleProductions.push(removedUnitRuleProduction);

    var removedUnitRuleProductionName = removedUnitRuleProduction.getName(),
        removedUnitRuleProductionUnitRuleProductionName = removedUnitRuleProduction.getUnitRuleProductionName(),
        nonUnitRulesProductionName = removedUnitRuleProductionUnitRuleProductionName,
        ///
    nonUnitRulesProduction = parserUtil.findProduction(nonUnitRulesProductionName, nonUnitRulesProductions),
        nonUnitRulesProductionRules = nonUnitRulesProduction.getRules(),
        addedNonUnitRulesProductionName = removedUnitRuleProductionName,
        ///
    addedNonUnitRulesProductionRules = nonUnitRulesProductionRules; ///

    var addedNonUnitRulesProduction = parserUtil.findProduction(addedNonUnitRulesProductionName, addedNonUnitRulesProductions);

    if (addedNonUnitRulesProduction === null) {
      var removedUnitRuleProductionNode = removedUnitRuleProduction.getNode(),
          addedNonUnitRulesProductionNode = removedUnitRuleProductionNode;

      addedNonUnitRulesProduction = new Production(addedNonUnitRulesProductionName, addedNonUnitRulesProductionRules, addedNonUnitRulesProductionNode);

      addedNonUnitRulesProductions.push(addedNonUnitRulesProduction);
    } else {
      addedNonUnitRulesProduction.concatRules(nonUnitRulesProductionRules);
    }

    var unitRuleProductionName = removedUnitRuleProductionUnitRuleProductionName,
        ///
    unitRuleProduction = parserUtil.findProduction(unitRuleProductionName, unitRuleProductions);

    if (unitRuleProduction !== null) {
      var unitRuleProductionUnitRuleProductionName = unitRuleProduction.getUnitRuleProductionName();

      unitRuleProductionName = removedUnitRuleProductionName; ///

      if (unitRuleProductionName !== unitRuleProductionUnitRuleProductionName) {
        unitRuleProduction = findUnitRuleProduction(unitRuleProductionName, unitRuleProductionUnitRuleProductionName, removedUnitRuleProductions);

        if (unitRuleProduction === null) {
          unitRuleProduction = UnitRuleProduction.fromNameAndUnitRuleProductionName(unitRuleProductionName, unitRuleProductionUnitRuleProductionName);

          unitRuleProductions.unshift(unitRuleProduction);
        }
      }
    }

    unitRuleProductionsLength = unitRuleProductions.length;
  }

  nonUnitRulesProductions.forEach(function (nonUnitRulesProduction) {
    var nonUnitRulesProductionName = nonUnitRulesProduction.getName(),
        addedNonUnitRulesProductionName = nonUnitRulesProductionName,
        addedNonUnitRulesProduction = parserUtil.findProduction(addedNonUnitRulesProductionName, addedNonUnitRulesProductions);

    if (addedNonUnitRulesProduction !== null) {
      var _addedNonUnitRulesProductionRules = addedNonUnitRulesProduction.getRules();

      nonUnitRulesProduction.concatRules(_addedNonUnitRulesProductionRules);
    }
  });

  var nonCyclicProductionsLength = nonCyclicProductions.length,
      start = nonCyclicProductionsLength,
      ///
  deleteCount = 0;

  arrayUtil.splice(nonCyclicProductions, start, deleteCount, nonUnitRulesProductions);
}

function productionsFromComponent(component, productions) {
  productions = component.mapVertices(function (vertex) {
    var vertexName = vertex.getName(),
        productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions);

    return production;
  });

  return productions;
}

function unitRuleProductionsFromProductions(productions) {
  var unitRuleProductions = productions.reduce(function (unitRuleProductions, production) {
    var name = production.getName(),
        unitRulesProduction = UnitRulesProduction.fromProduction(production),
        unitRulesProductionUnitRuleProductions = unitRulesProduction.mapUnitRules(function (unitRule) {
      var unitRulesProductionUnitRuleProduction = UnitRuleProduction.fromNameAndUnitRule(name, unitRule);

      return unitRulesProductionUnitRuleProduction;
    });

    unitRuleProductions = unitRuleProductions.concat(unitRulesProductionUnitRuleProductions);

    return unitRuleProductions;
  }, []);

  return unitRuleProductions;
}

function nonUnitRulesProductionsFromProductions(productions) {
  var nonUnitProductions = productions.map(function (production) {
    var nonUnitProduction = NonUnitRulesProduction.fromProduction(production);

    return nonUnitProduction;
  });

  return nonUnitProductions;
}

function findUnitRuleProduction(productionName, unitRuleProductionName, unitRuleProductions) {
  var firstProductionName = productionName,
      ///
  secondProductionName = unitRuleProductionName; ///

  var foundUnitRuleProduction = null;

  unitRuleProductions.some(function (unitRuleProduction) {
    var unitRuleProductionFound = unitRuleProduction.isFoundByProductionNames(firstProductionName, secondProductionName);

    if (unitRuleProductionFound) {
      foundUnitRuleProduction = unitRuleProduction;

      return true;
    }
  });

  var unitRuleProduction = foundUnitRuleProduction; ///

  return unitRuleProduction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL2N5Y2xlcy5qcyJdLCJuYW1lcyI6WyJHcmFwaCIsInJlcXVpcmUiLCJhcnJheVV0aWwiLCJwYXJzZXJVdGlsIiwiUHJvZHVjdGlvbiIsIlVuaXRSdWxlUHJvZHVjdGlvbiIsIlVuaXRSdWxlc1Byb2R1Y3Rpb24iLCJOb25Vbml0UnVsZXNQcm9kdWN0aW9uIiwiY3ljbGVzIiwicHJvZHVjdGlvbnMiLCJ1bml0UnVsZXNQcm9kdWN0aW9ucyIsInVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwiZ3JhcGgiLCJmcm9tVW5pdFJ1bGVzUHJvZHVjdGlvbnMiLCJjb21wb25lbnRzIiwiZ2V0Q29tcG9uZW50cyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zIiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyIsIm1vZHVsZSIsImV4cG9ydHMiLCJyZWR1Y2UiLCJwcm9kdWN0aW9uIiwidW5pdFJ1bGVzUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uIiwicHVzaCIsImNvbXBvbmVudCIsImNvbXBvbmVudE5vbkN5Y2xpYyIsImlzTm9uQ3ljbGljIiwibm9uQ3ljbGljUHJvZHVjdGlvbkZyb21Db21wb25lbnQiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQiLCJmaXJzdFZlcnRleCIsImdldEZpcnN0VmVydGV4IiwiZmlyc3RWZXJ0ZXhOYW1lIiwiZ2V0TmFtZSIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lIiwibm9uQ3ljbGljUHJvZHVjdGlvbiIsImZpbmRQcm9kdWN0aW9uIiwicHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50IiwidW5pdFJ1bGVQcm9kdWN0aW9ucyIsInVuaXRSdWxlUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMiLCJub25Vbml0UnVsZXNQcm9kdWN0aW9ucyIsIm5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwicmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbnMiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zIiwidW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCIsImxlbmd0aCIsInJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24iLCJzaGlmdCIsInJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb25OYW1lIiwicmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJnZXRVbml0UnVsZVByb2R1Y3Rpb25OYW1lIiwibm9uVW5pdFJ1bGVzUHJvZHVjdGlvbk5hbWUiLCJub25Vbml0UnVsZXNQcm9kdWN0aW9uIiwibm9uVW5pdFJ1bGVzUHJvZHVjdGlvblJ1bGVzIiwiZ2V0UnVsZXMiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lIiwiYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uUnVsZXMiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24iLCJyZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uTm9kZSIsImdldE5vZGUiLCJhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25Ob2RlIiwiY29uY2F0UnVsZXMiLCJ1bml0UnVsZVByb2R1Y3Rpb25OYW1lIiwidW5pdFJ1bGVQcm9kdWN0aW9uIiwidW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsImZpbmRVbml0UnVsZVByb2R1Y3Rpb24iLCJmcm9tTmFtZUFuZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJ1bnNoaWZ0IiwiZm9yRWFjaCIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zTGVuZ3RoIiwic3RhcnQiLCJkZWxldGVDb3VudCIsInNwbGljZSIsIm1hcFZlcnRpY2VzIiwidmVydGV4IiwidmVydGV4TmFtZSIsInByb2R1Y3Rpb25OYW1lIiwibmFtZSIsInVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25zIiwibWFwVW5pdFJ1bGVzIiwidW5pdFJ1bGUiLCJ1bml0UnVsZXNQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uIiwiZnJvbU5hbWVBbmRVbml0UnVsZSIsImNvbmNhdCIsIm5vblVuaXRQcm9kdWN0aW9ucyIsIm1hcCIsIm5vblVuaXRQcm9kdWN0aW9uIiwiZmlyc3RQcm9kdWN0aW9uTmFtZSIsInNlY29uZFByb2R1Y3Rpb25OYW1lIiwiZm91bmRVbml0UnVsZVByb2R1Y3Rpb24iLCJzb21lIiwidW5pdFJ1bGVQcm9kdWN0aW9uRm91bmQiLCJpc0ZvdW5kQnlQcm9kdWN0aW9uTmFtZXMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxRQUFRQyxRQUFRLFNBQVIsQ0FBZDtBQUFBLElBQ01DLFlBQVlELFFBQVEsZUFBUixDQURsQjtBQUFBLElBRU1FLGFBQWFGLFFBQVEsZ0JBQVIsQ0FGbkI7QUFBQSxJQUdNRyxhQUFhSCxRQUFRLHNCQUFSLENBSG5CO0FBQUEsSUFJTUkscUJBQXFCSixRQUFRLHVCQUFSLENBSjNCO0FBQUEsSUFLTUssc0JBQXNCTCxRQUFRLHdCQUFSLENBTDVCO0FBQUEsSUFNTU0seUJBQXlCTixRQUFRLDJCQUFSLENBTi9COztJQVFNTyxNOzs7Ozs7OzhCQUNhQyxXLEVBQWE7QUFDNUIsVUFBTUMsdUJBQXVCQyxvQ0FBb0NGLFdBQXBDLENBQTdCO0FBQUEsVUFDTUcsUUFBUVosTUFBTWEsd0JBQU4sQ0FBK0JILG9CQUEvQixDQURkO0FBQUEsVUFFTUksYUFBYUYsTUFBTUcsYUFBTixFQUZuQjtBQUFBLFVBR01DLHVCQUF1QkMsbUNBQW1DSCxVQUFuQyxFQUErQ0wsV0FBL0MsQ0FIN0I7O0FBS0FBLG9CQUFjTyxvQkFBZCxDQU40QixDQU1ROztBQUVwQyxhQUFPUCxXQUFQO0FBQ0Q7Ozs7OztBQUdIUyxPQUFPQyxPQUFQLEdBQWlCWCxNQUFqQjs7QUFFQSxTQUFTRyxtQ0FBVCxDQUE2Q0YsV0FBN0MsRUFBMEQ7QUFDeEQsTUFBTUMsdUJBQXVCRCxZQUFZVyxNQUFaLENBQW1CLFVBQVNWLG9CQUFULEVBQStCVyxVQUEvQixFQUEyQztBQUN6RixRQUFNQyxzQkFBc0JoQixvQkFBb0Jp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QUFoRCxFQUE2RDtBQUMzRCxNQUFNMkUscUJBQXFCM0UsWUFBWTRFLEdBQVosQ0FBZ0IsVUFBU2hFLFVBQVQsRUFBcUI7QUFDOUQsUUFBTWlFLG9CQUFvQi9FLHVCQUF1QmdCLGNBQXZCLENBQXNDRixVQUF0QyxDQUExQjs7QUFFQSxXQUFPaUUsaUJBQVA7QUFDRCxHQUowQixDQUEzQjs7QUFNQSxTQUFPRixrQkFBUDtBQUNEOztBQUVELFNBQVNuQixzQkFBVCxDQUFnQ1csY0FBaEMsRUFBZ0RkLHNCQUFoRCxFQUF3RXhCLG1CQUF4RSxFQUE2RjtBQUMzRixNQUFNaUQsc0JBQXNCWCxjQUE1QjtBQUFBLE1BQTRDO0FBQ3RDWSx5QkFBdUIxQixzQkFEN0IsQ0FEMkYsQ0FFckM7O0FBRXRELE1BQUkyQiwwQkFBMEIsSUFBOUI7O0FBRUFuRCxzQkFBb0JvRCxJQUFwQixDQUF5QixVQUFTM0Isa0JBQVQsRUFBNkI7QUFDcEQsUUFBTTRCLDBCQUEwQjVCLG1CQUFtQjZCLHdCQUFuQixDQUE0Q0wsbUJBQTVDLEVBQWlFQyxvQkFBakUsQ0FBaEM7O0FBRUEsUUFBSUcsdUJBQUosRUFBNkI7QUFDM0JGLGdDQUEwQjFCLGtCQUExQjs7QUFFQSxhQUFPLElBQVA7QUFDRDtBQUNGLEdBUkQ7O0FBVUEsTUFBTUEscUJBQXFCMEIsdUJBQTNCLENBaEIyRixDQWdCdkM7O0FBRXBELFNBQU8xQixrQkFBUDtBQUNEIiwiZmlsZSI6ImN5Y2xlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgR3JhcGggPSByZXF1aXJlKCcuL2dyYXBoJyksXG4gICAgICBhcnJheVV0aWwgPSByZXF1aXJlKCcuLi91dGlsL2FycmF5JyksXG4gICAgICBwYXJzZXJVdGlsID0gcmVxdWlyZSgnLi4vdXRpbC9wYXJzZXInKSxcbiAgICAgIFByb2R1Y3Rpb24gPSByZXF1aXJlKCcuLi9jb21tb24vcHJvZHVjdGlvbicpLFxuICAgICAgVW5pdFJ1bGVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlJyksXG4gICAgICBVbml0UnVsZXNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlcycpLFxuICAgICAgTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9ub25Vbml0UnVsZXMnKTtcblxuY2xhc3MgY3ljbGVzIHtcbiAgc3RhdGljIGVsaW1pbmF0ZShwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25zID0gdW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGdyYXBoID0gR3JhcGguZnJvbVVuaXRSdWxlc1Byb2R1Y3Rpb25zKHVuaXRSdWxlc1Byb2R1Y3Rpb25zKSxcbiAgICAgICAgICBjb21wb25lbnRzID0gZ3JhcGguZ2V0Q29tcG9uZW50cygpLFxuICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucyk7XG5cbiAgICBwcm9kdWN0aW9ucyA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zOyAvLy9cblxuICAgIHJldHVybiBwcm9kdWN0aW9ucztcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGN5Y2xlcztcblxuZnVuY3Rpb24gdW5pdFJ1bGVzUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdFJ1bGVzUHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24odW5pdFJ1bGVzUHJvZHVjdGlvbnMsIHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCB1bml0UnVsZXNQcm9kdWN0aW9uID0gVW5pdFJ1bGVzUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgIGlmICh1bml0UnVsZXNQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICB1bml0UnVsZXNQcm9kdWN0aW9ucy5wdXNoKHVuaXRSdWxlc1Byb2R1Y3Rpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB1bml0UnVsZXNQcm9kdWN0aW9ucztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0UnVsZXNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9ucyA9IGNvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLCBjb21wb25lbnQpIHtcbiAgICAgICAgICBjb25zdCBjb21wb25lbnROb25DeWNsaWMgPSBjb21wb25lbnQuaXNOb25DeWNsaWMoKTtcblxuICAgICAgICAgIGlmIChjb21wb25lbnROb25DeWNsaWMpIHtcbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG4gICAgICAgIH0sIFtdKTtcblxuICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0VmVydGV4ID0gY29tcG9uZW50LmdldEZpcnN0VmVydGV4KCksXG4gICAgICAgIGZpcnN0VmVydGV4TmFtZSA9IGZpcnN0VmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUgPSBmaXJzdFZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTtcblxuICBub25DeWNsaWNQcm9kdWN0aW9ucy5wdXNoKG5vbkN5Y2xpY1Byb2R1Y3Rpb24pO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgcHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucyk7IC8vL1xuXG4gIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbnMgPSB1bml0UnVsZVByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgbm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMgPSBub25Vbml0UnVsZXNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucyksXG4gICAgICAgIHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb25zID0gW10sXG4gICAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMgPSBbXTtcblxuICBsZXQgdW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCA9IHVuaXRSdWxlUHJvZHVjdGlvbnMubGVuZ3RoO1xuXG4gIHdoaWxlICh1bml0UnVsZVByb2R1Y3Rpb25zTGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24gPSB1bml0UnVsZVByb2R1Y3Rpb25zLnNoaWZ0KCk7XG5cbiAgICByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9ucy5wdXNoKHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24pO1xuXG4gICAgY29uc3QgcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSA9IHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb24uZ2V0VW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSgpLFxuICAgICAgICAgIG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBub25Vbml0UnVsZXNQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihub25Vbml0UnVsZXNQcm9kdWN0aW9uTmFtZSwgbm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMpLFxuICAgICAgICAgIG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25SdWxlcyA9IG5vblVuaXRSdWxlc1Byb2R1Y3Rpb24uZ2V0UnVsZXMoKSxcbiAgICAgICAgICBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25SdWxlcyA9IG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25SdWxlczsgLy8vXG5cbiAgICBsZXQgYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25OYW1lLCBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zKTtcblxuICAgIGlmIChhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgIGNvbnN0IHJlbW92ZWRVbml0UnVsZVByb2R1Y3Rpb25Ob2RlID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbi5nZXROb2RlKCksXG4gICAgICAgICAgICBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25Ob2RlID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbk5vZGU7XG5cbiAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiA9IG5ldyBQcm9kdWN0aW9uKGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbk5hbWUsIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvblJ1bGVzLCBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25Ob2RlKTtcblxuICAgICAgYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9ucy5wdXNoKGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbi5jb25jYXRSdWxlcyhub25Vbml0UnVsZXNQcm9kdWN0aW9uUnVsZXMpO1xuICAgIH1cblxuICAgIGxldCB1bml0UnVsZVByb2R1Y3Rpb25OYW1lID0gcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIC8vL1xuICAgICAgICB1bml0UnVsZVByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvbnMpO1xuXG4gICAgaWYgKHVuaXRSdWxlUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSA9IHVuaXRSdWxlUHJvZHVjdGlvbi5nZXRVbml0UnVsZVByb2R1Y3Rpb25OYW1lKCk7XG5cbiAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSByZW1vdmVkVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZTsgLy8vXG5cbiAgICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb25OYW1lICE9PSB1bml0UnVsZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lKSB7XG4gICAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbiA9IGZpbmRVbml0UnVsZVByb2R1Y3Rpb24odW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgcmVtb3ZlZFVuaXRSdWxlUHJvZHVjdGlvbnMpO1xuXG4gICAgICAgIGlmICh1bml0UnVsZVByb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgICAgICB1bml0UnVsZVByb2R1Y3Rpb24gPSBVbml0UnVsZVByb2R1Y3Rpb24uZnJvbU5hbWVBbmRVbml0UnVsZVByb2R1Y3Rpb25OYW1lKHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUsIHVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9ucy51bnNoaWZ0KHVuaXRSdWxlUHJvZHVjdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB1bml0UnVsZVByb2R1Y3Rpb25zTGVuZ3RoID0gdW5pdFJ1bGVQcm9kdWN0aW9ucy5sZW5ndGg7XG4gIH1cblxuICBub25Vbml0UnVsZXNQcm9kdWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKG5vblVuaXRSdWxlc1Byb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBub25Vbml0UnVsZXNQcm9kdWN0aW9uTmFtZSA9IG5vblVuaXRSdWxlc1Byb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbk5hbWUgPSBub25Vbml0UnVsZXNQcm9kdWN0aW9uTmFtZSxcbiAgICAgICAgICBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbk5hbWUsIGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbnMpO1xuXG4gICAgaWYgKGFkZGVkTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgYWRkZWROb25Vbml0UnVsZXNQcm9kdWN0aW9uUnVsZXMgPSBhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb24uZ2V0UnVsZXMoKTtcblxuICAgICAgbm9uVW5pdFJ1bGVzUHJvZHVjdGlvbi5jb25jYXRSdWxlcyhhZGRlZE5vblVuaXRSdWxlc1Byb2R1Y3Rpb25SdWxlcyk7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9uc0xlbmd0aCA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLmxlbmd0aCxcbiAgICAgICAgc3RhcnQgPSBub25DeWNsaWNQcm9kdWN0aW9uc0xlbmd0aCwgLy8vXG4gICAgICAgIGRlbGV0ZUNvdW50ID0gMDtcblxuICBhcnJheVV0aWwuc3BsaWNlKG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLCBzdGFydCwgZGVsZXRlQ291bnQsIG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zKTtcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMpIHtcbiAgcHJvZHVjdGlvbnMgPSBjb21wb25lbnQubWFwVmVydGljZXMoZnVuY3Rpb24odmVydGV4KSB7XG4gICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCksXG4gICAgICAgICAgcHJvZHVjdGlvbk5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgcHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24ocHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTtcblxuICAgIHJldHVybiBwcm9kdWN0aW9uO1xuICB9KTtcblxuICByZXR1cm4gcHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIHVuaXRSdWxlUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLnJlZHVjZShmdW5jdGlvbih1bml0UnVsZVByb2R1Y3Rpb25zLCBwcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgbmFtZSA9IHByb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIHVuaXRSdWxlc1Byb2R1Y3Rpb24gPSBVbml0UnVsZXNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pLFxuICAgICAgICAgIHVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25zID0gdW5pdFJ1bGVzUHJvZHVjdGlvbi5tYXBVbml0UnVsZXMoZnVuY3Rpb24odW5pdFJ1bGUpIHtcbiAgICAgICAgICAgIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb24gPSBVbml0UnVsZVByb2R1Y3Rpb24uZnJvbU5hbWVBbmRVbml0UnVsZShuYW1lLCB1bml0UnVsZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB1bml0UnVsZXNQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uO1xuICAgICAgICAgIH0pO1xuXG4gICAgdW5pdFJ1bGVQcm9kdWN0aW9ucyA9IHVuaXRSdWxlUHJvZHVjdGlvbnMuY29uY2F0KHVuaXRSdWxlc1Byb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25zKTtcblxuICAgIHJldHVybiB1bml0UnVsZVByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vblVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IG5vblVuaXRQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLm1hcChmdW5jdGlvbihwcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uVW5pdFByb2R1Y3Rpb24gPSBOb25Vbml0UnVsZXNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuICAgIFxuICAgIHJldHVybiBub25Vbml0UHJvZHVjdGlvbjtcbiAgfSk7XG4gIFxuICByZXR1cm4gbm9uVW5pdFByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBmaW5kVW5pdFJ1bGVQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCB1bml0UnVsZVByb2R1Y3Rpb25OYW1lLCB1bml0UnVsZVByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0UHJvZHVjdGlvbk5hbWUgPSBwcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgIHNlY29uZFByb2R1Y3Rpb25OYW1lID0gdW5pdFJ1bGVQcm9kdWN0aW9uTmFtZTsgIC8vL1xuXG4gIGxldCBmb3VuZFVuaXRSdWxlUHJvZHVjdGlvbiA9IG51bGw7XG5cbiAgdW5pdFJ1bGVQcm9kdWN0aW9ucy5zb21lKGZ1bmN0aW9uKHVuaXRSdWxlUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbkZvdW5kID0gdW5pdFJ1bGVQcm9kdWN0aW9uLmlzRm91bmRCeVByb2R1Y3Rpb25OYW1lcyhmaXJzdFByb2R1Y3Rpb25OYW1lLCBzZWNvbmRQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICBpZiAodW5pdFJ1bGVQcm9kdWN0aW9uRm91bmQpIHtcbiAgICAgIGZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uID0gdW5pdFJ1bGVQcm9kdWN0aW9uO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbiA9IGZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uOyAvLy9cblxuICByZXR1cm4gdW5pdFJ1bGVQcm9kdWN0aW9uO1xufSJdfQ==