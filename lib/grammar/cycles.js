'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var tarjan = require('occam-tarjan');

var parserUtil = require('../util/parser'),
    Production = require('../bnf/production'),
    UnitProduction = require('./production/unit'),
    UnitsProduction = require('./production/units'),
    FixedProduction = require('./production/fixed'),
    NonCyclicProduction = require('./production/nonCyclic');

var Graph = tarjan.Graph;

var cycles = function () {
  function cycles() {
    _classCallCheck(this, cycles);
  }

  _createClass(cycles, null, [{
    key: 'eliminate',
    value: function eliminate(productions) {
      var graph = graphFromProductions(productions),
          components = graph.generateComponents(),
          nonCyclicProductions = nonCyclicProductionsFromComponents(components, productions);

      productions = productions.map(function (production) {
        var productionName = production.getName(),
            nonCyclicProductionName = productionName,
            ///
        nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, nonCyclicProductions);

        if (nonCyclicProduction !== null) {
          production = nonCyclicProduction; ///
        } else {
          var alreadyNonCyclicProductionName = productionName,
              ///
          alreadyNonCyclicProduction = parserUtil.findProduction(alreadyNonCyclicProductionName, productions); ///

          production = alreadyNonCyclicProduction; ///
        }

        return production;
      });

      return productions;
    }
  }]);

  return cycles;
}();

module.exports = cycles;

function graphFromProductions(productions) {
  var graph = new Graph(),
      unitsProductions = unitsProductionsFromProductions(productions);

  unitsProductions.forEach(function (unitsProduction) {
    var productionName = unitsProduction.getName(),
        unitDefinitionsProductionNames = unitsProduction.getUnitDefinitionProductionNames(),
        vertexName = productionName,
        ///
    descendantVertexNames = unitDefinitionsProductionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function unitsProductionsFromProductions(productions) {
  var unitsProductions = productions.reduce(function (unitsProductions, production) {
    var unitsProduction = UnitsProduction.fromProduction(production);

    if (unitsProduction !== null) {
      unitsProductions.push(unitsProduction);
    }

    return unitsProductions;
  }, []);

  return unitsProductions;
}

function nonCyclicProductionsFromComponents(components, productions) {
  var nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      nonCyclicProductionFromComponent(component, productions, nonCyclicProductions);
    } else {
      nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function nonCyclicProductionFromComponent(component, productions, nonCyclicProductions) {
  var firstVertexName = component.getFirstVertexName(),
      productionName = firstVertexName,
      ///
  production = parserUtil.findProduction(productionName, productions);

  if (production !== null) {
    var nonCyclicProduction = NonCyclicProduction.fromProduction(production);

    nonCyclicProductions.push(nonCyclicProduction);
  }
}

function nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions) {
  var unitProductions = unitProductionsFromComponent(component, productions),
      fixedProductions = fixedProductionsFromComponent(component, productions),
      addedProductions = addedProductionsFromUnitProductionsAndFixedProductions(unitProductions, fixedProductions);

  nonCyclicProductionsFromFixedProductionsAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions);
}

function addedProductionsFromUnitProductionsAndFixedProductions(unitProductions, fixedProductions) {
  var addedProductions = [],
      removedUnitProductions = [];

  var unitProductionsLength = unitProductions.length;

  while (unitProductionsLength > 0) {
    var unitProduction = unitProductions.shift(),
        unitProductionName = unitProduction.getName();

    var removedUnitProduction = unitProduction; ///

    removedUnitProductions.push(removedUnitProduction);

    var unitProductionUnitProductionName = unitProduction.getUnitProductionName(),
        fixedProductionName = unitProductionUnitProductionName,
        ///
    fixedProduction = parserUtil.findProduction(fixedProductionName, fixedProductions),
        addedProductionName = unitProductionName; ///

    var addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction === null) {
      addedProduction = Production.fromProduction(fixedProduction);

      addedProduction.setName(addedProductionName);

      addedProductions.push(addedProduction);
    } else {
      var fixedProductionDefinitions = fixedProduction.getDefinitions();

      addedProduction.addDefinitions(fixedProductionDefinitions);
    }

    var intermediateUnitProductionName = unitProductionUnitProductionName,
        ///
    intermediateUnitProduction = parserUtil.findProduction(intermediateUnitProductionName, unitProductions);

    if (intermediateUnitProduction !== null) {
      var intermediateUnitProductionUnitProductionName = intermediateUnitProduction.getUnitProductionName(),
          firstProductionName = unitProductionName,
          ///
      secondProductionName = intermediateUnitProductionUnitProductionName,
          ///
      unitProductionNonCyclic = firstProductionName !== secondProductionName;

      if (unitProductionNonCyclic) {
        unitProduction = findUnitProduction(firstProductionName, secondProductionName, removedUnitProductions);

        if (unitProduction === null) {
          unitProduction = UnitProduction.fromProductionNames(firstProductionName, secondProductionName);

          unitProductions.unshift(unitProduction);
        }
      }
    }

    unitProductionsLength = unitProductions.length;
  }

  return addedProductions;
}

function nonCyclicProductionsFromFixedProductionsAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions) {
  fixedProductions.forEach(function (fixedProduction) {
    var nonCyclicProduction = fixedProduction,
        ///
    nonCyclicProductionName = nonCyclicProduction.getName(),
        addedProductionName = nonCyclicProductionName,
        ///
    addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction !== null) {
      var addedProductionDefinitions = addedProduction.getDefinitions();

      nonCyclicProduction.addDefinitions(addedProductionDefinitions);
    }

    var nonCyclicProductionDefinitionsExist = nonCyclicProduction.doDefinitionsExist();

    if (nonCyclicProductionDefinitionsExist) {
      nonCyclicProductions.push(nonCyclicProduction);
    }
  });
}

function unitProductionsFromComponent(component, productions) {
  var componentVertexNames = component.getVertexNames(),
      unitsProductions = unitsProductionsFromComponent(component, productions),
      productionNames = componentVertexNames,
      ///
  unitProductions = unitProductionsFromUnitsProductionsAndProductionNames(unitsProductions, productionNames);

  return unitProductions;
}

function unitsProductionsFromComponent(component, productions) {
  var unitsProductions = component.reduceVertexNames(function (unitsProductions, vertexName) {
    var productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions),
        unitsProduction = UnitsProduction.fromProduction(production);

    if (unitsProduction !== null) {
      unitsProductions.push(unitsProduction);
    }

    return unitsProductions;
  }, []);

  return unitsProductions;
}

function unitProductionsFromUnitsProductionsAndProductionNames(unitsProductions, productionNames) {
  var unitProductions = unitsProductions.reduce(function (unitProductions, unitsProduction) {
    var unitsProductionName = unitsProduction.getName();

    unitsProduction.forEachUnitDefinition(function (unitDefinition) {
      var name = unitsProductionName,
          ///
      unitProduction = UnitProduction.fromNameAndUnitDefinition(name, unitDefinition),
          unitProductionNotCyclic = unitProduction.isNotCyclic(),
          unitProductionIncludedInProductionNames = unitProduction.isIncludedInProductionNames(productionNames);

      if (unitProductionNotCyclic && unitProductionIncludedInProductionNames) {
        unitProductions.push(unitProduction);
      }
    });

    return unitProductions;
  }, []);

  return unitProductions;
}

function fixedProductionsFromComponent(component, productions) {
  var componentVertexNames = component.getVertexNames(),
      productionNames = componentVertexNames,
      ///
  fixedProductions = component.mapVertexNames(function (vertexName) {
    var productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions),
        fixedProduction = FixedProduction.fromProductionAndProductionNames(production, productionNames);

    return fixedProduction;
  });

  return fixedProductions;
}

function findUnitProduction(firstProductionName, secondProductionName, unitProductions) {
  var foundUnitProduction = null;

  unitProductions.some(function (unitProduction) {
    var unitProductionFound = unitProduction.isFoundByProductionNames(firstProductionName, secondProductionName);

    if (unitProductionFound) {
      foundUnitProduction = unitProduction;

      return true;
    }
  });

  var unitProduction = foundUnitProduction; ///

  return unitProduction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL2N5Y2xlcy5qcyJdLCJuYW1lcyI6WyJ0YXJqYW4iLCJyZXF1aXJlIiwicGFyc2VyVXRpbCIsIlByb2R1Y3Rpb24iLCJVbml0UHJvZHVjdGlvbiIsIlVuaXRzUHJvZHVjdGlvbiIsIkZpeGVkUHJvZHVjdGlvbiIsIk5vbkN5Y2xpY1Byb2R1Y3Rpb24iLCJHcmFwaCIsImN5Y2xlcyIsInByb2R1Y3Rpb25zIiwiZ3JhcGgiLCJncmFwaEZyb21Qcm9kdWN0aW9ucyIsImNvbXBvbmVudHMiLCJnZW5lcmF0ZUNvbXBvbmVudHMiLCJub25DeWNsaWNQcm9kdWN0aW9ucyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMiLCJtYXAiLCJwcm9kdWN0aW9uIiwicHJvZHVjdGlvbk5hbWUiLCJnZXROYW1lIiwibm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUiLCJub25DeWNsaWNQcm9kdWN0aW9uIiwiZmluZFByb2R1Y3Rpb24iLCJhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUiLCJhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJ1bml0c1Byb2R1Y3Rpb25zIiwidW5pdHNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyIsImZvckVhY2giLCJ1bml0c1Byb2R1Y3Rpb24iLCJ1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uTmFtZXMiLCJnZXRVbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcyIsInZlcnRleE5hbWUiLCJkZXNjZW5kYW50VmVydGV4TmFtZXMiLCJhZGRWZXJ0ZXgiLCJyZWR1Y2UiLCJmcm9tUHJvZHVjdGlvbiIsInB1c2giLCJjb21wb25lbnQiLCJjb21wb25lbnROb25DeWNsaWMiLCJpc05vbkN5Y2xpYyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50Iiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50IiwiZmlyc3RWZXJ0ZXhOYW1lIiwiZ2V0Rmlyc3RWZXJ0ZXhOYW1lIiwidW5pdFByb2R1Y3Rpb25zIiwidW5pdFByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImZpeGVkUHJvZHVjdGlvbnMiLCJmaXhlZFByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImFkZGVkUHJvZHVjdGlvbnMiLCJhZGRlZFByb2R1Y3Rpb25zRnJvbVVuaXRQcm9kdWN0aW9uc0FuZEZpeGVkUHJvZHVjdGlvbnMiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZFByb2R1Y3Rpb25zQW5kQWRkZWRQcm9kdWN0aW9ucyIsInJlbW92ZWRVbml0UHJvZHVjdGlvbnMiLCJ1bml0UHJvZHVjdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJ1bml0UHJvZHVjdGlvbiIsInNoaWZ0IiwidW5pdFByb2R1Y3Rpb25OYW1lIiwicmVtb3ZlZFVuaXRQcm9kdWN0aW9uIiwidW5pdFByb2R1Y3Rpb25Vbml0UHJvZHVjdGlvbk5hbWUiLCJnZXRVbml0UHJvZHVjdGlvbk5hbWUiLCJmaXhlZFByb2R1Y3Rpb25OYW1lIiwiZml4ZWRQcm9kdWN0aW9uIiwiYWRkZWRQcm9kdWN0aW9uTmFtZSIsImFkZGVkUHJvZHVjdGlvbiIsInNldE5hbWUiLCJmaXhlZFByb2R1Y3Rpb25EZWZpbml0aW9ucyIsImdldERlZmluaXRpb25zIiwiYWRkRGVmaW5pdGlvbnMiLCJpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbk5hbWUiLCJpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbiIsImludGVybWVkaWF0ZVVuaXRQcm9kdWN0aW9uVW5pdFByb2R1Y3Rpb25OYW1lIiwiZmlyc3RQcm9kdWN0aW9uTmFtZSIsInNlY29uZFByb2R1Y3Rpb25OYW1lIiwidW5pdFByb2R1Y3Rpb25Ob25DeWNsaWMiLCJmaW5kVW5pdFByb2R1Y3Rpb24iLCJmcm9tUHJvZHVjdGlvbk5hbWVzIiwidW5zaGlmdCIsImFkZGVkUHJvZHVjdGlvbkRlZmluaXRpb25zIiwibm9uQ3ljbGljUHJvZHVjdGlvbkRlZmluaXRpb25zRXhpc3QiLCJkb0RlZmluaXRpb25zRXhpc3QiLCJjb21wb25lbnRWZXJ0ZXhOYW1lcyIsImdldFZlcnRleE5hbWVzIiwidW5pdHNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQiLCJwcm9kdWN0aW9uTmFtZXMiLCJ1bml0UHJvZHVjdGlvbnNGcm9tVW5pdHNQcm9kdWN0aW9uc0FuZFByb2R1Y3Rpb25OYW1lcyIsInJlZHVjZVZlcnRleE5hbWVzIiwidW5pdHNQcm9kdWN0aW9uTmFtZSIsImZvckVhY2hVbml0RGVmaW5pdGlvbiIsInVuaXREZWZpbml0aW9uIiwibmFtZSIsImZyb21OYW1lQW5kVW5pdERlZmluaXRpb24iLCJ1bml0UHJvZHVjdGlvbk5vdEN5Y2xpYyIsImlzTm90Q3ljbGljIiwidW5pdFByb2R1Y3Rpb25JbmNsdWRlZEluUHJvZHVjdGlvbk5hbWVzIiwiaXNJbmNsdWRlZEluUHJvZHVjdGlvbk5hbWVzIiwibWFwVmVydGV4TmFtZXMiLCJmcm9tUHJvZHVjdGlvbkFuZFByb2R1Y3Rpb25OYW1lcyIsImZvdW5kVW5pdFByb2R1Y3Rpb24iLCJzb21lIiwidW5pdFByb2R1Y3Rpb25Gb3VuZCIsImlzRm91bmRCeVByb2R1Y3Rpb25OYW1lcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLFNBQVNDLFFBQVEsY0FBUixDQUFmOztBQUVBLElBQU1DLGFBQWFELFFBQVEsZ0JBQVIsQ0FBbkI7QUFBQSxJQUNNRSxhQUFhRixRQUFRLG1CQUFSLENBRG5CO0FBQUEsSUFFTUcsaUJBQWlCSCxRQUFRLG1CQUFSLENBRnZCO0FBQUEsSUFHTUksa0JBQWtCSixRQUFRLG9CQUFSLENBSHhCO0FBQUEsSUFJTUssa0JBQWtCTCxRQUFRLG9CQUFSLENBSnhCO0FBQUEsSUFLTU0sc0JBQXNCTixRQUFRLHdCQUFSLENBTDVCOztJQU9RTyxLLEdBQVVSLE0sQ0FBVlEsSzs7SUFFRkMsTTs7Ozs7Ozs4QkFDYUMsVyxFQUFhO0FBQzVCLFVBQU1DLFFBQVFDLHFCQUFxQkYsV0FBckIsQ0FBZDtBQUFBLFVBQ01HLGFBQWFG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QVNHLDZCQUFULENBQXVDVixTQUF2QyxFQUFrRDlCLFdBQWxELEVBQStEO0FBQzdELE1BQU15RSx1QkFBdUIzQyxVQUFVNEMsY0FBVixFQUE3QjtBQUFBLE1BQ01FLGtCQUFrQkgsb0JBRHhCO0FBQUEsTUFDOEM7QUFDeENsQyxxQkFBbUJULFVBQVUwRCxjQUFWLENBQXlCLFVBQVNoRSxVQUFULEVBQXFCO0FBQ3JFLFFBQU1mLGlCQUFpQmUsVUFBdkI7QUFBQSxRQUFvQztBQUM5QmhCLGlCQUFhaEIsV0FBV3FCLGNBQVgsQ0FBMEJKLGNBQTFCLEVBQTBDVCxXQUExQyxDQURuQjtBQUFBLFFBRU1zRCxrQkFBa0IxRCxnQkFBZ0I2RixnQ0FBaEIsQ0FBaURqRixVQUFqRCxFQUE2RG9FLGVBQTdELENBRnhCOztBQUlBLFdBQU90QixlQUFQO0FBQ0QsR0FOd0IsQ0FGekI7O0FBVUEsU0FBT2YsZ0JBQVA7QUFDRDs7QUFFRCxTQUFTNEIsa0JBQVQsQ0FBNEJILG1CQUE1QixFQUFpREMsb0JBQWpELEVBQXVFNUIsZUFBdkUsRUFBd0Y7QUFDdEYsTUFBSXFELHNCQUFzQixJQUExQjs7QUFFQXJELGtCQUFnQnNELElBQWhCLENBQXFCLFVBQVM1QyxjQUFULEVBQXlCO0FBQzVDLFFBQU02QyxzQkFBc0I3QyxlQUFlOEMsd0JBQWYsQ0FBd0M3QixtQkFBeEMsRUFBNkRDLG9CQUE3RCxDQUE1Qjs7QUFFQSxRQUFJMkIsbUJBQUosRUFBeUI7QUFDdkJGLDRCQUFzQjNDLGNBQXRCOztBQUVBLGFBQU8sSUFBUDtBQUNEO0FBQ0YsR0FSRDs7QUFVQSxNQUFNQSxpQkFBaUIyQyxtQkFBdkIsQ0Fic0YsQ0FhMUM7O0FBRTVDLFNBQU8zQyxjQUFQO0FBQ0QiLCJmaWxlIjoiY3ljbGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCB0YXJqYW4gPSByZXF1aXJlKCdvY2NhbS10YXJqYW4nKTtcblxuY29uc3QgcGFyc2VyVXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwvcGFyc2VyJyksXG4gICAgICBQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi4vYm5mL3Byb2R1Y3Rpb24nKSxcbiAgICAgIFVuaXRQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXQnKSxcbiAgICAgIFVuaXRzUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi91bml0cycpLFxuICAgICAgRml4ZWRQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL2ZpeGVkJyksXG4gICAgICBOb25DeWNsaWNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL25vbkN5Y2xpYycpO1xuXG5jb25zdCB7IEdyYXBoIH0gPSB0YXJqYW47XG5cbmNsYXNzIGN5Y2xlcyB7XG4gIHN0YXRpYyBlbGltaW5hdGUocHJvZHVjdGlvbnMpIHtcbiAgICBjb25zdCBncmFwaCA9IGdyYXBoRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgICBjb21wb25lbnRzID0gZ3JhcGguZ2VuZXJhdGVDb21wb25lbnRzKCksXG4gICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnMgPSBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnRzKGNvbXBvbmVudHMsIHByb2R1Y3Rpb25zKTtcblxuICAgIHByb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMubWFwKGZ1bmN0aW9uKHByb2R1Y3Rpb24pIHtcbiAgICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gcHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9uTmFtZSA9IHByb2R1Y3Rpb25OYW1lLCAvLy9cbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKG5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lLCBub25DeWNsaWNQcm9kdWN0aW9ucyk7XG4gICAgICBcbiAgICAgIGlmIChub25DeWNsaWNQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICAgIHByb2R1Y3Rpb24gPSBub25DeWNsaWNQcm9kdWN0aW9uOyAvLy9cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uTmFtZSA9IHByb2R1Y3Rpb25OYW1lLCAgLy8vXG4gICAgICAgICAgICAgIGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTsgIC8vL1xuXG4gICAgICAgIHByb2R1Y3Rpb24gPSBhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbjsgLy8vXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwcm9kdWN0aW9uO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25zO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gY3ljbGVzO1xuXG5mdW5jdGlvbiBncmFwaEZyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCBncmFwaCA9IG5ldyBHcmFwaCgpLFxuICAgICAgICB1bml0c1Byb2R1Y3Rpb25zID0gdW5pdHNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucyk7XG5cbiAgdW5pdHNQcm9kdWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHVuaXRzUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gdW5pdHNQcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uTmFtZXMgPSB1bml0c1Byb2R1Y3Rpb24uZ2V0VW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZXMoKSxcbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gcHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uTmFtZXM7IC8vL1xuXG4gICAgZ3JhcGguYWRkVmVydGV4KHZlcnRleE5hbWUsIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyk7XG4gIH0pO1xuXG4gIHJldHVybiBncmFwaDtcbn1cblxuZnVuY3Rpb24gdW5pdHNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0c1Byb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRzUHJvZHVjdGlvbnMsIHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCB1bml0c1Byb2R1Y3Rpb24gPSBVbml0c1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG5cbiAgICBpZiAodW5pdHNQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICB1bml0c1Byb2R1Y3Rpb25zLnB1c2godW5pdHNQcm9kdWN0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5pdHNQcm9kdWN0aW9ucztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0c1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnRzKGNvbXBvbmVudHMsIHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gY29tcG9uZW50cy5yZWR1Y2UoZnVuY3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbnMsIGNvbXBvbmVudCkge1xuICAgICAgICAgIGNvbnN0IGNvbXBvbmVudE5vbkN5Y2xpYyA9IGNvbXBvbmVudC5pc05vbkN5Y2xpYygpO1xuXG4gICAgICAgICAgaWYgKGNvbXBvbmVudE5vbkN5Y2xpYykge1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbkZyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBub25DeWNsaWNQcm9kdWN0aW9ucztcbiAgICAgICAgfSwgW10pO1xuXG4gIHJldHVybiBub25DeWNsaWNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbkZyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucywgbm9uQ3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgZmlyc3RWZXJ0ZXhOYW1lID0gY29tcG9uZW50LmdldEZpcnN0VmVydGV4TmFtZSgpLFxuICAgICAgICBwcm9kdWN0aW9uTmFtZSA9IGZpcnN0VmVydGV4TmFtZSwgIC8vL1xuICAgICAgICBwcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihwcm9kdWN0aW9uTmFtZSwgcHJvZHVjdGlvbnMpO1xuXG4gIGlmIChwcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgY29uc3Qgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IE5vbkN5Y2xpY1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG5cbiAgICBub25DeWNsaWNQcm9kdWN0aW9ucy5wdXNoKG5vbkN5Y2xpY1Byb2R1Y3Rpb24pO1xuICB9XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0UHJvZHVjdGlvbnMgPSB1bml0UHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMpLFxuICAgICAgICBmaXhlZFByb2R1Y3Rpb25zID0gZml4ZWRQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucyksXG4gICAgICAgIGFkZGVkUHJvZHVjdGlvbnMgPSBhZGRlZFByb2R1Y3Rpb25zRnJvbVVuaXRQcm9kdWN0aW9uc0FuZEZpeGVkUHJvZHVjdGlvbnModW5pdFByb2R1Y3Rpb25zLCBmaXhlZFByb2R1Y3Rpb25zKTtcblxuICBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZFByb2R1Y3Rpb25zQW5kQWRkZWRQcm9kdWN0aW9ucyhmaXhlZFByb2R1Y3Rpb25zLCBhZGRlZFByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucyk7XG59XG5cbmZ1bmN0aW9uIGFkZGVkUHJvZHVjdGlvbnNGcm9tVW5pdFByb2R1Y3Rpb25zQW5kRml4ZWRQcm9kdWN0aW9ucyh1bml0UHJvZHVjdGlvbnMsIGZpeGVkUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgYWRkZWRQcm9kdWN0aW9ucyA9IFtdLFxuICAgICAgICByZW1vdmVkVW5pdFByb2R1Y3Rpb25zID0gW107XG5cbiAgbGV0IHVuaXRQcm9kdWN0aW9uc0xlbmd0aCA9IHVuaXRQcm9kdWN0aW9ucy5sZW5ndGg7XG5cbiAgd2hpbGUgKHVuaXRQcm9kdWN0aW9uc0xlbmd0aCA+IDApIHtcbiAgICBsZXQgdW5pdFByb2R1Y3Rpb24gPSB1bml0UHJvZHVjdGlvbnMuc2hpZnQoKSxcbiAgICAgICAgdW5pdFByb2R1Y3Rpb25OYW1lID0gdW5pdFByb2R1Y3Rpb24uZ2V0TmFtZSgpO1xuXG4gICAgY29uc3QgcmVtb3ZlZFVuaXRQcm9kdWN0aW9uID0gdW5pdFByb2R1Y3Rpb247IC8vL1xuXG4gICAgcmVtb3ZlZFVuaXRQcm9kdWN0aW9ucy5wdXNoKHJlbW92ZWRVbml0UHJvZHVjdGlvbik7XG5cbiAgICBjb25zdCB1bml0UHJvZHVjdGlvblVuaXRQcm9kdWN0aW9uTmFtZSA9IHVuaXRQcm9kdWN0aW9uLmdldFVuaXRQcm9kdWN0aW9uTmFtZSgpLFxuICAgICAgICAgIGZpeGVkUHJvZHVjdGlvbk5hbWUgPSB1bml0UHJvZHVjdGlvblVuaXRQcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgIGZpeGVkUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oZml4ZWRQcm9kdWN0aW9uTmFtZSwgZml4ZWRQcm9kdWN0aW9ucyksXG4gICAgICAgICAgYWRkZWRQcm9kdWN0aW9uTmFtZSA9IHVuaXRQcm9kdWN0aW9uTmFtZTsgIC8vL1xuXG4gICAgbGV0IGFkZGVkUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oYWRkZWRQcm9kdWN0aW9uTmFtZSwgYWRkZWRQcm9kdWN0aW9ucyk7XG5cbiAgICBpZiAoYWRkZWRQcm9kdWN0aW9uID09PSBudWxsKSB7XG4gICAgICBhZGRlZFByb2R1Y3Rpb24gPSBQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKGZpeGVkUHJvZHVjdGlvbik7XG5cbiAgICAgIGFkZGVkUHJvZHVjdGlvbi5zZXROYW1lKGFkZGVkUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICBhZGRlZFByb2R1Y3Rpb25zLnB1c2goYWRkZWRQcm9kdWN0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZml4ZWRQcm9kdWN0aW9uRGVmaW5pdGlvbnMgPSBmaXhlZFByb2R1Y3Rpb24uZ2V0RGVmaW5pdGlvbnMoKTtcblxuICAgICAgYWRkZWRQcm9kdWN0aW9uLmFkZERlZmluaXRpb25zKGZpeGVkUHJvZHVjdGlvbkRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbk5hbWUgPSB1bml0UHJvZHVjdGlvblVuaXRQcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgICAgaW50ZXJtZWRpYXRlVW5pdFByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKGludGVybWVkaWF0ZVVuaXRQcm9kdWN0aW9uTmFtZSwgdW5pdFByb2R1Y3Rpb25zKTtcblxuICAgIGlmIChpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgaW50ZXJtZWRpYXRlVW5pdFByb2R1Y3Rpb25Vbml0UHJvZHVjdGlvbk5hbWUgPSBpbnRlcm1lZGlhdGVVbml0UHJvZHVjdGlvbi5nZXRVbml0UHJvZHVjdGlvbk5hbWUoKSxcbiAgICAgICAgICAgIGZpcnN0UHJvZHVjdGlvbk5hbWUgPSB1bml0UHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICAgIHNlY29uZFByb2R1Y3Rpb25OYW1lID0gaW50ZXJtZWRpYXRlVW5pdFByb2R1Y3Rpb25Vbml0UHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICAgIHVuaXRQcm9kdWN0aW9uTm9uQ3ljbGljID0gKGZpcnN0UHJvZHVjdGlvbk5hbWUgIT09IHNlY29uZFByb2R1Y3Rpb25OYW1lKTtcblxuICAgICAgaWYgKHVuaXRQcm9kdWN0aW9uTm9uQ3ljbGljKSB7XG4gICAgICAgIHVuaXRQcm9kdWN0aW9uID0gZmluZFVuaXRQcm9kdWN0aW9uKGZpcnN0UHJvZHVjdGlvbk5hbWUsIHNlY29uZFByb2R1Y3Rpb25OYW1lLCByZW1vdmVkVW5pdFByb2R1Y3Rpb25zKTtcblxuICAgICAgICBpZiAodW5pdFByb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgICAgICB1bml0UHJvZHVjdGlvbiA9IFVuaXRQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uTmFtZXMoZmlyc3RQcm9kdWN0aW9uTmFtZSwgc2Vjb25kUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICAgICAgdW5pdFByb2R1Y3Rpb25zLnVuc2hpZnQodW5pdFByb2R1Y3Rpb24pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdW5pdFByb2R1Y3Rpb25zTGVuZ3RoID0gdW5pdFByb2R1Y3Rpb25zLmxlbmd0aDtcbiAgfVxuXG4gIHJldHVybiBhZGRlZFByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZFByb2R1Y3Rpb25zQW5kQWRkZWRQcm9kdWN0aW9ucyhmaXhlZFByb2R1Y3Rpb25zLCBhZGRlZFByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucykge1xuICBmaXhlZFByb2R1Y3Rpb25zLmZvckVhY2goZnVuY3Rpb24oZml4ZWRQcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IGZpeGVkUHJvZHVjdGlvbiwgLy8vXG4gICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUgPSBub25DeWNsaWNQcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICBhZGRlZFByb2R1Y3Rpb25OYW1lID0gbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIC8vL1xuICAgICAgICAgIGFkZGVkUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oYWRkZWRQcm9kdWN0aW9uTmFtZSwgYWRkZWRQcm9kdWN0aW9ucyk7XG5cbiAgICBpZiAoYWRkZWRQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBhZGRlZFByb2R1Y3Rpb25EZWZpbml0aW9ucyA9IGFkZGVkUHJvZHVjdGlvbi5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICBub25DeWNsaWNQcm9kdWN0aW9uLmFkZERlZmluaXRpb25zKGFkZGVkUHJvZHVjdGlvbkRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9uRGVmaW5pdGlvbnNFeGlzdCA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb24uZG9EZWZpbml0aW9uc0V4aXN0KCk7XG5cbiAgICBpZiAobm9uQ3ljbGljUHJvZHVjdGlvbkRlZmluaXRpb25zRXhpc3QpIHtcbiAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLnB1c2gobm9uQ3ljbGljUHJvZHVjdGlvbik7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gdW5pdFByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGNvbXBvbmVudFZlcnRleE5hbWVzID0gY29tcG9uZW50LmdldFZlcnRleE5hbWVzKCksXG4gICAgICAgIHVuaXRzUHJvZHVjdGlvbnMgPSB1bml0c1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zKSxcbiAgICAgICAgcHJvZHVjdGlvbk5hbWVzID0gY29tcG9uZW50VmVydGV4TmFtZXMsICAvLy9cbiAgICAgICAgdW5pdFByb2R1Y3Rpb25zID0gdW5pdFByb2R1Y3Rpb25zRnJvbVVuaXRzUHJvZHVjdGlvbnNBbmRQcm9kdWN0aW9uTmFtZXModW5pdHNQcm9kdWN0aW9ucywgcHJvZHVjdGlvbk5hbWVzKTtcblxuICByZXR1cm4gdW5pdFByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiB1bml0c1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXRzUHJvZHVjdGlvbnMgPSBjb21wb25lbnQucmVkdWNlVmVydGV4TmFtZXMoZnVuY3Rpb24odW5pdHNQcm9kdWN0aW9ucywgdmVydGV4TmFtZSkge1xuICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gdmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyksXG4gICAgICAgICAgdW5pdHNQcm9kdWN0aW9uID0gVW5pdHNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuXG4gICAgaWYgKHVuaXRzUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgdW5pdHNQcm9kdWN0aW9ucy5wdXNoKHVuaXRzUHJvZHVjdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuaXRzUHJvZHVjdGlvbnM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gdW5pdHNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gdW5pdFByb2R1Y3Rpb25zRnJvbVVuaXRzUHJvZHVjdGlvbnNBbmRQcm9kdWN0aW9uTmFtZXModW5pdHNQcm9kdWN0aW9ucywgcHJvZHVjdGlvbk5hbWVzKSB7XG4gIGNvbnN0IHVuaXRQcm9kdWN0aW9ucyA9IHVuaXRzUHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRQcm9kdWN0aW9ucywgdW5pdHNQcm9kdWN0aW9uKSB7XG4gICAgY29uc3QgdW5pdHNQcm9kdWN0aW9uTmFtZSA9IHVuaXRzUHJvZHVjdGlvbi5nZXROYW1lKCk7XG5cbiAgICB1bml0c1Byb2R1Y3Rpb24uZm9yRWFjaFVuaXREZWZpbml0aW9uKGZ1bmN0aW9uKHVuaXREZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBuYW1lID0gdW5pdHNQcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgICAgICB1bml0UHJvZHVjdGlvbiA9IFVuaXRQcm9kdWN0aW9uLmZyb21OYW1lQW5kVW5pdERlZmluaXRpb24obmFtZSwgdW5pdERlZmluaXRpb24pLFxuICAgICAgICAgICAgdW5pdFByb2R1Y3Rpb25Ob3RDeWNsaWMgPSB1bml0UHJvZHVjdGlvbi5pc05vdEN5Y2xpYygpLFxuICAgICAgICAgICAgdW5pdFByb2R1Y3Rpb25JbmNsdWRlZEluUHJvZHVjdGlvbk5hbWVzID0gdW5pdFByb2R1Y3Rpb24uaXNJbmNsdWRlZEluUHJvZHVjdGlvbk5hbWVzKHByb2R1Y3Rpb25OYW1lcyk7XG4gICAgICBcbiAgICAgIGlmICh1bml0UHJvZHVjdGlvbk5vdEN5Y2xpYyAmJiB1bml0UHJvZHVjdGlvbkluY2x1ZGVkSW5Qcm9kdWN0aW9uTmFtZXMpIHtcbiAgICAgICAgdW5pdFByb2R1Y3Rpb25zLnB1c2godW5pdFByb2R1Y3Rpb24pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVuaXRQcm9kdWN0aW9ucztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0UHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGZpeGVkUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgY29tcG9uZW50VmVydGV4TmFtZXMgPSBjb21wb25lbnQuZ2V0VmVydGV4TmFtZXMoKSxcbiAgICAgICAgcHJvZHVjdGlvbk5hbWVzID0gY29tcG9uZW50VmVydGV4TmFtZXMsIC8vL1xuICAgICAgICBmaXhlZFByb2R1Y3Rpb25zID0gY29tcG9uZW50Lm1hcFZlcnRleE5hbWVzKGZ1bmN0aW9uKHZlcnRleE5hbWUpIHtcbiAgICBjb25zdCBwcm9kdWN0aW9uTmFtZSA9IHZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgICBwcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihwcm9kdWN0aW9uTmFtZSwgcHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGZpeGVkUHJvZHVjdGlvbiA9IEZpeGVkUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbkFuZFByb2R1Y3Rpb25OYW1lcyhwcm9kdWN0aW9uLCBwcm9kdWN0aW9uTmFtZXMpO1xuXG4gICAgcmV0dXJuIGZpeGVkUHJvZHVjdGlvbjtcbiAgfSk7XG5cbiAgcmV0dXJuIGZpeGVkUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGZpbmRVbml0UHJvZHVjdGlvbihmaXJzdFByb2R1Y3Rpb25OYW1lLCBzZWNvbmRQcm9kdWN0aW9uTmFtZSwgdW5pdFByb2R1Y3Rpb25zKSB7XG4gIGxldCBmb3VuZFVuaXRQcm9kdWN0aW9uID0gbnVsbDtcblxuICB1bml0UHJvZHVjdGlvbnMuc29tZShmdW5jdGlvbih1bml0UHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXRQcm9kdWN0aW9uRm91bmQgPSB1bml0UHJvZHVjdGlvbi5pc0ZvdW5kQnlQcm9kdWN0aW9uTmFtZXMoZmlyc3RQcm9kdWN0aW9uTmFtZSwgc2Vjb25kUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgaWYgKHVuaXRQcm9kdWN0aW9uRm91bmQpIHtcbiAgICAgIGZvdW5kVW5pdFByb2R1Y3Rpb24gPSB1bml0UHJvZHVjdGlvbjtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCB1bml0UHJvZHVjdGlvbiA9IGZvdW5kVW5pdFByb2R1Y3Rpb247IC8vL1xuXG4gIHJldHVybiB1bml0UHJvZHVjdGlvbjtcbn1cbiJdfQ==