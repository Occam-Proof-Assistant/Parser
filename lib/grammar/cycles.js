'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var tarjan = require('occam-tarjan');

var parserUtil = require('../util/parser'),
    Production = require('../common/production'),
    UnitDefinitionProduction = require('./production/unitDefinition'),
    UnitDefinitionsProduction = require('./production/unitDefinitions'),
    NonUnitDefinitionsProduction = require('./production/nonUnitDefinitions');

var Graph = tarjan.Graph;

var cycles = function () {
  function cycles() {
    _classCallCheck(this, cycles);
  }

  _createClass(cycles, null, [{
    key: 'eliminate',
    value: function eliminate(productions) {
      var unitDefinitionsProductions = unitDefinitionsProductionsFromProductions(productions),
          graph = graphFromUnitDefinitionsProductions(unitDefinitionsProductions),
          components = graph.generateComponents(),
          nonCyclicProductions = nonCyclicProductionsFromComponents(components, unitDefinitionsProductions);

      productions = productions.map(function (production) {
        var productionName = production.getName(),
            nonCyclicProduction = parserUtil.findProduction(productionName, nonCyclicProductions),
            alreadyNonCyclicProduction = parserUtil.findProduction(productionName, productions); ///

        production = nonCyclicProduction || alreadyNonCyclicProduction; ///

        return production;
      });

      return productions;
    }
  }]);

  return cycles;
}();

module.exports = cycles;

function unitDefinitionsProductionsFromProductions(productions) {
  var unitDefinitionsProductions = productions.reduce(function (unitDefinitionsProductions, production) {
    var unitDefinitionsProduction = UnitDefinitionsProduction.fromProduction(production);

    if (unitDefinitionsProduction !== null) {
      unitDefinitionsProductions.push(unitDefinitionsProduction);
    }

    return unitDefinitionsProductions;
  }, []);

  return unitDefinitionsProductions;
}

function graphFromUnitDefinitionsProductions(unitDefinitionsProductions) {
  var graph = new Graph();

  unitDefinitionsProductions.forEach(function (unitDefinitionsProduction) {
    var productionName = unitDefinitionsProduction.getName(),
        productionNames = unitDefinitionsProduction.getProductionNames(),
        unitDefinitionProductionNames = unitDefinitionProductionNamesFromProductionNames(productionNames, unitDefinitionsProductions),
        vertexName = productionName,
        ///
    descendantVertexNames = unitDefinitionProductionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function unitDefinitionProductionNamesFromProductionNames(productionNames, unitDefinitionProductions) {
  var unitDefinitionProductionNames = productionNames.reduce(function (unitDefinitionProductionNames, productionName) {
    var unitDefinitionProduction = parserUtil.findProduction(productionName, unitDefinitionProductions);

    if (unitDefinitionProduction !== null) {
      var unitDefinitionProductionName = productionName; ///

      unitDefinitionProductionNames.push(unitDefinitionProductionName);
    }

    return unitDefinitionProductionNames;
  }, []);

  return unitDefinitionProductionNames;
}

function nonCyclicProductionsFromComponents(components, unitDefinitionsProductions) {
  var nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      nonCyclicProductionFromComponent(component, unitDefinitionsProductions, nonCyclicProductions);
    } else {
      nonCyclicProductionsFromComponent(component, unitDefinitionsProductions, nonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function nonCyclicProductionFromComponent(component, unitDefinitionsProductions, nonCyclicProductions) {
  var firstVertex = component.getFirstVertex(),
      firstVertexName = firstVertex.getName(),
      nonCyclicProductionName = firstVertexName,
      ///
  nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, unitDefinitionsProductions);

  if (nonCyclicProduction !== null) {
    ///
    nonCyclicProductions.push(nonCyclicProduction);
  }
}

function nonCyclicProductionsFromComponent(component, unitDefinitionsProductions, nonCyclicProductions) {
  unitDefinitionsProductions = unitDefinitionsProductionsFromComponent(component, unitDefinitionsProductions); ///

  var unitDefinitionProductions = unitDefinitionProductionsFromUnitDefinitionsProductions(unitDefinitionsProductions),
      fixedProductions = fixedProductionsFromUnitDefinitionsProductions(unitDefinitionsProductions),
      removedProductions = [],
      addedProductions = [];

  var unitDefinitionProductionsLength = unitDefinitionProductions.length;

  while (unitDefinitionProductionsLength > 0) {
    var unitDefinitionProduction = unitDefinitionProductions.shift(),
        unitDefinitionProductionName = unitDefinitionProduction.getName();

    var removedProduction = unitDefinitionProduction;

    removedProductions.push(removedProduction);

    var unitDefinitionProductionUnitDefinitionProductionName = unitDefinitionProduction.getUnitDefinitionProductionName(),
        fixedProductionName = unitDefinitionProductionUnitDefinitionProductionName,
        ///
    addedProductionName = unitDefinitionProductionName,
        ///
    fixedProduction = parserUtil.findProduction(fixedProductionName, fixedProductions);

    var addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction === null) {
      addedProduction = Production.fromProduction(fixedProduction);

      addedProduction.setName(addedProductionName);

      addedProductions.push(addedProduction);
    } else {
      var fixedProductionDefinitions = fixedProduction.getDefinitions();

      addedProduction.addDefinitions(fixedProductionDefinitions);
    }

    var intermediateProductionName = unitDefinitionProductionUnitDefinitionProductionName,
        ///
    intermediateProduction = parserUtil.findProduction(intermediateProductionName, unitDefinitionProductions);

    if (intermediateProduction !== null) {
      var intermediateProductionUnitDefinitionProductionName = intermediateProduction.getUnitDefinitionProductionName(),
          _unitDefinitionProductionUnitDefinitionProductionName = intermediateProductionUnitDefinitionProductionName,
          ///
      unitDefinitionProductionNonCyclic = unitDefinitionProductionName !== _unitDefinitionProductionUnitDefinitionProductionName;

      if (unitDefinitionProductionNonCyclic) {
        unitDefinitionProduction = findUnitDefinitionProduction(unitDefinitionProductionName, _unitDefinitionProductionUnitDefinitionProductionName, removedProductions);

        if (unitDefinitionProduction === null) {
          unitDefinitionProduction = UnitDefinitionProduction.fromNameAndUnitDefinitionProductionName(unitDefinitionProductionName, _unitDefinitionProductionUnitDefinitionProductionName);

          unitDefinitionProductions.unshift(unitDefinitionProduction);
        }
      }
    }

    unitDefinitionProductionsLength = unitDefinitionProductions.length;
  }

  nonCyclicProductionsFromFixedAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions);
}

function nonCyclicProductionsFromFixedAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions) {
  fixedProductions.forEach(function (fixedProduction) {
    var nonCyclicProduction = fixedProduction,
        ///
    nonCyclicProductionName = nonCyclicProduction.getName(),
        addedProductionName = nonCyclicProductionName,
        ///
    addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction !== null) {
      var addedProductionDefinitions = addedProduction.getDefinitions();

      nonCyclicProduction.addDefinitions(addedProductionDefinitions);
    }

    nonCyclicProductions.push(nonCyclicProduction);
  });
}

function unitDefinitionsProductionsFromComponent(component, unitDefinitionsProductions) {
  var componentUnitDefinitionProductions = component.mapVertices(function (vertex) {
    var vertexName = vertex.getName(),
        componentUnitDefinitionName = vertexName,
        ///
    componentUnitDefinitionProduction = parserUtil.findProduction(componentUnitDefinitionName, unitDefinitionsProductions);

    return componentUnitDefinitionProduction;
  });

  unitDefinitionsProductions = componentUnitDefinitionProductions; ///

  return unitDefinitionsProductions;
}

function unitDefinitionProductionsFromUnitDefinitionsProductions(unitDefinitionsProductions) {
  var unitDefinitionProductions = unitDefinitionsProductions.reduce(function (unitDefinitionProductions, unitDefinitionsProduction) {
    var unitDefinitionsProductionName = unitDefinitionsProduction.getName();

    unitDefinitionsProduction.forEachUnitDefinition(function (unitDefinition) {
      var name = unitDefinitionsProductionName,
          ///
      unitDefinitionProduction = UnitDefinitionProduction.fromNameAndUnitDefinition(name, unitDefinition);

      unitDefinitionProductions.push(unitDefinitionProduction);
    });

    return unitDefinitionProductions;
  }, []);

  return unitDefinitionProductions;
}

function fixedProductionsFromUnitDefinitionsProductions(unitDefinitionsProductions) {
  var fixedProductions = unitDefinitionsProductions.map(function (unitDefinitionsProduction) {
    var nonUnitProduction = NonUnitDefinitionsProduction.fromUnitDefinitionsProduction(unitDefinitionsProduction),
        fixedProduction = nonUnitProduction; ///

    return fixedProduction;
  });

  return fixedProductions;
}

function findUnitDefinitionProduction(productionName, unitDefinitionProductionName, unitDefinitionProductions) {
  var firstProductionName = productionName,
      ///
  secondProductionName = unitDefinitionProductionName; ///

  var foundUnitDefinitionProduction = null;

  unitDefinitionProductions.some(function (unitDefinitionProduction) {
    var unitDefinitionProductionFound = unitDefinitionProduction.isFoundByProductionNames(firstProductionName, secondProductionName);

    if (unitDefinitionProductionFound) {
      foundUnitDefinitionProduction = unitDefinitionProduction;

      return true;
    }
  });

  var unitDefinitionProduction = foundUnitDefinitionProduction; ///

  return unitDefinitionProduction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL2N5Y2xlcy5qcyJdLCJuYW1lcyI6WyJ0YXJqYW4iLCJyZXF1aXJlIiwicGFyc2VyVXRpbCIsIlByb2R1Y3Rpb24iLCJVbml0RGVmaW5pdGlvblByb2R1Y3Rpb24iLCJVbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uIiwiTm9uVW5pdERlZmluaXRpb25zUHJvZHVjdGlvbiIsIkdyYXBoIiwiY3ljbGVzIiwicHJvZHVjdGlvbnMiLCJ1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyIsInVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwiZ3JhcGgiLCJncmFwaEZyb21Vbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyIsImNvbXBvbmVudHMiLCJnZW5lcmF0ZUNvbXBvbmVudHMiLCJub25DeWNsaWNQcm9kdWN0aW9ucyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMiLCJtYXAiLCJwcm9kdWN0aW9uIiwicHJvZHVjdGlvbk5hbWUiLCJnZXROYW1lIiwibm9uQ3ljbGljUHJvZHVjdGlvbiIsImZpbmRQcm9kdWN0aW9uIiwiYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb24iLCJtb2R1bGUiLCJleHBvcnRzIiwicmVkdWNlIiwidW5pdERlZmluaXRpb25zUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uIiwicHVzaCIsImZvckVhY2giLCJwcm9kdWN0aW9uTmFtZXMiLCJnZXRQcm9kdWN0aW9uTmFtZXMiLCJ1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcyIsInVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWVzRnJvbVByb2R1Y3Rpb25OYW1lcyIsInZlcnRleE5hbWUiLCJkZXNjZW5kYW50VmVydGV4TmFtZXMiLCJhZGRWZXJ0ZXgiLCJ1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zIiwidW5pdERlZmluaXRpb25Qcm9kdWN0aW9uIiwidW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSIsImNvbXBvbmVudCIsImNvbXBvbmVudE5vbkN5Y2xpYyIsImlzTm9uQ3ljbGljIiwibm9uQ3ljbGljUHJvZHVjdGlvbkZyb21Db21wb25lbnQiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQiLCJmaXJzdFZlcnRleCIsImdldEZpcnN0VmVydGV4IiwiZmlyc3RWZXJ0ZXhOYW1lIiwibm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUiLCJ1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uc0Zyb21Db21wb25lbnQiLCJ1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zRnJvbVVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zIiwiZml4ZWRQcm9kdWN0aW9ucyIsImZpeGVkUHJvZHVjdGlvbnNGcm9tVW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMiLCJyZW1vdmVkUHJvZHVjdGlvbnMiLCJhZGRlZFByb2R1Y3Rpb25zIiwidW5pdERlZmluaXRpb25Qcm9kdWN0aW9uc0xlbmd0aCIsImxlbmd0aCIsInNoaWZ0IiwicmVtb3ZlZFByb2R1Y3Rpb24iLCJ1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25Vbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lIiwiZ2V0VW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSIsImZpeGVkUHJvZHVjdGlvbk5hbWUiLCJhZGRlZFByb2R1Y3Rpb25OYW1lIiwiZml4ZWRQcm9kdWN0aW9uIiwiYWRkZWRQcm9kdWN0aW9uIiwic2V0TmFtZSIsImZpeGVkUHJvZHVjdGlvbkRlZmluaXRpb25zIiwiZ2V0RGVmaW5pdGlvbnMiLCJhZGREZWZpbml0aW9ucyIsImludGVybWVkaWF0ZVByb2R1Y3Rpb25OYW1lIiwiaW50ZXJtZWRpYXRlUHJvZHVjdGlvbiIsImludGVybWVkaWF0ZVByb2R1Y3Rpb25Vbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lIiwidW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTm9uQ3ljbGljIiwiZmluZFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiIsImZyb21OYW1lQW5kVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSIsInVuc2hpZnQiLCJub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21GaXhlZEFuZEFkZGVkUHJvZHVjdGlvbnMiLCJhZGRlZFByb2R1Y3Rpb25EZWZpbml0aW9ucyIsImNvbXBvbmVudFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbnMiLCJtYXBWZXJ0aWNlcyIsInZlcnRleCIsImNvbXBvbmVudFVuaXREZWZpbml0aW9uTmFtZSIsImNvbXBvbmVudFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiIsInVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25OYW1lIiwiZm9yRWFjaFVuaXREZWZpbml0aW9uIiwidW5pdERlZmluaXRpb24iLCJuYW1lIiwiZnJvbU5hbWVBbmRVbml0RGVmaW5pdGlvbiIsIm5vblVuaXRQcm9kdWN0aW9uIiwiZnJvbVVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24iLCJmaXJzdFByb2R1Y3Rpb25OYW1lIiwic2Vjb25kUHJvZHVjdGlvbk5hbWUiLCJmb3VuZFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiIsInNvbWUiLCJ1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25Gb3VuZCIsImlzRm91bmRCeVByb2R1Y3Rpb25OYW1lcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLFNBQVNDLFFBQVEsY0FBUixDQUFmOztBQUVBLElBQU1DLGFBQWFELFFBQVEsZ0JBQVIsQ0FBbkI7QUFBQSxJQUNNRSxhQUFhRixRQUFRLHNCQUFSLENBRG5CO0FBQUEsSUFFTUcsMkJBQTJCSCxRQUFRLDZCQUFSLENBRmpDO0FBQUEsSUFHTUksNEJBQTRCSixRQUFRLDhCQUFSLENBSGxDO0FBQUEsSUFJTUssK0JBQStCTCxRQUFRLGlDQUFSLENBSnJDOztJQU1RTSxLLEdBQVVQLE0sQ0FBVk8sSzs7SUFFRkMsTTs7Ozs7Ozs4QkFDYUMsVyxFQUFhO0FBQzVCLFVBQU1DLDZCQUE2QkMsMENBQTBDRixXQUExQyxDQUFuQztBQUFBLFVBQ01HLFFBQVFDLG9DQUFvQ0gs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QUQ2RyxDQUVqRDs7QUFFNUQsTUFBSXFELGdDQUFnQyxJQUFwQzs7QUFFQXZELDRCQUEwQndELElBQTFCLENBQStCLFVBQVN2RCx3QkFBVCxFQUFtQztBQUNoRSxRQUFNd0QsZ0NBQWdDeEQseUJBQXlCeUQsd0JBQXpCLENBQWtETCxtQkFBbEQsRUFBdUVDLG9CQUF2RSxDQUF0Qzs7QUFFQSxRQUFJRyw2QkFBSixFQUFtQztBQUNqQ0Ysc0NBQWdDdEQsd0JBQWhDOztBQUVBLGFBQU8sSUFBUDtBQUNEO0FBQ0YsR0FSRDs7QUFVQSxNQUFNQSwyQkFBMkJzRCw2QkFBakMsQ0FoQjZHLENBZ0I3Qzs7QUFFaEUsU0FBT3RELHdCQUFQO0FBQ0QiLCJmaWxlIjoiY3ljbGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCB0YXJqYW4gPSByZXF1aXJlKCdvY2NhbS10YXJqYW4nKTtcblxuY29uc3QgcGFyc2VyVXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwvcGFyc2VyJyksXG4gICAgICBQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi4vY29tbW9uL3Byb2R1Y3Rpb24nKSxcbiAgICAgIFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi91bml0RGVmaW5pdGlvbicpLFxuICAgICAgVW5pdERlZmluaXRpb25zUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi91bml0RGVmaW5pdGlvbnMnKSxcbiAgICAgIE5vblVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24gPSByZXF1aXJlKCcuL3Byb2R1Y3Rpb24vbm9uVW5pdERlZmluaXRpb25zJyk7XG5cbmNvbnN0IHsgR3JhcGggfSA9IHRhcmphbjtcblxuY2xhc3MgY3ljbGVzIHtcbiAgc3RhdGljIGVsaW1pbmF0ZShwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zID0gdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGdyYXBoID0gZ3JhcGhGcm9tVW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnModW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGNvbXBvbmVudHMgPSBncmFwaC5nZW5lcmF0ZUNvbXBvbmVudHMoKSxcbiAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9ucyA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMoY29tcG9uZW50cywgdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMpO1xuXG4gICAgcHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5tYXAoZnVuY3Rpb24ocHJvZHVjdGlvbikge1xuICAgICAgY29uc3QgcHJvZHVjdGlvbk5hbWUgPSBwcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBub25DeWNsaWNQcm9kdWN0aW9ucyksXG4gICAgICAgICAgICBhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24ocHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKTsgIC8vL1xuXG4gICAgICBwcm9kdWN0aW9uID0gbm9uQ3ljbGljUHJvZHVjdGlvbiB8fCBhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbjsgLy8vXG5cbiAgICAgIHJldHVybiBwcm9kdWN0aW9uO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25zO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gY3ljbGVzO1xuXG5mdW5jdGlvbiB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLnJlZHVjZShmdW5jdGlvbih1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucywgcHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24gPSBVbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuXG4gICAgaWYgKHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zLnB1c2godW5pdERlZmluaXRpb25zUHJvZHVjdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBncmFwaEZyb21Vbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyh1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucykge1xuICBjb25zdCBncmFwaCA9IG5ldyBHcmFwaCgpO1xuXG4gIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zLmZvckVhY2goZnVuY3Rpb24odW5pdERlZmluaXRpb25zUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgcHJvZHVjdGlvbk5hbWVzID0gdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbi5nZXRQcm9kdWN0aW9uTmFtZXMoKSxcbiAgICAgICAgICB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcyA9IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWVzRnJvbVByb2R1Y3Rpb25OYW1lcyhwcm9kdWN0aW9uTmFtZXMsIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zKSxcbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gcHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lczsgLy8vXG5cbiAgICBncmFwaC5hZGRWZXJ0ZXgodmVydGV4TmFtZSwgZGVzY2VuZGFudFZlcnRleE5hbWVzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIGdyYXBoO1xufVxuXG5mdW5jdGlvbiB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lc0Zyb21Qcm9kdWN0aW9uTmFtZXMocHJvZHVjdGlvbk5hbWVzLCB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWVzID0gcHJvZHVjdGlvbk5hbWVzLnJlZHVjZShmdW5jdGlvbih1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcywgcHJvZHVjdGlvbk5hbWUpIHtcbiAgICBjb25zdCB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zKTtcbiAgICBcbiAgICBpZiAodW5pdERlZmluaXRpb25Qcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lID0gcHJvZHVjdGlvbk5hbWU7ICAvLy9cblxuICAgICAgdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZXMucHVzaCh1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lKTtcbiAgICB9ICAgIFxuICAgIFxuICAgIHJldHVybiB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lcztcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucykge1xuICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9ucyA9IGNvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLCBjb21wb25lbnQpIHtcbiAgICAgICAgICBjb25zdCBjb21wb25lbnROb25DeWNsaWMgPSBjb21wb25lbnQuaXNOb25DeWNsaWMoKTtcblxuICAgICAgICAgIGlmIChjb21wb25lbnROb25DeWNsaWMpIHtcbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG4gICAgICAgIH0sIFtdKTtcblxuICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0VmVydGV4ID0gY29tcG9uZW50LmdldEZpcnN0VmVydGV4KCksXG4gICAgICAgIGZpcnN0VmVydGV4TmFtZSA9IGZpcnN0VmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUgPSBmaXJzdFZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24obm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zKTtcblxuICBpZiAobm9uQ3ljbGljUHJvZHVjdGlvbiAhPT0gbnVsbCkgeyAvLy9cbiAgICBub25DeWNsaWNQcm9kdWN0aW9ucy5wdXNoKG5vbkN5Y2xpY1Byb2R1Y3Rpb24pO1xuICB9XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucykge1xuICB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyA9IHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zKTsgIC8vL1xuICBcbiAgY29uc3QgdW5pdERlZmluaXRpb25Qcm9kdWN0aW9ucyA9IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbnNGcm9tVW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnModW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMpLFxuICAgICAgICBmaXhlZFByb2R1Y3Rpb25zID0gZml4ZWRQcm9kdWN0aW9uc0Zyb21Vbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyh1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyksXG4gICAgICAgIHJlbW92ZWRQcm9kdWN0aW9ucyA9IFtdLFxuICAgICAgICBhZGRlZFByb2R1Y3Rpb25zID0gW107XG5cbiAgbGV0IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbnNMZW5ndGggPSB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zLmxlbmd0aDtcblxuICB3aGlsZSAodW5pdERlZmluaXRpb25Qcm9kdWN0aW9uc0xlbmd0aCA+IDApIHtcbiAgICBsZXQgdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9ucy5zaGlmdCgpLFxuICAgICAgICB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uLmdldE5hbWUoKTtcblxuICAgIGNvbnN0IHJlbW92ZWRQcm9kdWN0aW9uID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uO1xuXG4gICAgcmVtb3ZlZFByb2R1Y3Rpb25zLnB1c2gocmVtb3ZlZFByb2R1Y3Rpb24pO1xuXG4gICAgY29uc3QgdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSA9IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbi5nZXRVbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lKCksXG4gICAgICAgICAgZml4ZWRQcm9kdWN0aW9uTmFtZSA9IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvblVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBhZGRlZFByb2R1Y3Rpb25OYW1lID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgIGZpeGVkUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oZml4ZWRQcm9kdWN0aW9uTmFtZSwgZml4ZWRQcm9kdWN0aW9ucyk7XG5cbiAgICBsZXQgYWRkZWRQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhZGRlZFByb2R1Y3Rpb25OYW1lLCBhZGRlZFByb2R1Y3Rpb25zKTtcblxuICAgIGlmIChhZGRlZFByb2R1Y3Rpb24gPT09IG51bGwpIHtcbiAgICAgIGFkZGVkUHJvZHVjdGlvbiA9IFByb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24oZml4ZWRQcm9kdWN0aW9uKTtcblxuICAgICAgYWRkZWRQcm9kdWN0aW9uLnNldE5hbWUoYWRkZWRQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICAgIGFkZGVkUHJvZHVjdGlvbnMucHVzaChhZGRlZFByb2R1Y3Rpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBmaXhlZFByb2R1Y3Rpb25EZWZpbml0aW9ucyA9IGZpeGVkUHJvZHVjdGlvbi5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICBhZGRlZFByb2R1Y3Rpb24uYWRkRGVmaW5pdGlvbnMoZml4ZWRQcm9kdWN0aW9uRGVmaW5pdGlvbnMpO1xuICAgIH1cblxuICAgIGNvbnN0IGludGVybWVkaWF0ZVByb2R1Y3Rpb25OYW1lID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgICAgaW50ZXJtZWRpYXRlUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oaW50ZXJtZWRpYXRlUHJvZHVjdGlvbk5hbWUsIHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbnMpO1xuXG4gICAgaWYgKGludGVybWVkaWF0ZVByb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGludGVybWVkaWF0ZVByb2R1Y3Rpb25Vbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lID0gaW50ZXJtZWRpYXRlUHJvZHVjdGlvbi5nZXRVbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lKCksXG4gICAgICAgICAgICB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25Vbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lID0gaW50ZXJtZWRpYXRlUHJvZHVjdGlvblVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICAgIHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5vbkN5Y2xpYyA9ICh1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lICE9PSB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25Vbml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lKTtcblxuICAgICAgaWYgKHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5vbkN5Y2xpYykge1xuICAgICAgICB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb24gPSBmaW5kVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uKHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWUsIHVuaXREZWZpbml0aW9uUHJvZHVjdGlvblVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWUsIHJlbW92ZWRQcm9kdWN0aW9ucyk7XG5cbiAgICAgICAgaWYgKHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiA9PT0gbnVsbCkge1xuICAgICAgICAgIHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiA9IFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbi5mcm9tTmFtZUFuZFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbk5hbWUodW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSwgdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZSk7XG5cbiAgICAgICAgICB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zLnVuc2hpZnQodW5pdERlZmluaXRpb25Qcm9kdWN0aW9uKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbnNMZW5ndGggPSB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zLmxlbmd0aDtcbiAgfVxuXG4gIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUZpeGVkQW5kQWRkZWRQcm9kdWN0aW9ucyhmaXhlZFByb2R1Y3Rpb25zLCBhZGRlZFByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucyk7XG59XG5cbmZ1bmN0aW9uIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUZpeGVkQW5kQWRkZWRQcm9kdWN0aW9ucyhmaXhlZFByb2R1Y3Rpb25zLCBhZGRlZFByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucykge1xuICBmaXhlZFByb2R1Y3Rpb25zLmZvckVhY2goZnVuY3Rpb24oZml4ZWRQcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uQ3ljbGljUHJvZHVjdGlvbiA9IGZpeGVkUHJvZHVjdGlvbiwgLy8vXG4gICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUgPSBub25DeWNsaWNQcm9kdWN0aW9uLmdldE5hbWUoKSxcbiAgICAgICAgICBhZGRlZFByb2R1Y3Rpb25OYW1lID0gbm9uQ3ljbGljUHJvZHVjdGlvbk5hbWUsIC8vL1xuICAgICAgICAgIGFkZGVkUHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oYWRkZWRQcm9kdWN0aW9uTmFtZSwgYWRkZWRQcm9kdWN0aW9ucyk7XG5cbiAgICBpZiAoYWRkZWRQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBhZGRlZFByb2R1Y3Rpb25EZWZpbml0aW9ucyA9IGFkZGVkUHJvZHVjdGlvbi5nZXREZWZpbml0aW9ucygpO1xuXG4gICAgICBub25DeWNsaWNQcm9kdWN0aW9uLmFkZERlZmluaXRpb25zKGFkZGVkUHJvZHVjdGlvbkRlZmluaXRpb25zKTtcbiAgICB9XG5cbiAgICBub25DeWNsaWNQcm9kdWN0aW9ucy5wdXNoKG5vbkN5Y2xpY1Byb2R1Y3Rpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgY29tcG9uZW50VW5pdERlZmluaXRpb25Qcm9kdWN0aW9ucyA9IGNvbXBvbmVudC5tYXBWZXJ0aWNlcyhmdW5jdGlvbih2ZXJ0ZXgpIHtcbiAgICBjb25zdCB2ZXJ0ZXhOYW1lID0gdmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgICBjb21wb25lbnRVbml0RGVmaW5pdGlvbk5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgY29tcG9uZW50VW5pdERlZmluaXRpb25Qcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihjb21wb25lbnRVbml0RGVmaW5pdGlvbk5hbWUsIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zKTtcblxuICAgIHJldHVybiBjb21wb25lbnRVbml0RGVmaW5pdGlvblByb2R1Y3Rpb247XG4gIH0pO1xuXG4gIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zID0gY29tcG9uZW50VW5pdERlZmluaXRpb25Qcm9kdWN0aW9uczsgIC8vL1xuXG4gIHJldHVybiB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uc0Zyb21Vbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucyh1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zID0gdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbnMsIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24pIHtcbiAgICBjb25zdCB1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uTmFtZSA9IHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24uZ2V0TmFtZSgpO1xuICAgIFxuICAgIHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24uZm9yRWFjaFVuaXREZWZpbml0aW9uKGZ1bmN0aW9uKHVuaXREZWZpbml0aW9uKSB7XG4gICAgICBjb25zdCBuYW1lID0gdW5pdERlZmluaXRpb25zUHJvZHVjdGlvbk5hbWUsIC8vL1xuICAgICAgICAgICAgdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uID0gVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uLmZyb21OYW1lQW5kVW5pdERlZmluaXRpb24obmFtZSwgdW5pdERlZmluaXRpb24pO1xuXG4gICAgICB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zLnB1c2godW5pdERlZmluaXRpb25Qcm9kdWN0aW9uKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGZpeGVkUHJvZHVjdGlvbnNGcm9tVW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnModW5pdERlZmluaXRpb25zUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgZml4ZWRQcm9kdWN0aW9ucyA9IHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb25zLm1hcChmdW5jdGlvbih1bml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uVW5pdFByb2R1Y3Rpb24gPSBOb25Vbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uLmZyb21Vbml0RGVmaW5pdGlvbnNQcm9kdWN0aW9uKHVuaXREZWZpbml0aW9uc1Byb2R1Y3Rpb24pLFxuICAgICAgICAgIGZpeGVkUHJvZHVjdGlvbiA9IG5vblVuaXRQcm9kdWN0aW9uOyAvLy9cbiAgICBcbiAgICByZXR1cm4gZml4ZWRQcm9kdWN0aW9uO1xuICB9KTtcbiAgXG4gIHJldHVybiBmaXhlZFByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBmaW5kVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25OYW1lLCB1bml0RGVmaW5pdGlvblByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0UHJvZHVjdGlvbk5hbWUgPSBwcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgIHNlY29uZFByb2R1Y3Rpb25OYW1lID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uTmFtZTsgIC8vL1xuXG4gIGxldCBmb3VuZFVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiA9IG51bGw7XG5cbiAgdW5pdERlZmluaXRpb25Qcm9kdWN0aW9ucy5zb21lKGZ1bmN0aW9uKHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbkZvdW5kID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uLmlzRm91bmRCeVByb2R1Y3Rpb25OYW1lcyhmaXJzdFByb2R1Y3Rpb25OYW1lLCBzZWNvbmRQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICBpZiAodW5pdERlZmluaXRpb25Qcm9kdWN0aW9uRm91bmQpIHtcbiAgICAgIGZvdW5kVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uID0gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHVuaXREZWZpbml0aW9uUHJvZHVjdGlvbiA9IGZvdW5kVW5pdERlZmluaXRpb25Qcm9kdWN0aW9uOyAvLy9cblxuICByZXR1cm4gdW5pdERlZmluaXRpb25Qcm9kdWN0aW9uO1xufVxuIl19