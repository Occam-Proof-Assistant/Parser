'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Graph = require('./graph'),
    parserUtil = require('../util/parser'),
    Production = require('../common/production'),
    UnitRuleProduction = require('./production/unitRule'),
    UnitRulesProduction = require('./production/unitRules'),
    NonUnitRulesProduction = require('./production/nonUnitRules');

var cycles = function () {
  function cycles() {
    _classCallCheck(this, cycles);
  }

  _createClass(cycles, null, [{
    key: 'eliminate',
    value: function eliminate(productions) {
      var graph = graphFromProductions(productions),
          components = graph.generateComponents(),
          nonCyclicProductions = nonCyclicProductionsFromComponents(components, productions),
          alreadyNonCyclicProductions = alreadyNonCyclicProductionsFromGraph(graph, productions);

      productions = [].concat(nonCyclicProductions).concat(alreadyNonCyclicProductions);

      return productions;
    }
  }]);

  return cycles;
}();

module.exports = cycles;

function graphFromProductions(productions) {
  var unitRulesProductions = unitRulesProductionsFromProductions(productions),
      graph = graphFromUnitRulesProductions(unitRulesProductions);

  return graph;
}

function unitRulesProductionsFromProductions(productions) {
  var unitRulesProductions = productions.reduce(function (unitRulesProductions, production) {
    var unitRulesProduction = UnitRulesProduction.fromProduction(production);

    if (unitRulesProduction !== null) {
      unitRulesProductions.push(unitRulesProduction);
    }

    return unitRulesProductions;
  }, []);

  return unitRulesProductions;
}

function graphFromUnitRulesProductions(unitRulesProductions) {
  var graph = new Graph();

  unitRulesProductions.forEach(function (unitRulesProduction) {
    var productionName = unitRulesProduction.getName(),
        productionNames = unitRulesProduction.getProductionNames(),
        vertexName = productionName,
        ///
    descendantVertexNames = productionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function nonCyclicProductionsFromComponents(components, productions) {
  var nonCyclicProductions = components.reduce(function (nonCyclicProductions, component) {
    var componentNonCyclic = component.isNonCyclic();

    if (componentNonCyclic) {
      nonCyclicProductionFromComponent(component, productions, nonCyclicProductions);
    } else {
      nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions);
    }

    return nonCyclicProductions;
  }, []);

  return nonCyclicProductions;
}

function alreadyNonCyclicProductionsFromGraph(graph, productions) {
  var alreadyNonCyclicProductions = productions.filter(function (production) {
    var productionName = production.getName(),
        vertexName = productionName,
        ///
    vertexPresent = graph.isVertexPresent(vertexName),
        productionAlreadyNonCyclic = !vertexPresent; ///

    return productionAlreadyNonCyclic;
  });

  return alreadyNonCyclicProductions;
}

function nonCyclicProductionFromComponent(component, productions, nonCyclicProductions) {
  var firstVertex = component.getFirstVertex(),
      firstVertexName = firstVertex.getName(),
      nonCyclicProductionName = firstVertexName,
      ///
  nonCyclicProduction = parserUtil.findProduction(nonCyclicProductionName, productions);

  nonCyclicProductions.push(nonCyclicProduction);
}

function nonCyclicProductionsFromComponent(component, productions, nonCyclicProductions) {
  productions = productionsFromComponent(component, productions); ///

  var fixedProductions = fixedProductionsFromProductions(productions),
      unitRuleProductions = unitRuleProductionsFromProductions(productions),
      removedProductions = [],
      addedProductions = [];

  var unitRuleProductionsLength = unitRuleProductions.length;

  while (unitRuleProductionsLength > 0) {
    var unitRuleProduction = unitRuleProductions.shift(),
        unitRuleProductionName = unitRuleProduction.getName();

    var removedProduction = unitRuleProduction;

    removedProductions.push(removedProduction);

    var unitRuleProductionUnitRuleProductionName = unitRuleProduction.getUnitRuleProductionName(),
        fixedProductionName = unitRuleProductionUnitRuleProductionName,
        ///
    addedProductionName = unitRuleProductionName,
        ///
    fixedProduction = parserUtil.findProduction(fixedProductionName, fixedProductions);

    var addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction === null) {
      addedProduction = Production.fromProduction(fixedProduction);

      addedProduction.setName(addedProductionName);

      addedProductions.push(addedProduction);
    } else {
      var fixedProductionRules = fixedProduction.getRules();

      addedProduction.concatRules(fixedProductionRules);
    }

    var intermediateProductionName = unitRuleProductionUnitRuleProductionName,
        ///
    intermediateProduction = parserUtil.findProduction(intermediateProductionName, unitRuleProductions);

    if (intermediateProduction !== null) {
      var intermediateProductionUnitRuleProductionName = intermediateProduction.getUnitRuleProductionName(),
          _unitRuleProductionUnitRuleProductionName = intermediateProductionUnitRuleProductionName,
          ///
      unitRuleProductionNonCyclic = unitRuleProductionName !== _unitRuleProductionUnitRuleProductionName;

      if (unitRuleProductionNonCyclic) {
        unitRuleProduction = findUnitRuleProduction(unitRuleProductionName, _unitRuleProductionUnitRuleProductionName, removedProductions);

        if (unitRuleProduction === null) {
          unitRuleProduction = UnitRuleProduction.fromNameAndUnitRuleProductionName(unitRuleProductionName, _unitRuleProductionUnitRuleProductionName);

          unitRuleProductions.unshift(unitRuleProduction);
        }
      }
    }

    unitRuleProductionsLength = unitRuleProductions.length;
  }

  nonCyclicProductionsFromFixedAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions);
}

function nonCyclicProductionsFromFixedAndAddedProductions(fixedProductions, addedProductions, nonCyclicProductions) {
  fixedProductions.forEach(function (fixedProduction) {
    var nonCyclicProduction = fixedProduction,
        ///
    nonCyclicProductionName = nonCyclicProduction.getName(),
        addedProductionName = nonCyclicProductionName,
        ///
    addedProduction = parserUtil.findProduction(addedProductionName, addedProductions);

    if (addedProduction !== null) {
      var addedProductionRules = addedProduction.getRules();

      nonCyclicProduction.concatRules(addedProductionRules);
    }

    nonCyclicProductions.push(nonCyclicProduction);
  });
}

function productionsFromComponent(component, productions) {
  productions = component.mapVertices(function (vertex) {
    var vertexName = vertex.getName(),
        productionName = vertexName,
        ///
    production = parserUtil.findProduction(productionName, productions);

    return production;
  });

  return productions;
}

function unitRuleProductionsFromProductions(productions) {
  var unitRuleProductions = productions.reduce(function (unitRuleProductions, production) {
    var name = production.getName(),
        unitRulesProduction = UnitRulesProduction.fromProduction(production);

    unitRulesProduction.forEachUnitRule(function (unitRule) {
      var unitRuleProduction = UnitRuleProduction.fromNameAndUnitRule(name, unitRule);

      unitRuleProductions.push(unitRuleProduction);
    });

    return unitRuleProductions;
  }, []);

  return unitRuleProductions;
}

function fixedProductionsFromProductions(productions) {
  var fixedProductions = productions.map(function (production) {
    var nonUnitProduction = NonUnitRulesProduction.fromProduction(production),
        fixedProduction = nonUnitProduction; ///

    return fixedProduction;
  });

  return fixedProductions;
}

function findUnitRuleProduction(productionName, unitRuleProductionName, unitRuleProductions) {
  var firstProductionName = productionName,
      ///
  secondProductionName = unitRuleProductionName; ///

  var foundUnitRuleProduction = null;

  unitRuleProductions.some(function (unitRuleProduction) {
    var unitRuleProductionFound = unitRuleProduction.isFoundByProductionNames(firstProductionName, secondProductionName);

    if (unitRuleProductionFound) {
      foundUnitRuleProduction = unitRuleProduction;

      return true;
    }
  });

  var unitRuleProduction = foundUnitRuleProduction; ///

  return unitRuleProduction;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9ncmFtbWFyL2N5Y2xlcy5qcyJdLCJuYW1lcyI6WyJHcmFwaCIsInJlcXVpcmUiLCJwYXJzZXJVdGlsIiwiUHJvZHVjdGlvbiIsIlVuaXRSdWxlUHJvZHVjdGlvbiIsIlVuaXRSdWxlc1Byb2R1Y3Rpb24iLCJOb25Vbml0UnVsZXNQcm9kdWN0aW9uIiwiY3ljbGVzIiwicHJvZHVjdGlvbnMiLCJncmFwaCIsImdyYXBoRnJvbVByb2R1Y3Rpb25zIiwiY29tcG9uZW50cyIsImdlbmVyYXRlQ29tcG9uZW50cyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zIiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyIsImFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9ucyIsImFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uc0Zyb21HcmFwaCIsImNvbmNhdCIsIm1vZHVsZSIsImV4cG9ydHMiLCJ1bml0UnVsZXNQcm9kdWN0aW9ucyIsInVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwiZ3JhcGhGcm9tVW5pdFJ1bGVzUHJvZHVjdGlvbnMiLCJyZWR1Y2UiLCJwcm9kdWN0aW9uIiwidW5pdFJ1bGVzUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uIiwicHVzaCIsImZvckVhY2giLCJwcm9kdWN0aW9uTmFtZSIsImdldE5hbWUiLCJwcm9kdWN0aW9uTmFtZXMiLCJnZXRQcm9kdWN0aW9uTmFtZXMiLCJ2ZXJ0ZXhOYW1lIiwiZGVzY2VuZGFudFZlcnRleE5hbWVzIiwiYWRkVmVydGV4IiwiY29tcG9uZW50IiwiY29tcG9uZW50Tm9uQ3ljbGljIiwiaXNOb25DeWNsaWMiLCJub25DeWNsaWNQcm9kdWN0aW9uRnJvbUNvbXBvbmVudCIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImZpbHRlciIsInZlcnRleFByZXNlbnQiLCJpc1ZlcnRleFByZXNlbnQiLCJwcm9kdWN0aW9uQWxyZWFkeU5vbkN5Y2xpYyIsImZpcnN0VmVydGV4IiwiZ2V0Rmlyc3RWZXJ0ZXgiLCJmaXJzdFZlcnRleE5hbWUiLCJub25DeWNsaWNQcm9kdWN0aW9uTmFtZSIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb24iLCJmaW5kUHJvZHVjdGlvbiIsInByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudCIsImZpeGVkUHJvZHVjdGlvbnMiLCJmaXhlZFByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zIiwidW5pdFJ1bGVQcm9kdWN0aW9ucyIsInVuaXRSdWxlUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMiLCJyZW1vdmVkUHJvZHVjdGlvbnMiLCJhZGRlZFByb2R1Y3Rpb25zIiwidW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCIsImxlbmd0aCIsInVuaXRSdWxlUHJvZHVjdGlvbiIsInNoaWZ0IiwidW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsInJlbW92ZWRQcm9kdWN0aW9uIiwidW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsImdldFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJmaXhlZFByb2R1Y3Rpb25OYW1lIiwiYWRkZWRQcm9kdWN0aW9uTmFtZSIsImZpeGVkUHJvZHVjdGlvbiIsImFkZGVkUHJvZHVjdGlvbiIsInNldE5hbWUiLCJmaXhlZFByb2R1Y3Rpb25SdWxlcyIsImdldFJ1bGVzIiwiY29uY2F0UnVsZXMiLCJpbnRlcm1lZGlhdGVQcm9kdWN0aW9uTmFtZSIsImludGVybWVkaWF0ZVByb2R1Y3Rpb24iLCJpbnRlcm1lZGlhdGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSIsInVuaXRSdWxlUHJvZHVjdGlvbk5vbkN5Y2xpYyIsImZpbmRVbml0UnVsZVByb2R1Y3Rpb24iLCJmcm9tTmFtZUFuZFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUiLCJ1bnNoaWZ0Iiwibm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tRml4ZWRBbmRBZGRlZFByb2R1Y3Rpb25zIiwiYWRkZWRQcm9kdWN0aW9uUnVsZXMiLCJtYXBWZXJ0aWNlcyIsInZlcnRleCIsIm5hbWUiLCJmb3JFYWNoVW5pdFJ1bGUiLCJ1bml0UnVsZSIsImZyb21OYW1lQW5kVW5pdFJ1bGUiLCJtYXAiLCJub25Vbml0UHJvZHVjdGlvbiIsImZpcnN0UHJvZHVjdGlvbk5hbWUiLCJzZWNvbmRQcm9kdWN0aW9uTmFtZSIsImZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uIiwic29tZSIsInVuaXRSdWxlUHJvZHVjdGlvbkZvdW5kIiwiaXNGb3VuZEJ5UHJvZHVjdGlvbk5hbWVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsUUFBUUMsUUFBUSxTQUFSLENBQWQ7QUFBQSxJQUNNQyxhQUFhRCxRQUFRLGdCQUFSLENBRG5CO0FBQUEsSUFFTUUsYUFBYUYsUUFBUSxzQkFBUixDQUZuQjtBQUFBLElBR01HLHFCQUFxQkgsUUFBUSx1QkFBUixDQUgzQjtBQUFBLElBSU1JLHNCQUFzQkosUUFBUSx3QkFBUixDQUo1QjtBQUFBLElBS01LLHlCQUF5QkwsUUFBUSwyQkFBUixDQUwvQjs7SUFPTU0sTTs7Ozs7Ozs4QkFDYUMsVyxFQUFhO0FBQzVCLFVBQU1DLFFBQVFDLHFCQUFxQkYsV0FBckIsQ0FBZDtBQUFBLFVBQ01HLGFBQWFGLE1BQU1HLGtCQUFOLEVBRG5CO0FBQUEsVUFFTUMsdUJBQXVCQyxtQ0FBbUNILFVBQW5DLEVBQStDSCxXQUEvQyxDQUY3QjtBQUFBLFVBR01PLDhCQUE4QkMscUNBQXFDUCxLQUFyQyxFQUE0Q0QsV0FBNUMsQ0FIcEM7O0FBS0FBLG9CQUFjLEdBQUdTLE1BQUgsQ0FBVUosb0JBQVYsRUFBZ0NJLE1BQWhDLENBQXVDRiwyQkFBdkMsQ0FBZDs7QUFFQSxhQUFPUCxXQUFQO0FBQ0Q7Ozs7OztBQUdIVSxPQUFPQyxPQUFQLEdBQWlCWixNQUFqQjs7QUFFQSxTQUFTRyxvQkFBVCxDQUE4QkYsV0FBOUIsRUFBMkM7QUFDekMsTUFBTVksdUJBQXVCQyxvQ0FBb0NiLFdBQXBDLENBQTdCO0FBQUEsTUFDTUMsUUFBUWEsOEJBQThCRixvQkFBOUIsQ0FEZDs7QUFHQSxTQUFPWCxLQUFQO0FBQ0Q7O0FBRUQsU0FBU1ksbUNBQVQsQ0FBNkNiLFdBQTdDLEVBQTBEO0FBQ3hELE1BQU1ZLHVCQUF1QlosWUFBWWUsTUFBWixDQUFtQixVQUFTSCxvQkFBVCxFQUErQkksVUFBL0IsRUFBMkM7QUFDekYsUUFBTUMsc0JBQXNCcEIsb0JBQW9CcUIsY0FBcEIsQ0FBbUNGLFVBQW5DLENBQTVCOztBQUVBLFFBQUlDLHdCQUF3QixJQUE1QixFQUFrQztBQUNoQ0wsMkJBQXFCTyxJQUFyQixDQUEwQkYsbUJBQTFCO0FBQ0Q7O0FBRUQsV0FBT0wsb0JBQVA7QUFDRCxHQVI0QixFQVExQixFQVIwQixDQUE3Qjs7QUFVQSxTQUFPQSxvQkFBUDtBQUNEOztBQUVELFNBQVNFLDZCQUFULENBQXVDRixvQkFBdkMsRUFBNkQ7QUFDM0QsTUFBTVgsUUFBUSxJQUFJVCxLQUFKLEVBQWQ7O0FBRUFvQix1QkFBcUJRLE9BQXJCLENBQTZCLFVBQVNILG1CQUFULEVBQThCO0FBQ3pELFFBQU1JLGlCQUFpQkosb0JBQW9CSyxPQUFwQixFQUF2QjtBQUFBLFFBQ01DLGtCQUFrQk4sb0JBQW9CTyxrQkFBcEIsRUFEeEI7QUFBQSxRQUVNQyxhQUFhSixjQUZuQjtBQUFBLFFBRW9DO0FBQzlCSyw0QkFBd0JILGVBSDlCLENBRHlELENBSVY7O0FBRS9DdEIsVUFBTTBCLFNBQU4sQ0FBZ0JGLFVBQWhCLEVBQTRCQyxxQkFBNUI7QUFDRCxHQVBEOztBQVNBLFNBQU96QixLQUFQO0FBQ0Q7O0FBRUQsU0FBU0ssa0NBQVQsQ0FBNENILFVBQTVDLEVBQXdESCxXQUF4RCxFQUFxRTtBQUNuRSxNQUFNSyx1QkFBdUJGLFdBQVdZLE1BQVgsQ0FBa0IsVUFBU1Ysb0JBQVQsRUFBK0J1QixTQUEvQixFQUEwQztBQUNqRixRQUFNQyxxQkFBcUJELFVBQVVFLFdBQVYsRUFBM0I7O0FBRUEsUUFBSUQsa0JBQUosRUFBd0I7QUFDdEJFLHVDQUFpQ0gsU0FBakMsRUFBNEM1QixXQUE1QyxFQUF5REssb0JBQXpEO0FBQ0QsS0FGRCxNQUVPO0FBQ0wyQix3Q0FBa0NKLFNBQWxDLEVBQTZDNUIsV0FBN0MsRUFBMERLLG9CQUExRDtBQUNEOztBQUVELFdBQU9BLG9CQUFQO0FBQ0QsR0FWc0IsRUFVcEIsRUFWb0IsQ0FBN0I7O0FBWUEsU0FBT0Esb0JBQVA7QUFDRDs7QUFFRCxTQUFTRyxvQ0FBVCxDQUE4Q1AsS0FBOUMsRUFBcURELFdBQXJELEVBQWtFO0FBQ2hFLE1BQU1PLDhCQUE4QlAsWUFBWWlDLE1BQVosQ0FBbUIsVUFBU2pCLFVBQVQsRUFBcUI7QUFDMUUsUUFBTUssaUJBQWlCTCxXQUFXTSxPQUFYLEVBQXZCO0FBQUEsUUFDTUcsYUFBYUosY0FEbkI7QUFBQSxRQUNvQztBQUM5QmEsb0JBQWdCakMsTUFBTWtDLGVBQU4sQ0FBc0JWLFVBQXRCLENBRnRCO0FBQUEsUUFHTVcsNkJBQTZCLENBQUNGLGFBSHBDLENBRDBFLENBSXZCOztBQUVuRCxXQUFPRSwwQkFBUDtBQUNELEdBUG1DLENBQXBDOztBQVNBLFNBQU83QiwyQkFBUDtBQUNEOztBQUVELFNBQVN3QixnQ0FBVCxDQUEwQ0gsU0FBMUMsRUFBcUQ1QixXQUFyRCxFQUFrRUssb0JBQWxFLEVBQXdGO0FBQ3RGLE1BQU1nQyxjQUFjVCxVQUFVVSxjQUFWLEVBQXBCO0FBQUEsTUFDTUMsa0JBQWtCRixZQUFZZixPQUFaLEVBRHhCO0FBQUEsTUFFTWtCLDBCQUEwQkQsZUFGaEM7QUFBQSxNQUVrRDtBQUM1Q0Usd0JBQXNCL0MsV0FBV2dELGNBQVgsQ0FBMEJGLHVCQUExQixFQUFtRHhDLFdBQW5ELENBSDVCOztBQUtBSyx1QkFBcUJjLElBQXJCLENBQTBCc0IsbUJBQTFCO0FBQ0Q7O0FBRUQsU0FBU1QsaUNBQVQsQ0FBMkNKLFNBQTNDLEVBQXNENUIsV0FBdEQsRUFBbUVLLG9CQUFuRSxFQUF5RjtBQUN2RkwsZ0JBQWMyQyx5QkFBeUJmLFNBQXpCLEVBQW9DNUIsV0FBcEMsQ0FBZCxDQUR1RixDQUN2Qjs7QUFFaEUsTUFBTTRDLG1CQUFtQkMsZ0NBQWdDN0MsV0FBaEMsQ0FBekI7QUFBQSxNQUNNOEMsc0JBQXNCQyxtQ0FBbUMvQyxXQUFuQyxDQUQ1QjtBQUFBLE1BRU1nRCxxQkFBcUIsRUFGM0I7QUFBQSxNQUdNQyxtQkFBbUIsRUFIekI7O0FBS0EsTUFBSUMsNEJBQTRCSixvQkFBb0JLLE1BQXBEOztBQUVBLFNBQU9ELDRCQUE0QixDQUFuQyxFQUFzQztBQUNwQyxRQUFJRSxxQkFBcUJOLG9CQUFvQk8sS0FBcEIsRUFBekI7QUFBQSxRQUNJQyx5QkFBeUJGLG1CQUFtQjlCLE9BQW5CLEVBRDdCOztBQUdBLFFBQU1pQyxvQkFBb0JILGtCQUExQjs7QUFFQUosdUJBQW1CN0IsSUFBbkIsQ0FBd0JvQyxpQkFBeEI7O0FBRUEsUUFBTUMsMkNBQTJDSixtQkFBbUJLLHlCQUFuQixFQUFqRDtBQUFBLFFBQ01DLHNCQUFzQkYsd0NBRDVCO0FBQUEsUUFDdUU7QUFDakVHLDBCQUFzQkwsc0JBRjVCO0FBQUEsUUFFcUQ7QUFDL0NNLHNCQUFrQmxFLFdBQVdnRCxjQUFYLENBQTBCZ0IsbUJBQTFCLEVBQStDZCxnQkFBL0MsQ0FIeEI7O0FBS0EsUUFBSWlCLGtCQUFrQm5FLFdBQVdnRCxjQUFYLENBQTBCaUIsbUJBQTFCLEVBQStDVixnQkFBL0MsQ0FBdEI7O0FBRUEsUUFBSVksb0JBQW9CLElBQXhCLEVBQThCO0FBQzVCQSx3QkFBa0JsRSxXQUFXdUIsY0FBWCxDQUEwQjBDLGVBQTFCLENBQWxCOztBQUVBQyxzQkFBZ0JDLE9BQWhCLENBQXdCSCxtQkFBeEI7O0FBRUFWLHVCQUFpQjlCLElBQWpCLENBQXNCMEMsZUFBdEI7QUFDRCxLQU5ELE1BTU87QUFDTCxVQUFNRSx1QkFBdUJILGdCQUFnQkksUUFBaEIsRUFBN0I7O0FBRUFILHNCQUFnQkksV0FBaEIsQ0FBNEJGLG9CQUE1QjtBQUNEOztBQUVELFFBQU1HLDZCQUE2QlYsd0NBQW5DO0FBQUEsUUFBNkU7QUFDdkVXLDZCQUF5QnpFLFdBQVdnRCxjQUFYLENBQTBCd0IsMEJBQTFCLEVBQXNEcEIsbUJBQXRELENBRC9COztBQUdBLFFBQUlxQiwyQkFBMkIsSUFBL0IsRUFBcUM7QUFDbkMsVUFBTUMsK0NBQStDRCx1QkFBdUJWLHlCQUF2QixFQUFyRDtBQUFBLFVBQ01ELDRDQUEyQ1ksNENBRGpEO0FBQUEsVUFDZ0c7QUFDMUZDLG9DQUErQmYsMkJBQTJCRSx5Q0FGaEU7O0FBSUEsVUFBSWEsMkJBQUosRUFBaUM7QUFDL0JqQiw2QkFBcUJrQix1QkFBdUJoQixzQkFBdkIsRUFBK0NFLHlDQUEvQyxFQUF5RlIsa0JBQXpGLENBQXJCOztBQUVBLFlBQUlJLHVCQUF1QixJQUEzQixFQUFpQztBQUMvQkEsK0JBQXFCeEQsbUJBQW1CMkUsaUNBQW5CLENBQXFEakIsc0JBQXJELEVBQTZFRSx5Q0FBN0UsQ0FBckI7O0FBRUFWLDhCQUFvQjBCLE9BQXBCLENBQTRCcEIsa0JBQTVCO0FBQ0Q7QUFDRjtBQUNGOztBQUVERixnQ0FBNEJKLG9CQUFvQkssTUFBaEQ7QUFDRDs7QUFFRHNCLG1EQUFpRDdCLGdCQUFqRCxFQUFtRUssZ0JBQW5FLEVBQXFGNUMsb0JBQXJGO0FBQ0Q7O0FBRUQsU0FBU29FLGdEQUFULENBQTBEN0IsZ0JBQTFELEVBQTRFSyxnQkFBNUUsRUFBOEY1QyxvQkFBOUYsRUFBb0g7QUFDbEh1QyxtQkFBaUJ4QixPQUFqQixDQUF5QixVQUFTd0MsZUFBVCxFQUEwQjtBQUNqRCxRQUFNbkIsc0JBQXNCbUIsZUFBNUI7QUFBQSxRQUE2QztBQUN2Q3BCLDhCQUEwQkMsb0JBQW9CbkIsT0FBcEIsRUFEaEM7QUFBQSxRQUVNcUMsc0JBQXNCbkIsdUJBRjVCO0FBQUEsUUFFcUQ7QUFDL0NxQixzQkFBa0JuRSxXQUFXZ0QsY0FBWCxDQUEwQmlCLG1CQUExQixFQUErQ1YsZ0JBQS9DLENBSHhCOztBQUtBLFFBQUlZLG9CQUFvQixJQUF4QixFQUE4QjtBQUM1QixVQUFNYSx1QkFBdUJiLGdCQUFnQkcsUUFBaEIsRUFBN0I7O0FBRUF2QiwwQkFBb0J3QixXQUFwQixDQUFnQ1Msb0JBQWhDO0FBQ0Q7O0FBRURyRSx5QkFBcUJjLElBQXJCLENBQTBCc0IsbUJBQTFCO0FBQ0QsR0FiRDtBQWNEOztBQUVELFNBQVNFLHdCQUFULENBQWtDZixTQUFsQyxFQUE2QzVCLFdBQTdDLEVBQTBEO0FBQ3hEQSxnQkFBYzRCLFVBQVUrQyxXQUFWLENBQXNCLFVBQVNDLE1BQVQsRUFBaUI7QUFDbkQsUUFBTW5ELGFBQWFtRCxPQUFPdEQsT0FBUCxFQUFuQjtBQUFBLFFBQ01ELGlCQUFpQkksVUFEdkI7QUFBQSxRQUNvQztBQUM5QlQsaUJBQWF0QixXQUFXZ0QsY0FBWCxDQUEwQnJCLGNBQTFCLEVBQTBDckIsV0FBMUMsQ0FGbkI7O0FBSUEsV0FBT2dCLFVBQVA7QUFDRCxHQU5hLENBQWQ7O0FBUUEsU0FBT2hCLFdBQVA7QUFDRDs7QUFFRCxTQUFTK0Msa0NBQVQsQ0FBNEMvQyxXQUE1QyxFQUF5RDtBQUN2RCxNQUFNOEMsc0JBQXNCOUMsWUFBWWUsTUFBWixDQUFtQixVQUFTK0IsbUJBQVQsRUFBOEI5QixVQUE5QixFQUEwQztBQUN2RixRQUFNNkQsT0FBTzdELFdBQVdNLE9BQVgsRUFBYjtBQUFBLFFBQ01MLHNCQUFzQnBCLG9CQUFvQnFCLGNBQXBCLENBQW1DRixVQUFuQyxDQUQ1Qjs7QUFHQUMsd0JBQW9CNkQsZUFBcEIsQ0FBb0MsVUFBU0MsUUFBVCxFQUFtQjtBQUNyRCxVQUFNM0IscUJBQXFCeEQsbUJBQW1Cb0YsbUJBQW5CLENBQXVDSCxJQUF2QyxFQUE2Q0UsUUFBN0MsQ0FBM0I7O0FBRUFqQywwQkFBb0IzQixJQUFwQixDQUF5QmlDLGtCQUF6QjtBQUNELEtBSkQ7O0FBTUEsV0FBT04sbUJBQVA7QUFDRCxHQVgyQixFQVd6QixFQVh5QixDQUE1Qjs7QUFhQSxTQUFPQSxtQkFBUDtBQUNEOztBQUVELFNBQVNELCtCQUFULENBQXlDN0MsV0FBekMsRUFBc0Q7QUFDcEQsTUFBTTRDLG1CQUFtQjVDLFlBQVlpRixHQUFaLENBQWdCLFVBQVNqRSxVQUFULEVBQXFCO0FBQzVELFFBQU1rRSxvQkFBb0JwRix1QkFBdUJvQixjQUF2QixDQUFzQ0YsVUFBdEMsQ0FBMUI7QUFBQSxRQUNNNEMsa0JBQWtCc0IsaUJBRHhCLENBRDRELENBRWpCOztBQUUzQyxXQUFPdEIsZUFBUDtBQUNELEdBTHdCLENBQXpCOztBQU9BLFNBQU9oQixnQkFBUDtBQUNEOztBQUVELFNBQVMwQixzQkFBVCxDQUFnQ2pELGNBQWhDLEVBQWdEaUMsc0JBQWhELEVBQXdFUixtQkFBeEUsRUFBNkY7QUFDM0YsTUFBTXFDLHNCQUFzQjlELGNBQTVCO0FBQUEsTUFBNEM7QUFDdEMrRCx5QkFBdUI5QixzQkFEN0IsQ0FEMkYsQ0FFckM7O0FBRXRELE1BQUkrQiwwQkFBMEIsSUFBOUI7O0FBRUF2QyxzQkFBb0J3QyxJQUFwQixDQUF5QixVQUFTbEMsa0JBQVQsRUFBNkI7QUFDcEQsUUFBTW1DLDBCQUEwQm5DLG1CQUFtQm9DLHdCQUFuQixDQUE0Q0wsbUJBQTVDLEVBQWlFQyxvQkFBakUsQ0FBaEM7O0FBRUEsUUFBSUcsdUJBQUosRUFBNkI7QUFDM0JGLGdDQUEwQmpDLGtCQUExQjs7QUFFQSxhQUFPLElBQVA7QUFDRDtBQUNGLEdBUkQ7O0FBVUEsTUFBTUEscUJBQXFCaUMsdUJBQTNCLENBaEIyRixDQWdCdkM7O0FBRXBELFNBQU9qQyxrQkFBUDtBQUNEIiwiZmlsZSI6ImN5Y2xlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgR3JhcGggPSByZXF1aXJlKCcuL2dyYXBoJyksXG4gICAgICBwYXJzZXJVdGlsID0gcmVxdWlyZSgnLi4vdXRpbC9wYXJzZXInKSxcbiAgICAgIFByb2R1Y3Rpb24gPSByZXF1aXJlKCcuLi9jb21tb24vcHJvZHVjdGlvbicpLFxuICAgICAgVW5pdFJ1bGVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlJyksXG4gICAgICBVbml0UnVsZXNQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi9wcm9kdWN0aW9uL3VuaXRSdWxlcycpLFxuICAgICAgTm9uVW5pdFJ1bGVzUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4vcHJvZHVjdGlvbi9ub25Vbml0UnVsZXMnKTtcblxuY2xhc3MgY3ljbGVzIHtcbiAgc3RhdGljIGVsaW1pbmF0ZShwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IGdyYXBoID0gZ3JhcGhGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGNvbXBvbmVudHMgPSBncmFwaC5nZW5lcmF0ZUNvbXBvbmVudHMoKSxcbiAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9ucyA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMoY29tcG9uZW50cywgcHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9ucyA9IGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uc0Zyb21HcmFwaChncmFwaCwgcHJvZHVjdGlvbnMpO1xuXG4gICAgcHJvZHVjdGlvbnMgPSBbXS5jb25jYXQobm9uQ3ljbGljUHJvZHVjdGlvbnMpLmNvbmNhdChhbHJlYWR5Tm9uQ3ljbGljUHJvZHVjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25zO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gY3ljbGVzO1xuXG5mdW5jdGlvbiBncmFwaEZyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0UnVsZXNQcm9kdWN0aW9ucyA9IHVuaXRSdWxlc1Byb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgZ3JhcGggPSBncmFwaEZyb21Vbml0UnVsZXNQcm9kdWN0aW9ucyh1bml0UnVsZXNQcm9kdWN0aW9ucyk7XG5cbiAgcmV0dXJuIGdyYXBoO1xufVxuXG5mdW5jdGlvbiB1bml0UnVsZXNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0UnVsZXNQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLnJlZHVjZShmdW5jdGlvbih1bml0UnVsZXNQcm9kdWN0aW9ucywgcHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXRSdWxlc1Byb2R1Y3Rpb24gPSBVbml0UnVsZXNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuXG4gICAgaWYgKHVuaXRSdWxlc1Byb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIHVuaXRSdWxlc1Byb2R1Y3Rpb25zLnB1c2godW5pdFJ1bGVzUHJvZHVjdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuaXRSdWxlc1Byb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlc1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBncmFwaEZyb21Vbml0UnVsZXNQcm9kdWN0aW9ucyh1bml0UnVsZXNQcm9kdWN0aW9ucykge1xuICBjb25zdCBncmFwaCA9IG5ldyBHcmFwaCgpO1xuXG4gIHVuaXRSdWxlc1Byb2R1Y3Rpb25zLmZvckVhY2goZnVuY3Rpb24odW5pdFJ1bGVzUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHByb2R1Y3Rpb25OYW1lID0gdW5pdFJ1bGVzUHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgcHJvZHVjdGlvbk5hbWVzID0gdW5pdFJ1bGVzUHJvZHVjdGlvbi5nZXRQcm9kdWN0aW9uTmFtZXMoKSxcbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gcHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSBwcm9kdWN0aW9uTmFtZXM7IC8vL1xuXG4gICAgZ3JhcGguYWRkVmVydGV4KHZlcnRleE5hbWUsIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyk7XG4gIH0pO1xuXG4gIHJldHVybiBncmFwaDtcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9ucyA9IGNvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLCBjb21wb25lbnQpIHtcbiAgICAgICAgICBjb25zdCBjb21wb25lbnROb25DeWNsaWMgPSBjb21wb25lbnQuaXNOb25DeWNsaWMoKTtcblxuICAgICAgICAgIGlmIChjb21wb25lbnROb25DeWNsaWMpIHtcbiAgICAgICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25Gcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG4gICAgICAgIH0sIFtdKTtcblxuICByZXR1cm4gbm9uQ3ljbGljUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGFscmVhZHlOb25DeWNsaWNQcm9kdWN0aW9uc0Zyb21HcmFwaChncmFwaCwgcHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBwcm9kdWN0aW9uTmFtZSA9IHByb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIHZlcnRleE5hbWUgPSBwcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgIHZlcnRleFByZXNlbnQgPSBncmFwaC5pc1ZlcnRleFByZXNlbnQodmVydGV4TmFtZSksXG4gICAgICAgICAgcHJvZHVjdGlvbkFscmVhZHlOb25DeWNsaWMgPSAhdmVydGV4UHJlc2VudDsgLy8vXG4gICAgXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25BbHJlYWR5Tm9uQ3ljbGljO1xuICB9KTtcblxuICByZXR1cm4gYWxyZWFkeU5vbkN5Y2xpY1Byb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uRnJvbUNvbXBvbmVudChjb21wb25lbnQsIHByb2R1Y3Rpb25zLCBub25DeWNsaWNQcm9kdWN0aW9ucykge1xuICBjb25zdCBmaXJzdFZlcnRleCA9IGNvbXBvbmVudC5nZXRGaXJzdFZlcnRleCgpLFxuICAgICAgICBmaXJzdFZlcnRleE5hbWUgPSBmaXJzdFZlcnRleC5nZXROYW1lKCksXG4gICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lID0gZmlyc3RWZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKG5vbkN5Y2xpY1Byb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyk7XG5cbiAgbm9uQ3ljbGljUHJvZHVjdGlvbnMucHVzaChub25DeWNsaWNQcm9kdWN0aW9uKTtcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIHByb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50KGNvbXBvbmVudCwgcHJvZHVjdGlvbnMpOyAvLy9cblxuICBjb25zdCBmaXhlZFByb2R1Y3Rpb25zID0gZml4ZWRQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucyksXG4gICAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbnMgPSB1bml0UnVsZVByb2R1Y3Rpb25zRnJvbVByb2R1Y3Rpb25zKHByb2R1Y3Rpb25zKSxcbiAgICAgICAgcmVtb3ZlZFByb2R1Y3Rpb25zID0gW10sXG4gICAgICAgIGFkZGVkUHJvZHVjdGlvbnMgPSBbXTtcblxuICBsZXQgdW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCA9IHVuaXRSdWxlUHJvZHVjdGlvbnMubGVuZ3RoO1xuXG4gIHdoaWxlICh1bml0UnVsZVByb2R1Y3Rpb25zTGVuZ3RoID4gMCkge1xuICAgIGxldCB1bml0UnVsZVByb2R1Y3Rpb24gPSB1bml0UnVsZVByb2R1Y3Rpb25zLnNoaWZ0KCksXG4gICAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZVByb2R1Y3Rpb24uZ2V0TmFtZSgpO1xuXG4gICAgY29uc3QgcmVtb3ZlZFByb2R1Y3Rpb24gPSB1bml0UnVsZVByb2R1Y3Rpb247XG5cbiAgICByZW1vdmVkUHJvZHVjdGlvbnMucHVzaChyZW1vdmVkUHJvZHVjdGlvbik7XG5cbiAgICBjb25zdCB1bml0UnVsZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lID0gdW5pdFJ1bGVQcm9kdWN0aW9uLmdldFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUoKSxcbiAgICAgICAgICBmaXhlZFByb2R1Y3Rpb25OYW1lID0gdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgIGFkZGVkUHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZVByb2R1Y3Rpb25OYW1lLCAgLy8vXG4gICAgICAgICAgZml4ZWRQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihmaXhlZFByb2R1Y3Rpb25OYW1lLCBmaXhlZFByb2R1Y3Rpb25zKTtcblxuICAgIGxldCBhZGRlZFByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKGFkZGVkUHJvZHVjdGlvbk5hbWUsIGFkZGVkUHJvZHVjdGlvbnMpO1xuXG4gICAgaWYgKGFkZGVkUHJvZHVjdGlvbiA9PT0gbnVsbCkge1xuICAgICAgYWRkZWRQcm9kdWN0aW9uID0gUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihmaXhlZFByb2R1Y3Rpb24pO1xuXG4gICAgICBhZGRlZFByb2R1Y3Rpb24uc2V0TmFtZShhZGRlZFByb2R1Y3Rpb25OYW1lKTtcblxuICAgICAgYWRkZWRQcm9kdWN0aW9ucy5wdXNoKGFkZGVkUHJvZHVjdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGZpeGVkUHJvZHVjdGlvblJ1bGVzID0gZml4ZWRQcm9kdWN0aW9uLmdldFJ1bGVzKCk7XG5cbiAgICAgIGFkZGVkUHJvZHVjdGlvbi5jb25jYXRSdWxlcyhmaXhlZFByb2R1Y3Rpb25SdWxlcyk7XG4gICAgfVxuXG4gICAgY29uc3QgaW50ZXJtZWRpYXRlUHJvZHVjdGlvbk5hbWUgPSB1bml0UnVsZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lLCAvLy9cbiAgICAgICAgICBpbnRlcm1lZGlhdGVQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihpbnRlcm1lZGlhdGVQcm9kdWN0aW9uTmFtZSwgdW5pdFJ1bGVQcm9kdWN0aW9ucyk7XG5cbiAgICBpZiAoaW50ZXJtZWRpYXRlUHJvZHVjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgaW50ZXJtZWRpYXRlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSBpbnRlcm1lZGlhdGVQcm9kdWN0aW9uLmdldFVuaXRSdWxlUHJvZHVjdGlvbk5hbWUoKSxcbiAgICAgICAgICAgIHVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgPSBpbnRlcm1lZGlhdGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgIC8vL1xuICAgICAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9uTm9uQ3ljbGljID0gKHVuaXRSdWxlUHJvZHVjdGlvbk5hbWUgIT09IHVuaXRSdWxlUHJvZHVjdGlvblVuaXRSdWxlUHJvZHVjdGlvbk5hbWUpO1xuXG4gICAgICBpZiAodW5pdFJ1bGVQcm9kdWN0aW9uTm9uQ3ljbGljKSB7XG4gICAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbiA9IGZpbmRVbml0UnVsZVByb2R1Y3Rpb24odW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgdW5pdFJ1bGVQcm9kdWN0aW9uVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSwgcmVtb3ZlZFByb2R1Y3Rpb25zKTtcblxuICAgICAgICBpZiAodW5pdFJ1bGVQcm9kdWN0aW9uID09PSBudWxsKSB7XG4gICAgICAgICAgdW5pdFJ1bGVQcm9kdWN0aW9uID0gVW5pdFJ1bGVQcm9kdWN0aW9uLmZyb21OYW1lQW5kVW5pdFJ1bGVQcm9kdWN0aW9uTmFtZSh1bml0UnVsZVByb2R1Y3Rpb25OYW1lLCB1bml0UnVsZVByb2R1Y3Rpb25Vbml0UnVsZVByb2R1Y3Rpb25OYW1lKTtcblxuICAgICAgICAgIHVuaXRSdWxlUHJvZHVjdGlvbnMudW5zaGlmdCh1bml0UnVsZVByb2R1Y3Rpb24pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdW5pdFJ1bGVQcm9kdWN0aW9uc0xlbmd0aCA9IHVuaXRSdWxlUHJvZHVjdGlvbnMubGVuZ3RoO1xuICB9XG5cbiAgbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tRml4ZWRBbmRBZGRlZFByb2R1Y3Rpb25zKGZpeGVkUHJvZHVjdGlvbnMsIGFkZGVkUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbn1cblxuZnVuY3Rpb24gbm9uQ3ljbGljUHJvZHVjdGlvbnNGcm9tRml4ZWRBbmRBZGRlZFByb2R1Y3Rpb25zKGZpeGVkUHJvZHVjdGlvbnMsIGFkZGVkUHJvZHVjdGlvbnMsIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKSB7XG4gIGZpeGVkUHJvZHVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbihmaXhlZFByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBub25DeWNsaWNQcm9kdWN0aW9uID0gZml4ZWRQcm9kdWN0aW9uLCAvLy9cbiAgICAgICAgICBub25DeWNsaWNQcm9kdWN0aW9uTmFtZSA9IG5vbkN5Y2xpY1Byb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIGFkZGVkUHJvZHVjdGlvbk5hbWUgPSBub25DeWNsaWNQcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgICAgYWRkZWRQcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihhZGRlZFByb2R1Y3Rpb25OYW1lLCBhZGRlZFByb2R1Y3Rpb25zKTtcblxuICAgIGlmIChhZGRlZFByb2R1Y3Rpb24gIT09IG51bGwpIHtcbiAgICAgIGNvbnN0IGFkZGVkUHJvZHVjdGlvblJ1bGVzID0gYWRkZWRQcm9kdWN0aW9uLmdldFJ1bGVzKCk7XG5cbiAgICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb24uY29uY2F0UnVsZXMoYWRkZWRQcm9kdWN0aW9uUnVsZXMpO1xuICAgIH1cblxuICAgIG5vbkN5Y2xpY1Byb2R1Y3Rpb25zLnB1c2gobm9uQ3ljbGljUHJvZHVjdGlvbik7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBwcm9kdWN0aW9uc0Zyb21Db21wb25lbnQoY29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBwcm9kdWN0aW9ucyA9IGNvbXBvbmVudC5tYXBWZXJ0aWNlcyhmdW5jdGlvbih2ZXJ0ZXgpIHtcbiAgICBjb25zdCB2ZXJ0ZXhOYW1lID0gdmVydGV4LmdldE5hbWUoKSxcbiAgICAgICAgICBwcm9kdWN0aW9uTmFtZSA9IHZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgICBwcm9kdWN0aW9uID0gcGFyc2VyVXRpbC5maW5kUHJvZHVjdGlvbihwcm9kdWN0aW9uTmFtZSwgcHJvZHVjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb247XG4gIH0pO1xuXG4gIHJldHVybiBwcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gdW5pdFJ1bGVQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyhwcm9kdWN0aW9ucykge1xuICBjb25zdCB1bml0UnVsZVByb2R1Y3Rpb25zID0gcHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRSdWxlUHJvZHVjdGlvbnMsIHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBuYW1lID0gcHJvZHVjdGlvbi5nZXROYW1lKCksXG4gICAgICAgICAgdW5pdFJ1bGVzUHJvZHVjdGlvbiA9IFVuaXRSdWxlc1Byb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb24ocHJvZHVjdGlvbik7XG5cbiAgICB1bml0UnVsZXNQcm9kdWN0aW9uLmZvckVhY2hVbml0UnVsZShmdW5jdGlvbih1bml0UnVsZSkge1xuICAgICAgY29uc3QgdW5pdFJ1bGVQcm9kdWN0aW9uID0gVW5pdFJ1bGVQcm9kdWN0aW9uLmZyb21OYW1lQW5kVW5pdFJ1bGUobmFtZSwgdW5pdFJ1bGUpO1xuXG4gICAgICB1bml0UnVsZVByb2R1Y3Rpb25zLnB1c2godW5pdFJ1bGVQcm9kdWN0aW9uKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB1bml0UnVsZVByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRSdWxlUHJvZHVjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGZpeGVkUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgZml4ZWRQcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zLm1hcChmdW5jdGlvbihwcm9kdWN0aW9uKSB7XG4gICAgY29uc3Qgbm9uVW5pdFByb2R1Y3Rpb24gPSBOb25Vbml0UnVsZXNQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pLFxuICAgICAgICAgIGZpeGVkUHJvZHVjdGlvbiA9IG5vblVuaXRQcm9kdWN0aW9uOyAvLy9cbiAgICBcbiAgICByZXR1cm4gZml4ZWRQcm9kdWN0aW9uO1xuICB9KTtcbiAgXG4gIHJldHVybiBmaXhlZFByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBmaW5kVW5pdFJ1bGVQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCB1bml0UnVsZVByb2R1Y3Rpb25OYW1lLCB1bml0UnVsZVByb2R1Y3Rpb25zKSB7XG4gIGNvbnN0IGZpcnN0UHJvZHVjdGlvbk5hbWUgPSBwcm9kdWN0aW9uTmFtZSwgLy8vXG4gICAgICAgIHNlY29uZFByb2R1Y3Rpb25OYW1lID0gdW5pdFJ1bGVQcm9kdWN0aW9uTmFtZTsgIC8vL1xuXG4gIGxldCBmb3VuZFVuaXRSdWxlUHJvZHVjdGlvbiA9IG51bGw7XG5cbiAgdW5pdFJ1bGVQcm9kdWN0aW9ucy5zb21lKGZ1bmN0aW9uKHVuaXRSdWxlUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbkZvdW5kID0gdW5pdFJ1bGVQcm9kdWN0aW9uLmlzRm91bmRCeVByb2R1Y3Rpb25OYW1lcyhmaXJzdFByb2R1Y3Rpb25OYW1lLCBzZWNvbmRQcm9kdWN0aW9uTmFtZSk7XG5cbiAgICBpZiAodW5pdFJ1bGVQcm9kdWN0aW9uRm91bmQpIHtcbiAgICAgIGZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uID0gdW5pdFJ1bGVQcm9kdWN0aW9uO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHVuaXRSdWxlUHJvZHVjdGlvbiA9IGZvdW5kVW5pdFJ1bGVQcm9kdWN0aW9uOyAvLy9cblxuICByZXR1cm4gdW5pdFJ1bGVQcm9kdWN0aW9uO1xufVxuIl19