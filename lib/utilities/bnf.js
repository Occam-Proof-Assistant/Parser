'use strict';

var lexers = require('occam-lexers');

var ruleNames = require('../bnf/ruleNames'),
    arrayUtilities = require('../utilities/array');

var BNFLexer = lexers.BNFLexer,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    specialSymbols = BNFLexer.specialSymbols,
    plus = specialSymbols.plus,
    asterisk = specialSymbols.asterisk,
    questionMark = specialSymbols.questionMark,
    exclamationMark = specialSymbols.exclamationMark,
    NO_WHITESPACE = specialSymbols.NO_WHITESPACE,
    RuleNameRuleName = ruleNames.RuleNameRuleName,
    RightRecursivePartRuleName = ruleNames.RightRecursivePartRuleName;


function isNodeChoiceNode(node) {
  var nodeNoChoiceNode = false;

  var nodeTerminalNode = node.isTerminalNode();

  if (nodeTerminalNode) {
    var terminalNode = node,
        terminalNodeContent = terminalNode.getContent();

    nodeNoChoiceNode = terminalNodeContent === '|';
  }

  return nodeNoChoiceNode;
}

function isNodeRuleNameNode(node) {
  var nodeRuleNameNode = false;

  var nodeTerminalNode = node.isTerminalNode(),
      nodeNonTerminalNode = !nodeTerminalNode;

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    nonTerminalNodeRuleName = nonTerminalNode.getRuleName();

    nodeRuleNameNode = nonTerminalNodeRuleName === RuleNameRuleName;
  }

  return nodeRuleNameNode;
}

function isNodeQuantifiersNode(node) {
  var nodeQuantifiersNode = false;

  var nodeTerminalNode = node.isTerminalNode(),
      nodeNonTerminalNode = !nodeTerminalNode;

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    childNodes = nonTerminalNode.getChildNodes(),
        firstChildNode = first(childNodes),
        firstChildNodeTerminalNode = firstChildNode.isTerminalNode();

    if (firstChildNodeTerminalNode) {
      var terminalNode = firstChildNode,
          ///
      terminalNodeContent = terminalNode.getContent();

      nodeQuantifiersNode = terminalNodeContent === plus || terminalNodeContent === asterisk || terminalNodeContent === questionMark || terminalNodeContent === exclamationMark;
    }
  }

  return nodeQuantifiersNode;
}

function isNodeNoWhitespaceNode(node) {
  var nodeNoWhitespaceNode = false;

  var nodeTerminalNode = node.isTerminalNode();

  if (nodeTerminalNode) {
    var terminalNode = node,
        terminalNodeContent = terminalNode.getContent();

    nodeNoWhitespaceNode = terminalNodeContent === NO_WHITESPACE;
  }

  return nodeNoWhitespaceNode;
}

function isNodeRightRecursivePartNode(node) {
  var nodeRightRecursivePartNode = false;

  var nodeTerminalNode = node.isTerminalNode(),
      nodeNonTerminalNode = !nodeTerminalNode;

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    nonTerminalNodeRuleName = nonTerminalNode.getRuleName();

    nodeRightRecursivePartNode = nonTerminalNodeRuleName === RightRecursivePartRuleName;
  }

  return nodeRightRecursivePartNode;
}

function quantifiersFromQuantifiersNode(quantifiersNode) {
  var quantifiers = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

  var quantifier = quantifierFromQuantifiersNode(quantifiersNode);

  quantifiers.push(quantifier);

  var quantifiersNodeChildNodes = quantifiersNode.getChildNodes(),
      quantifiersNodeChildNodesLength = quantifiersNodeChildNodes.length;

  if (quantifiersNodeChildNodesLength === 2) {
    var secondQuantifiersNodeChildNode = second(quantifiersNodeChildNodes),
        secondQuantifiersNodeChildNodeQuantifiersNode = isNodeQuantifiersNode(secondQuantifiersNodeChildNode);

    if (secondQuantifiersNodeChildNodeQuantifiersNode) {
      quantifiersNode = secondQuantifiersNodeChildNode; ///

      quantifiers = quantifiersFromQuantifiersNode(quantifiersNode, quantifiers);
    }
  }

  return quantifiers;
}

module.exports = {
  isNodeChoiceNode: isNodeChoiceNode,
  isNodeRuleNameNode: isNodeRuleNameNode,
  isNodeQuantifiersNode: isNodeQuantifiersNode,
  isNodeNoWhitespaceNode: isNodeNoWhitespaceNode,
  isNodeRightRecursivePartNode: isNodeRightRecursivePartNode,
  quantifiersFromQuantifiersNode: quantifiersFromQuantifiersNode
};

function quantifierFromQuantifiersNode(quantifiersNode) {
  var quantifiersNodeChildNodes = quantifiersNode.getChildNodes(),
      firstQuantifiersNodeChildNode = first(quantifiersNodeChildNodes),
      firstQuantifiersNodeChildNodeContent = firstQuantifiersNodeChildNode.getContent(),
      quantifier = firstQuantifiersNodeChildNodeContent;

  return quantifier;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvYm5mLmpzIl0sIm5hbWVzIjpbImxleGVycyIsInJlcXVpcmUiLCJydWxlTmFtZXMiLCJhcnJheVV0aWxpdGllcyIsIkJORkxleGVyIiwiZmlyc3QiLCJzZWNvbmQiLCJzcGVjaWFsU3ltYm9scyIsInBsdXMiLCJhc3RlcmlzayIsInF1ZXN0aW9uTWFyayIsImV4Y2xhbWF0aW9uTWFyayIsIk5PX1dISVRFU1BBQ0UiLCJSdWxlTmFtZVJ1bGVOYW1lIiwiUmlnaHRSZWN1cnNpdmVQYXJ0UnVsZU5hbWUiLCJpc05vZGVDaG9pY2VOb2RlIiwibm9kZSIsIm5vZGVOb0Nob2ljZU5vZGUiLCJub2RlVGVybWluYWxOb2RlIiwiaXNUZXJtaW5hbE5vZGUiLCJ0ZXJtaW5hbE5vZGUiLCJ0ZXJtaW5hbE5vZGVDb250ZW50IiwiZ2V0Q29udGVudCIsImlzTm9kZVJ1bGVOYW1lTm9kZSIsIm5vZGVSdWxlTmFtZU5vZGUiLCJub2RlTm9uVGVybWluYWxOb2RlIiwibm9uVGVybWluYWxOb2RlIiwibm9uVGVybWluYWxOb2RlUnVsZU5hbWUiLCJnZXRSdWxlTmFtZSIsImlzTm9kZVF1YW50aWZpZXJzTm9kZSIsIm5vZGVRdWFudGlmaWVyc05vZGUiLCJjaGlsZE5vZGVzIiwiZ2V0Q2hpbGROb2RlcyIsImZpcnN0Q2hpbGROb2RlIiwiZmlyc3RDaGlsZE5vZGVUZXJtaW5hbE5vZGUiLCJpc05vZGVOb1doaXRlc3BhY2VOb2RlIiwibm9kZU5vV2hpdGVzcGFjZU5vZGUiLCJpc05vZGVSaWdodFJlY3Vyc2l2ZVBhcnROb2RlIiwibm9kZVJpZ2h0UmVjdXJzaXZlUGFydE5vZGUiLCJxdWFudGlmaWVyc0Zyb21RdWFudGlmaWVyc05vZGUiLCJxdWFudGlmaWVyc05vZGUiLCJxdWFudGlmaWVycyIsInF1YW50aWZpZXIiLCJxdWFudGlmaWVyRnJvbVF1YW50aWZpZXJzTm9kZSIsInB1c2giLCJxdWFudGlmaWVyc05vZGVDaGlsZE5vZGVzIiwicXVhbnRpZmllcnNOb2RlQ2hpbGROb2Rlc0xlbmd0aCIsImxlbmd0aCIsInNlY29uZFF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZSIsInNlY29uZFF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZVF1YW50aWZpZXJzTm9kZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJmaXJzdFF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZSIsImZpcnN0UXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlQ29udGVudCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsU0FBU0MsUUFBUSxjQUFSLENBQWY7O0FBRUEsSUFBTUMsWUFBWUQsUUFBUSxrQkFBUixDQUFsQjtBQUFBLElBQ01FLGlCQUFpQkYsUUFBUSxvQkFBUixDQUR2Qjs7QUFHTSxJQUFFRyxRQUFGLEdBQWVKLE1BQWYsQ0FBRUksUUFBRjtBQUFBLElBQ0VDLEtBREYsR0FDb0JGLGNBRHBCLENBQ0VFLEtBREY7QUFBQSxJQUNTQyxNQURULEdBQ29CSCxjQURwQixDQUNTRyxNQURUO0FBQUEsSUFFRUMsY0FGRixHQUVxQkgsUUFGckIsQ0FFRUcsY0FGRjtBQUFBLElBR0VDLElBSEYsR0FHbUVELGNBSG5FLENBR0VDLElBSEY7QUFBQSxJQUdRQyxRQUhSLEdBR21FRixjQUhuRSxDQUdRRSxRQUhSO0FBQUEsSUFHa0JDLFlBSGxCLEdBR21FSCxjQUhuRSxDQUdrQkcsWUFIbEI7QUFBQSxJQUdnQ0MsZUFIaEMsR0FHbUVKLGNBSG5FLENBR2dDSSxlQUhoQztBQUFBLElBR2lEQyxhQUhqRCxHQUdtRUwsY0FIbkUsQ0FHaURLLGFBSGpEO0FBQUEsSUFJRUMsZ0JBSkYsR0FJbURYLFNBSm5ELENBSUVXLGdCQUpGO0FBQUEsSUFJb0JDLDBCQUpwQixHQUltRFosU0FKbkQsQ0FJb0JZLDBCQUpwQjs7O0FBTU4sU0FBU0MsZ0JBQVQsQ0FBMEJDLElBQTFCLEVBQWdDO0FBQzlCLE1BQUlDLG1CQUFtQixLQUF2Qjs7QUFFQSxNQUFNQyxtQkFBbUJGLEtBQUtHLGNBQUwsRUFBekI7O0FBRUEsTUFB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RUFBbUQ7QUFDakRULHdCQUFrQlEsOEJBQWxCLENBRGlELENBQ0M7O0FBRWxEUCxvQkFBY0YsK0JBQStCQyxlQUEvQixFQUFnREMsV0FBaEQsQ0FBZDtBQUNEO0FBQ0Y7O0FBRUQsU0FBT0EsV0FBUDtBQUNEOztBQUVEUyxPQUFPQyxPQUFQLEdBQWlCO0FBQ2ZwQyxvQ0FEZTtBQUVmUSx3Q0FGZTtBQUdmTSw4Q0FIZTtBQUlmTSxnREFKZTtBQUtmRSw0REFMZTtBQU1mRTtBQU5lLENBQWpCOztBQVNBLFNBQVNJLDZCQUFULENBQXVDSCxlQUF2QyxFQUF3RDtBQUN0RCxNQUFNSyw0QkFBNEJMLGdCQUFnQlIsYUFBaEIsRUFBbEM7QUFBQSxNQUNNb0IsZ0NBQWdDL0MsTUFBTXdDLHlCQUFOLENBRHRDO0FBQUEsTUFFTVEsdUNBQXVDRCw4QkFBOEI5QixVQUE5QixFQUY3QztBQUFBLE1BR01vQixhQUFhVyxvQ0FIbkI7O0FBS0EsU0FBT1gsVUFBUDtBQUNEIiwiZmlsZSI6ImJuZi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbGV4ZXJzID0gcmVxdWlyZSgnb2NjYW0tbGV4ZXJzJyk7XG5cbmNvbnN0IHJ1bGVOYW1lcyA9IHJlcXVpcmUoJy4uL2JuZi9ydWxlTmFtZXMnKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2FycmF5Jyk7XG5cbmNvbnN0IHsgQk5GTGV4ZXIgfSA9IGxleGVycyxcbiAgICAgIHsgZmlyc3QsIHNlY29uZCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHNwZWNpYWxTeW1ib2xzIH0gPSBCTkZMZXhlcixcbiAgICAgIHsgcGx1cywgYXN0ZXJpc2ssIHF1ZXN0aW9uTWFyaywgZXhjbGFtYXRpb25NYXJrLCBOT19XSElURVNQQUNFIH0gPSBzcGVjaWFsU3ltYm9scyxcbiAgICAgIHsgUnVsZU5hbWVSdWxlTmFtZSwgUmlnaHRSZWN1cnNpdmVQYXJ0UnVsZU5hbWUgfSA9IHJ1bGVOYW1lcztcblxuZnVuY3Rpb24gaXNOb2RlQ2hvaWNlTm9kZShub2RlKSB7XG4gIGxldCBub2RlTm9DaG9pY2VOb2RlID0gZmFsc2U7XG5cbiAgY29uc3Qgbm9kZVRlcm1pbmFsTm9kZSA9IG5vZGUuaXNUZXJtaW5hbE5vZGUoKTtcblxuICBpZiAobm9kZVRlcm1pbmFsTm9kZSkge1xuICAgIGNvbnN0IHRlcm1pbmFsTm9kZSA9IG5vZGUsXG4gICAgICAgICAgdGVybWluYWxOb2RlQ29udGVudCA9IHRlcm1pbmFsTm9kZS5nZXRDb250ZW50KCk7XG5cbiAgICBub2RlTm9DaG9pY2VOb2RlID0gKHRlcm1pbmFsTm9kZUNvbnRlbnQgPT09ICd8Jyk7XG4gIH1cblxuICByZXR1cm4gbm9kZU5vQ2hvaWNlTm9kZTtcbn1cblxuZnVuY3Rpb24gaXNOb2RlUnVsZU5hbWVOb2RlKG5vZGUpIHtcbiAgbGV0IG5vZGVSdWxlTmFtZU5vZGUgPSBmYWxzZTtcblxuICBjb25zdCBub2RlVGVybWluYWxOb2RlID0gbm9kZS5pc1Rlcm1pbmFsTm9kZSgpLFxuICAgICAgICBub2RlTm9uVGVybWluYWxOb2RlID0gIW5vZGVUZXJtaW5hbE5vZGU7XG5cbiAgaWYgKG5vZGVOb25UZXJtaW5hbE5vZGUpIHtcbiAgICBjb25zdCBub25UZXJtaW5hbE5vZGUgPSBub2RlLCAvLy9cbiAgICAgICAgICBub25UZXJtaW5hbE5vZGVSdWxlTmFtZSA9IG5vblRlcm1pbmFsTm9kZS5nZXRSdWxlTmFtZSgpO1xuXG4gICAgbm9kZVJ1bGVOYW1lTm9kZSA9IChub25UZXJtaW5hbE5vZGVSdWxlTmFtZSA9PT0gUnVsZU5hbWVSdWxlTmFtZSk7XG4gIH1cblxuICByZXR1cm4gbm9kZVJ1bGVOYW1lTm9kZTtcbn1cblxuZnVuY3Rpb24gaXNOb2RlUXVhbnRpZmllcnNOb2RlKG5vZGUpIHtcbiAgbGV0IG5vZGVRdWFudGlmaWVyc05vZGUgPSBmYWxzZTtcblxuICBjb25zdCBub2RlVGVybWluYWxOb2RlID0gbm9kZS5pc1Rlcm1pbmFsTm9kZSgpLFxuICAgICAgICBub2RlTm9uVGVybWluYWxOb2RlID0gIW5vZGVUZXJtaW5hbE5vZGU7XG5cbiAgaWYgKG5vZGVOb25UZXJtaW5hbE5vZGUpIHtcbiAgICBjb25zdCBub25UZXJtaW5hbE5vZGUgPSBub2RlLCAvLy9cbiAgICAgICAgICBjaGlsZE5vZGVzID0gbm9uVGVybWluYWxOb2RlLmdldENoaWxkTm9kZXMoKSxcbiAgICAgICAgICBmaXJzdENoaWxkTm9kZSA9IGZpcnN0KGNoaWxkTm9kZXMpLFxuICAgICAgICAgIGZpcnN0Q2hpbGROb2RlVGVybWluYWxOb2RlID0gZmlyc3RDaGlsZE5vZGUuaXNUZXJtaW5hbE5vZGUoKTtcblxuICAgIGlmIChmaXJzdENoaWxkTm9kZVRlcm1pbmFsTm9kZSkge1xuICAgICAgY29uc3QgdGVybWluYWxOb2RlID0gZmlyc3RDaGlsZE5vZGUsICAvLy9cbiAgICAgICAgICAgIHRlcm1pbmFsTm9kZUNvbnRlbnQgPSB0ZXJtaW5hbE5vZGUuZ2V0Q29udGVudCgpO1xuXG4gICAgICBub2RlUXVhbnRpZmllcnNOb2RlID0gKHRlcm1pbmFsTm9kZUNvbnRlbnQgPT09IHBsdXMpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRlcm1pbmFsTm9kZUNvbnRlbnQgPT09IGFzdGVyaXNrKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0ZXJtaW5hbE5vZGVDb250ZW50ID09PSBxdWVzdGlvbk1hcmspIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRlcm1pbmFsTm9kZUNvbnRlbnQgPT09IGV4Y2xhbWF0aW9uTWFyayk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5vZGVRdWFudGlmaWVyc05vZGU7XG59XG5cbmZ1bmN0aW9uIGlzTm9kZU5vV2hpdGVzcGFjZU5vZGUobm9kZSkge1xuICBsZXQgbm9kZU5vV2hpdGVzcGFjZU5vZGUgPSBmYWxzZTtcblxuICBjb25zdCBub2RlVGVybWluYWxOb2RlID0gbm9kZS5pc1Rlcm1pbmFsTm9kZSgpO1xuXG4gIGlmIChub2RlVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3QgdGVybWluYWxOb2RlID0gbm9kZSxcbiAgICAgICAgICB0ZXJtaW5hbE5vZGVDb250ZW50ID0gdGVybWluYWxOb2RlLmdldENvbnRlbnQoKTtcblxuICAgIG5vZGVOb1doaXRlc3BhY2VOb2RlID0gKHRlcm1pbmFsTm9kZUNvbnRlbnQgPT09IE5PX1dISVRFU1BBQ0UpO1xuICB9XG5cbiAgcmV0dXJuIG5vZGVOb1doaXRlc3BhY2VOb2RlO1xufVxuXG5mdW5jdGlvbiBpc05vZGVSaWdodFJlY3Vyc2l2ZVBhcnROb2RlKG5vZGUpIHtcbiAgbGV0IG5vZGVSaWdodFJlY3Vyc2l2ZVBhcnROb2RlID0gZmFsc2U7XG5cbiAgY29uc3Qgbm9kZVRlcm1pbmFsTm9kZSA9IG5vZGUuaXNUZXJtaW5hbE5vZGUoKSxcbiAgICAgICAgbm9kZU5vblRlcm1pbmFsTm9kZSA9ICFub2RlVGVybWluYWxOb2RlO1xuXG4gIGlmIChub2RlTm9uVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3Qgbm9uVGVybWluYWxOb2RlID0gbm9kZSwgLy8vXG4gICAgICAgIG5vblRlcm1pbmFsTm9kZVJ1bGVOYW1lID0gbm9uVGVybWluYWxOb2RlLmdldFJ1bGVOYW1lKCk7XG5cbiAgICBub2RlUmlnaHRSZWN1cnNpdmVQYXJ0Tm9kZSA9IChub25UZXJtaW5hbE5vZGVSdWxlTmFtZSA9PT0gUmlnaHRSZWN1cnNpdmVQYXJ0UnVsZU5hbWUpO1xuICB9XG5cbiAgcmV0dXJuIG5vZGVSaWdodFJlY3Vyc2l2ZVBhcnROb2RlO1xufVxuXG5mdW5jdGlvbiBxdWFudGlmaWVyc0Zyb21RdWFudGlmaWVyc05vZGUocXVhbnRpZmllcnNOb2RlLCBxdWFudGlmaWVycyA9IFtdKSB7XG4gIGNvbnN0IHF1YW50aWZpZXIgPSBxdWFudGlmaWVyRnJvbVF1YW50aWZpZXJzTm9kZShxdWFudGlmaWVyc05vZGUpO1xuXG4gIHF1YW50aWZpZXJzLnB1c2gocXVhbnRpZmllcik7XG5cbiAgY29uc3QgcXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlcyA9IHF1YW50aWZpZXJzTm9kZS5nZXRDaGlsZE5vZGVzKCksXG4gICAgICAgIHF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZXNMZW5ndGggPSAgcXVhbnRpZmllcnNOb2RlQ2hpbGROb2Rlcy5sZW5ndGg7XG5cbiAgaWYgKHF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZXNMZW5ndGggPT09IDIpIHtcbiAgICBjb25zdCBzZWNvbmRRdWFudGlmaWVyc05vZGVDaGlsZE5vZGUgPSBzZWNvbmQocXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlcyksXG4gICAgICAgICAgc2Vjb25kUXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlUXVhbnRpZmllcnNOb2RlID0gaXNOb2RlUXVhbnRpZmllcnNOb2RlKHNlY29uZFF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZSk7XG5cbiAgICBpZiAoc2Vjb25kUXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlUXVhbnRpZmllcnNOb2RlKSB7XG4gICAgICBxdWFudGlmaWVyc05vZGUgPSBzZWNvbmRRdWFudGlmaWVyc05vZGVDaGlsZE5vZGU7IC8vL1xuXG4gICAgICBxdWFudGlmaWVycyA9IHF1YW50aWZpZXJzRnJvbVF1YW50aWZpZXJzTm9kZShxdWFudGlmaWVyc05vZGUsIHF1YW50aWZpZXJzKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcXVhbnRpZmllcnM7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBpc05vZGVDaG9pY2VOb2RlLFxuICBpc05vZGVSdWxlTmFtZU5vZGUsXG4gIGlzTm9kZVF1YW50aWZpZXJzTm9kZSxcbiAgaXNOb2RlTm9XaGl0ZXNwYWNlTm9kZSxcbiAgaXNOb2RlUmlnaHRSZWN1cnNpdmVQYXJ0Tm9kZSxcbiAgcXVhbnRpZmllcnNGcm9tUXVhbnRpZmllcnNOb2RlXG59O1xuXG5mdW5jdGlvbiBxdWFudGlmaWVyRnJvbVF1YW50aWZpZXJzTm9kZShxdWFudGlmaWVyc05vZGUpIHtcbiAgY29uc3QgcXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlcyA9IHF1YW50aWZpZXJzTm9kZS5nZXRDaGlsZE5vZGVzKCksXG4gICAgICAgIGZpcnN0UXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlID0gZmlyc3QocXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlcyksXG4gICAgICAgIGZpcnN0UXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlQ29udGVudCA9IGZpcnN0UXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlLmdldENvbnRlbnQoKSxcbiAgICAgICAgcXVhbnRpZmllciA9IGZpcnN0UXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlQ29udGVudDtcblxuICByZXR1cm4gcXVhbnRpZmllcjtcbn1cbiJdfQ==