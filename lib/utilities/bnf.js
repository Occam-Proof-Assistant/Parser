'use strict';

var lexers = require('occam-lexers');

var ruleNames = require('../bnf/ruleNames'),
    arrayUtilities = require('../utilities/array');

var first = arrayUtilities.first,
    second = arrayUtilities.second,
    specialSymbols = lexers.specialSymbols,
    RuleNameRuleName = ruleNames.RuleNameRuleName,
    RightRecursivePartRuleName = ruleNames.RightRecursivePartRuleName,
    plus = specialSymbols.plus,
    asterisk = specialSymbols.asterisk,
    questionMark = specialSymbols.questionMark,
    exclamationMark = specialSymbols.exclamationMark,
    NO_WHITESPACE = specialSymbols.NO_WHITESPACE;


function isNodeChoiceNode(node) {
  var nodeNoChoiceNode = false;

  var nodeTerminalNode = node.isTerminalNode();

  if (nodeTerminalNode) {
    var terminalNode = node,
        terminalNodeContent = terminalNode.getContent();

    nodeNoChoiceNode = terminalNodeContent === '|';
  }

  return nodeNoChoiceNode;
}

function isNodeRuleNameNode(node) {
  var nodeRuleNameNode = false;

  var nodeTerminalNode = node.isTerminalNode(),
      nodeNonTerminalNode = !nodeTerminalNode;

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    nonTerminalNodeRuleName = nonTerminalNode.getRuleName();

    nodeRuleNameNode = nonTerminalNodeRuleName === RuleNameRuleName;
  }

  return nodeRuleNameNode;
}

function isNodeQuantifiersNode(node) {
  var nodeQuantifiersNode = false;

  var nodeTerminalNode = node.isTerminalNode(),
      nodeNonTerminalNode = !nodeTerminalNode;

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    childNodes = nonTerminalNode.getChildNodes(),
        firstChildNode = first(childNodes),
        firstChildNodeTerminalNode = firstChildNode.isTerminalNode();

    if (firstChildNodeTerminalNode) {
      var terminalNode = firstChildNode,
          ///
      terminalNodeContent = terminalNode.getContent();

      nodeQuantifiersNode = terminalNodeContent === plus || terminalNodeContent === asterisk || terminalNodeContent === questionMark || terminalNodeContent === exclamationMark;
    }
  }

  return nodeQuantifiersNode;
}

function isNodeNoWhitespaceNode(node) {
  var nodeNoWhitespaceNode = false;

  var nodeTerminalNode = node.isTerminalNode();

  if (nodeTerminalNode) {
    var terminalNode = node,
        terminalNodeContent = terminalNode.getContent();

    nodeNoWhitespaceNode = terminalNodeContent === NO_WHITESPACE;
  }

  return nodeNoWhitespaceNode;
}

function isNodeRightRecursivePartNode(node) {
  var nodeRightRecursivePartNode = false;

  var nodeTerminalNode = node.isTerminalNode(),
      nodeNonTerminalNode = !nodeTerminalNode;

  if (nodeNonTerminalNode) {
    var nonTerminalNode = node,
        ///
    nonTerminalNodeRuleName = nonTerminalNode.getRuleName();

    nodeRightRecursivePartNode = nonTerminalNodeRuleName === RightRecursivePartRuleName;
  }

  return nodeRightRecursivePartNode;
}

function quantifiersFromQuantifiersNode(quantifiersNode) {
  var quantifiers = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

  var quantifier = quantifierFromQuantifiersNode(quantifiersNode);

  quantifiers.push(quantifier);

  var quantifiersNodeChildNodes = quantifiersNode.getChildNodes(),
      quantifiersNodeChildNodesLength = quantifiersNodeChildNodes.length;

  if (quantifiersNodeChildNodesLength === 2) {
    var secondQuantifiersNodeChildNode = second(quantifiersNodeChildNodes),
        secondQuantifiersNodeChildNodeQuantifiersNode = isNodeQuantifiersNode(secondQuantifiersNodeChildNode);

    if (secondQuantifiersNodeChildNodeQuantifiersNode) {
      quantifiersNode = secondQuantifiersNodeChildNode; ///

      quantifiers = quantifiersFromQuantifiersNode(quantifiersNode, quantifiers);
    }
  }

  return quantifiers;
}

module.exports = {
  isNodeChoiceNode: isNodeChoiceNode,
  isNodeRuleNameNode: isNodeRuleNameNode,
  isNodeQuantifiersNode: isNodeQuantifiersNode,
  isNodeNoWhitespaceNode: isNodeNoWhitespaceNode,
  isNodeRightRecursivePartNode: isNodeRightRecursivePartNode,
  quantifiersFromQuantifiersNode: quantifiersFromQuantifiersNode
};

function quantifierFromQuantifiersNode(quantifiersNode) {
  var quantifiersNodeChildNodes = quantifiersNode.getChildNodes(),
      firstQuantifiersNodeChildNode = first(quantifiersNodeChildNodes),
      firstQuantifiersNodeChildNodeContent = firstQuantifiersNodeChildNode.getContent(),
      quantifier = firstQuantifiersNodeChildNodeContent;

  return quantifier;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvYm5mLmpzIl0sIm5hbWVzIjpbImxleGVycyIsInJlcXVpcmUiLCJydWxlTmFtZXMiLCJhcnJheVV0aWxpdGllcyIsImZpcnN0Iiwic2Vjb25kIiwic3BlY2lhbFN5bWJvbHMiLCJSdWxlTmFtZVJ1bGVOYW1lIiwiUmlnaHRSZWN1cnNpdmVQYXJ0UnVsZU5hbWUiLCJwbHVzIiwiYXN0ZXJpc2siLCJxdWVzdGlvbk1hcmsiLCJleGNsYW1hdGlvbk1hcmsiLCJOT19XSElURVNQQUNFIiwiaXNOb2RlQ2hvaWNlTm9kZSIsIm5vZGUiLCJub2RlTm9DaG9pY2VOb2RlIiwibm9kZVRlcm1pbmFsTm9kZSIsImlzVGVybWluYWxOb2RlIiwidGVybWluYWxOb2RlIiwidGVybWluYWxOb2RlQ29udGVudCIsImdldENvbnRlbnQiLCJpc05vZGVSdWxlTmFtZU5vZGUiLCJub2RlUnVsZU5hbWVOb2RlIiwibm9kZU5vblRlcm1pbmFsTm9kZSIsIm5vblRlcm1pbmFsTm9kZSIsIm5vblRlcm1pbmFsTm9kZVJ1bGVOYW1lIiwiZ2V0UnVsZU5hbWUiLCJpc05vZGVRdWFudGlmaWVyc05vZGUiLCJub2RlUXVhbnRpZmllcnNOb2RlIiwiY2hpbGROb2RlcyIsImdldENoaWxkTm9kZXMiLCJmaXJzdENoaWxkTm9kZSIsImZpcnN0Q2hpbGROb2RlVGVybWluYWxOb2RlIiwiaXNOb2RlTm9XaGl0ZXNwYWNlTm9kZSIsIm5vZGVOb1doaXRlc3BhY2VOb2RlIiwiaXNOb2RlUmlnaHRSZWN1cnNpdmVQYXJ0Tm9kZSIsIm5vZGVSaWdodFJlY3Vyc2l2ZVBhcnROb2RlIiwicXVhbnRpZmllcnNGcm9tUXVhbnRpZmllcnNOb2RlIiwicXVhbnRpZmllcnNOb2RlIiwicXVhbnRpZmllcnMiLCJxdWFudGlmaWVyIiwicXVhbnRpZmllckZyb21RdWFudGlmaWVyc05vZGUiLCJwdXNoIiwicXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlcyIsInF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZXNMZW5ndGgiLCJsZW5ndGgiLCJzZWNvbmRRdWFudGlmaWVyc05vZGVDaGlsZE5vZGUiLCJzZWNvbmRRdWFudGlmaWVyc05vZGVDaGlsZE5vZGVRdWFudGlmaWVyc05vZGUiLCJtb2R1bGUiLCJleHBvcnRzIiwiZmlyc3RRdWFudGlmaWVyc05vZGVDaGlsZE5vZGUiLCJmaXJzdFF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZUNvbnRlbnQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFNBQVNDLFFBQVEsY0FBUixDQUFmOztBQUVBLElBQU1DLFlBQVlELFFBQVEsa0JBQVIsQ0FBbEI7QUFBQSxJQUNNRSxpQkFBaUJGLFFBQVEsb0JBQVIsQ0FEdkI7O0lBR1FHLEssR0FBa0JELGMsQ0FBbEJDLEs7SUFBT0MsTSxHQUFXRixjLENBQVhFLE07SUFDUEMsYyxHQUFtQk4sTSxDQUFuQk0sYztJQUNBQyxnQixHQUFpREwsUyxDQUFqREssZ0I7SUFBa0JDLDBCLEdBQStCTixTLENBQS9CTSwwQjtJQUNsQkMsSSxHQUFpRUgsYyxDQUFqRUcsSTtJQUFNQyxRLEdBQTJESixjLENBQTNESSxRO0lBQVVDLFksR0FBaURMLGMsQ0FBakRLLFk7SUFBY0MsZSxHQUFtQ04sYyxDQUFuQ00sZTtJQUFpQkMsYSxHQUFrQlAsYyxDQUFsQk8sYTs7O0FBRXZELFNBQVNDLGdCQUFULENBQTBCQyxJQUExQixFQUFnQztBQUM5QixNQUFJQyxtQkFBbUIsS0FBdkI7O0FBRUEsTUFBTUMsbUJBQW1CRixLQUFLRyxjQUFMLEVBQXpCOztBQUVBLE1BQUlELGdCQUFKLEVBQXNCO0FBQ3BCLFFBQU1FLGVBQWVKLElBQXJCO0FBQUEsUUFDTUssc0JBQXNCRCxhQUFhRSxVQUFiLEVBRDVCOztBQUdBTCx1QkFBb0JJLHdCQUF3QixHQUE1QztBQUNEOztBQUVELFNBQU9KLGdCQUFQO0FBQ0Q7O0FBRUQsU0FBU00sa0JBQVQsQ0FBNEJQLElBQTVCLEVBQWtDO0FBQ2hDLE1BQUlRLG1CQUFtQixLQUF2Qjs7QUFFQSxNQUFN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TGU7QUFNZkU7QUFOZSxDQUFqQjs7QUFTQSxTQUFTSSw2QkFBVCxDQUF1Q0gsZUFBdkMsRUFBd0Q7QUFDdEQsTUFBTUssNEJBQTRCTCxnQkFBZ0JSLGFBQWhCLEVBQWxDO0FBQUEsTUFDTW9CLGdDQUFnQy9DLE1BQU13Qyx5QkFBTixDQUR0QztBQUFBLE1BRU1RLHVDQUF1Q0QsOEJBQThCOUIsVUFBOUIsRUFGN0M7QUFBQSxNQUdNb0IsYUFBYVcsb0NBSG5COztBQUtBLFNBQU9YLFVBQVA7QUFDRCIsImZpbGUiOiJibmYuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGxleGVycyA9IHJlcXVpcmUoJ29jY2FtLWxleGVycycpO1xuXG5jb25zdCBydWxlTmFtZXMgPSByZXF1aXJlKCcuLi9ibmYvcnVsZU5hbWVzJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9hcnJheScpO1xuXG5jb25zdCB7IGZpcnN0LCBzZWNvbmQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBzcGVjaWFsU3ltYm9scyB9ID0gbGV4ZXJzLFxuICAgICAgeyBSdWxlTmFtZVJ1bGVOYW1lLCBSaWdodFJlY3Vyc2l2ZVBhcnRSdWxlTmFtZSB9ID0gcnVsZU5hbWVzLFxuICAgICAgeyBwbHVzLCBhc3RlcmlzaywgcXVlc3Rpb25NYXJrLCBleGNsYW1hdGlvbk1hcmssIE5PX1dISVRFU1BBQ0UgfSA9IHNwZWNpYWxTeW1ib2xzO1xuXG5mdW5jdGlvbiBpc05vZGVDaG9pY2VOb2RlKG5vZGUpIHtcbiAgbGV0IG5vZGVOb0Nob2ljZU5vZGUgPSBmYWxzZTtcblxuICBjb25zdCBub2RlVGVybWluYWxOb2RlID0gbm9kZS5pc1Rlcm1pbmFsTm9kZSgpO1xuXG4gIGlmIChub2RlVGVybWluYWxOb2RlKSB7XG4gICAgY29uc3QgdGVybWluYWxOb2RlID0gbm9kZSxcbiAgICAgICAgICB0ZXJtaW5hbE5vZGVDb250ZW50ID0gdGVybWluYWxOb2RlLmdldENvbnRlbnQoKTtcblxuICAgIG5vZGVOb0Nob2ljZU5vZGUgPSAodGVybWluYWxOb2RlQ29udGVudCA9PT0gJ3wnKTtcbiAgfVxuXG4gIHJldHVybiBub2RlTm9DaG9pY2VOb2RlO1xufVxuXG5mdW5jdGlvbiBpc05vZGVSdWxlTmFtZU5vZGUobm9kZSkge1xuICBsZXQgbm9kZVJ1bGVOYW1lTm9kZSA9IGZhbHNlO1xuXG4gIGNvbnN0IG5vZGVUZXJtaW5hbE5vZGUgPSBub2RlLmlzVGVybWluYWxOb2RlKCksXG4gICAgICAgIG5vZGVOb25UZXJtaW5hbE5vZGUgPSAhbm9kZVRlcm1pbmFsTm9kZTtcblxuICBpZiAobm9kZU5vblRlcm1pbmFsTm9kZSkge1xuICAgIGNvbnN0IG5vblRlcm1pbmFsTm9kZSA9IG5vZGUsIC8vL1xuICAgICAgICAgIG5vblRlcm1pbmFsTm9kZVJ1bGVOYW1lID0gbm9uVGVybWluYWxOb2RlLmdldFJ1bGVOYW1lKCk7XG5cbiAgICBub2RlUnVsZU5hbWVOb2RlID0gKG5vblRlcm1pbmFsTm9kZVJ1bGVOYW1lID09PSBSdWxlTmFtZVJ1bGVOYW1lKTtcbiAgfVxuXG4gIHJldHVybiBub2RlUnVsZU5hbWVOb2RlO1xufVxuXG5mdW5jdGlvbiBpc05vZGVRdWFudGlmaWVyc05vZGUobm9kZSkge1xuICBsZXQgbm9kZVF1YW50aWZpZXJzTm9kZSA9IGZhbHNlO1xuXG4gIGNvbnN0IG5vZGVUZXJtaW5hbE5vZGUgPSBub2RlLmlzVGVybWluYWxOb2RlKCksXG4gICAgICAgIG5vZGVOb25UZXJtaW5hbE5vZGUgPSAhbm9kZVRlcm1pbmFsTm9kZTtcblxuICBpZiAobm9kZU5vblRlcm1pbmFsTm9kZSkge1xuICAgIGNvbnN0IG5vblRlcm1pbmFsTm9kZSA9IG5vZGUsIC8vL1xuICAgICAgICAgIGNoaWxkTm9kZXMgPSBub25UZXJtaW5hbE5vZGUuZ2V0Q2hpbGROb2RlcygpLFxuICAgICAgICAgIGZpcnN0Q2hpbGROb2RlID0gZmlyc3QoY2hpbGROb2RlcyksXG4gICAgICAgICAgZmlyc3RDaGlsZE5vZGVUZXJtaW5hbE5vZGUgPSBmaXJzdENoaWxkTm9kZS5pc1Rlcm1pbmFsTm9kZSgpO1xuXG4gICAgaWYgKGZpcnN0Q2hpbGROb2RlVGVybWluYWxOb2RlKSB7XG4gICAgICBjb25zdCB0ZXJtaW5hbE5vZGUgPSBmaXJzdENoaWxkTm9kZSwgIC8vL1xuICAgICAgICAgICAgdGVybWluYWxOb2RlQ29udGVudCA9IHRlcm1pbmFsTm9kZS5nZXRDb250ZW50KCk7XG5cbiAgICAgIG5vZGVRdWFudGlmaWVyc05vZGUgPSAodGVybWluYWxOb2RlQ29udGVudCA9PT0gcGx1cykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGVybWluYWxOb2RlQ29udGVudCA9PT0gYXN0ZXJpc2spIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHRlcm1pbmFsTm9kZUNvbnRlbnQgPT09IHF1ZXN0aW9uTWFyaykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodGVybWluYWxOb2RlQ29udGVudCA9PT0gZXhjbGFtYXRpb25NYXJrKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbm9kZVF1YW50aWZpZXJzTm9kZTtcbn1cblxuZnVuY3Rpb24gaXNOb2RlTm9XaGl0ZXNwYWNlTm9kZShub2RlKSB7XG4gIGxldCBub2RlTm9XaGl0ZXNwYWNlTm9kZSA9IGZhbHNlO1xuXG4gIGNvbnN0IG5vZGVUZXJtaW5hbE5vZGUgPSBub2RlLmlzVGVybWluYWxOb2RlKCk7XG5cbiAgaWYgKG5vZGVUZXJtaW5hbE5vZGUpIHtcbiAgICBjb25zdCB0ZXJtaW5hbE5vZGUgPSBub2RlLFxuICAgICAgICAgIHRlcm1pbmFsTm9kZUNvbnRlbnQgPSB0ZXJtaW5hbE5vZGUuZ2V0Q29udGVudCgpO1xuXG4gICAgbm9kZU5vV2hpdGVzcGFjZU5vZGUgPSAodGVybWluYWxOb2RlQ29udGVudCA9PT0gTk9fV0hJVEVTUEFDRSk7XG4gIH1cblxuICByZXR1cm4gbm9kZU5vV2hpdGVzcGFjZU5vZGU7XG59XG5cbmZ1bmN0aW9uIGlzTm9kZVJpZ2h0UmVjdXJzaXZlUGFydE5vZGUobm9kZSkge1xuICBsZXQgbm9kZVJpZ2h0UmVjdXJzaXZlUGFydE5vZGUgPSBmYWxzZTtcblxuICBjb25zdCBub2RlVGVybWluYWxOb2RlID0gbm9kZS5pc1Rlcm1pbmFsTm9kZSgpLFxuICAgICAgICBub2RlTm9uVGVybWluYWxOb2RlID0gIW5vZGVUZXJtaW5hbE5vZGU7XG5cbiAgaWYgKG5vZGVOb25UZXJtaW5hbE5vZGUpIHtcbiAgICBjb25zdCBub25UZXJtaW5hbE5vZGUgPSBub2RlLCAvLy9cbiAgICAgICAgbm9uVGVybWluYWxOb2RlUnVsZU5hbWUgPSBub25UZXJtaW5hbE5vZGUuZ2V0UnVsZU5hbWUoKTtcblxuICAgIG5vZGVSaWdodFJlY3Vyc2l2ZVBhcnROb2RlID0gKG5vblRlcm1pbmFsTm9kZVJ1bGVOYW1lID09PSBSaWdodFJlY3Vyc2l2ZVBhcnRSdWxlTmFtZSk7XG4gIH1cblxuICByZXR1cm4gbm9kZVJpZ2h0UmVjdXJzaXZlUGFydE5vZGU7XG59XG5cbmZ1bmN0aW9uIHF1YW50aWZpZXJzRnJvbVF1YW50aWZpZXJzTm9kZShxdWFudGlmaWVyc05vZGUsIHF1YW50aWZpZXJzID0gW10pIHtcbiAgY29uc3QgcXVhbnRpZmllciA9IHF1YW50aWZpZXJGcm9tUXVhbnRpZmllcnNOb2RlKHF1YW50aWZpZXJzTm9kZSk7XG5cbiAgcXVhbnRpZmllcnMucHVzaChxdWFudGlmaWVyKTtcblxuICBjb25zdCBxdWFudGlmaWVyc05vZGVDaGlsZE5vZGVzID0gcXVhbnRpZmllcnNOb2RlLmdldENoaWxkTm9kZXMoKSxcbiAgICAgICAgcXVhbnRpZmllcnNOb2RlQ2hpbGROb2Rlc0xlbmd0aCA9ICBxdWFudGlmaWVyc05vZGVDaGlsZE5vZGVzLmxlbmd0aDtcblxuICBpZiAocXVhbnRpZmllcnNOb2RlQ2hpbGROb2Rlc0xlbmd0aCA9PT0gMikge1xuICAgIGNvbnN0IHNlY29uZFF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZSA9IHNlY29uZChxdWFudGlmaWVyc05vZGVDaGlsZE5vZGVzKSxcbiAgICAgICAgICBzZWNvbmRRdWFudGlmaWVyc05vZGVDaGlsZE5vZGVRdWFudGlmaWVyc05vZGUgPSBpc05vZGVRdWFudGlmaWVyc05vZGUoc2Vjb25kUXVhbnRpZmllcnNOb2RlQ2hpbGROb2RlKTtcblxuICAgIGlmIChzZWNvbmRRdWFudGlmaWVyc05vZGVDaGlsZE5vZGVRdWFudGlmaWVyc05vZGUpIHtcbiAgICAgIHF1YW50aWZpZXJzTm9kZSA9IHNlY29uZFF1YW50aWZpZXJzTm9kZUNoaWxkTm9kZTsgLy8vXG5cbiAgICAgIHF1YW50aWZpZXJzID0gcXVhbnRpZmllcnNGcm9tUXVhbnRpZmllcnNOb2RlKHF1YW50aWZpZXJzTm9kZSwgcXVhbnRpZmllcnMpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBxdWFudGlmaWVycztcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGlzTm9kZUNob2ljZU5vZGUsXG4gIGlzTm9kZVJ1bGVOYW1lTm9kZSxcbiAgaXNOb2RlUXVhbnRpZmllcnNOb2RlLFxuICBpc05vZGVOb1doaXRlc3BhY2VOb2RlLFxuICBpc05vZGVSaWdodFJlY3Vyc2l2ZVBhcnROb2RlLFxuICBxdWFudGlmaWVyc0Zyb21RdWFudGlmaWVyc05vZGVcbn07XG5cbmZ1bmN0aW9uIHF1YW50aWZpZXJGcm9tUXVhbnRpZmllcnNOb2RlKHF1YW50aWZpZXJzTm9kZSkge1xuICBjb25zdCBxdWFudGlmaWVyc05vZGVDaGlsZE5vZGVzID0gcXVhbnRpZmllcnNOb2RlLmdldENoaWxkTm9kZXMoKSxcbiAgICAgICAgZmlyc3RRdWFudGlmaWVyc05vZGVDaGlsZE5vZGUgPSBmaXJzdChxdWFudGlmaWVyc05vZGVDaGlsZE5vZGVzKSxcbiAgICAgICAgZmlyc3RRdWFudGlmaWVyc05vZGVDaGlsZE5vZGVDb250ZW50ID0gZmlyc3RRdWFudGlmaWVyc05vZGVDaGlsZE5vZGUuZ2V0Q29udGVudCgpLFxuICAgICAgICBxdWFudGlmaWVyID0gZmlyc3RRdWFudGlmaWVyc05vZGVDaGlsZE5vZGVDb250ZW50O1xuXG4gIHJldHVybiBxdWFudGlmaWVyO1xufVxuIl19