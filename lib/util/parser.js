'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Graph = require('../graph'),
    CyclicProduction = require('../common/production/cyclic'),
    RightRecursiveProduction = require('../common/production/rightRecursive'),
    NonLeftRecursiveProduction = require('../common/production/nonLeftRecursive'),
    NonImplicitlyLeftRecursiveProduction = require('../common/production/nonImplicitlyLeftRecursive');

var parserUtil = function () {
  function parserUtil() {
    _classCallCheck(this, parserUtil);
  }

  _createClass(parserUtil, null, [{
    key: 'tokensFromLines',
    value: function tokensFromLines(lines) {
      var tokens = lines.reduce(function (tokens, line) {
        var lineTokens = line.getTokens();

        tokens = tokens.concat(lineTokens);

        return tokens;
      }, []);

      return tokens;
    }
  }, {
    key: 'eliminateCycles',
    value: function eliminateCycles(productions) {
      var cyclicProductions = cyclicProductionsFromProductions(productions),
          graph = graphFromCyclicProductions(cyclicProductions),
          components = graph.getComponents();

      productions = productionsFromComponents(components, productions);

      return productions;
    }
  }, {
    key: 'eliminateLeftRecursion',
    value: function eliminateLeftRecursion(productions) {
      var nonLeftRecursiveProductions = [],
          rightRecursiveProductions = [];

      productions.forEach(function (production, index) {
        var begin = 0,
            end = index,
            ///
        previousNonLeftRecursiveProductions = nonLeftRecursiveProductions.slice(begin, end),
            previousProductions = previousNonLeftRecursiveProductions,
            ///
        productionImplicitlyLeftRecursive = production.isImplicitlyLeftRecursive(previousProductions);

        if (productionImplicitlyLeftRecursive) {
          var nonImplicitlyLeftRecursiveProduction = NonImplicitlyLeftRecursiveProduction.fromProductionAndPreviousProductions(production, previousProductions);

          production = nonImplicitlyLeftRecursiveProduction; ///
        }

        var productionLeftRecursive = production.isLeftRecursive();

        if (productionLeftRecursive) {
          var nonLeftRecursiveProduction = NonLeftRecursiveProduction.fromProduction(production),
              rightRecursiveProduction = RightRecursiveProduction.fromProduction(production);

          nonLeftRecursiveProductions.push(nonLeftRecursiveProduction);

          rightRecursiveProductions.push(rightRecursiveProduction);
        } else {
          var _nonLeftRecursiveProduction = production; ///

          nonLeftRecursiveProductions.push(_nonLeftRecursiveProduction);
        }
      });

      productions = [].concat(nonLeftRecursiveProductions).concat(rightRecursiveProductions);

      return productions;
    }
  }, {
    key: 'findProduction',
    value: function findProduction(productionName, productions) {
      var foundProduction = null;

      productions.some(function (production) {
        var name = production.getName();

        if (name === productionName) {
          foundProduction = production;

          return true;
        }
      });

      var production = foundProduction;

      return production;
    }
  }]);

  return parserUtil;
}();

module.exports = parserUtil;

function cyclicProductionsFromProductions(productions) {
  var cyclicProductions = productions.reduce(function (cyclicProductions, production) {
    var cyclicProduction = CyclicProduction.fromProduction(production);

    if (cyclicProduction !== null) {
      cyclicProductions.push(cyclicProduction);
    }

    return cyclicProductions;
  }, []);

  return cyclicProductions;
}

function graphFromCyclicProductions(cyclicProductions) {
  var graph = new Graph();

  cyclicProductions.forEach(function (cyclicProduction) {
    var cyclicProductionName = cyclicProduction.getName(),
        cyclicProductionRulesProductionNames = cyclicProduction.getRulesProductionNames(),
        vertexName = cyclicProductionName,
        ///
    descendantVertexNames = cyclicProductionRulesProductionNames; ///

    graph.addVertex(vertexName, descendantVertexNames);
  });

  return graph;
}

function productionsFromComponents(components, productions) {
  var componentProductions = components.reduce(function (componentProductions, component) {
    var componentCyclic = component.isCyclic();

    if (componentCyclic) {
      var cyclicComponent = component,
          ///
      nonCyclicProductions = nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions);

      componentProductions = componentProductions.concat(nonCyclicProductions);
    } else {
      var nonCyclicComponent = component,
          ///
      production = productionFromNonCyclicComponent(nonCyclicComponent, productions);

      componentProductions.push(production);
    }

    return componentProductions;
  }, []);

  productions = componentProductions; ///

  return productions;
}

function nonCyclicProductionsFromCyclicComponent(cyclicComponent, productions) {
  var cyclicProductions = cyclicComponent.mapVertex(function (vertex) {
    var vertexName = vertex.getName(),
        cyclicProductionName = vertexName,
        ///
    production = parserUtil.findProduction(cyclicProductionName, productions),
        cyclicProduction = CyclicProduction.fromProduction(production);

    return cyclicProduction;
  }),
      unitProductions = unitProductionsFromCyclicProductions(cyclicProductions);

  debugger;
}

function unitProductionsFromCyclicProductions(cyclicProductions) {
  var unitProductions = cyclicProductions.reduce(function (unitProductions, cyclicProduction) {
    var cyclicProductionEdges = cyclicProduction.getUnitProductions();

    unitProductions = unitProductions.concat(cyclicProductionEdges);

    return unitProductions;
  }, []);

  return unitProductions;
}

function productionFromNonCyclicComponent(nonCyclicComponent, productions) {
  var nonCyclicComponentFirstVertex = nonCyclicComponent.getFirstVertex(),
      nonCyclicComponentFirstVertexName = nonCyclicComponentFirstVertex.getName(),
      productionName = nonCyclicComponentFirstVertexName,
      ///
  production = parserUtil.findProduction(productionName, productions);

  return production;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsL3BhcnNlci5qcyJdLCJuYW1lcyI6WyJHcmFwaCIsInJlcXVpcmUiLCJDeWNsaWNQcm9kdWN0aW9uIiwiUmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uIiwiTm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24iLCJOb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24iLCJwYXJzZXJVdGlsIiwibGluZXMiLCJ0b2tlbnMiLCJyZWR1Y2UiLCJsaW5lIiwibGluZVRva2VucyIsImdldFRva2VucyIsImNvbmNhdCIsInByb2R1Y3Rpb25zIiwiY3ljbGljUHJvZHVjdGlvbnMiLCJjeWNsaWNQcm9kdWN0aW9uc0Zyb21Qcm9kdWN0aW9ucyIsImdyYXBoIiwiZ3JhcGhGcm9tQ3ljbGljUHJvZHVjdGlvbnMiLCJjb21wb25lbnRzIiwiZ2V0Q29tcG9uZW50cyIsInByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMiLCJub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMiLCJyaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb25zIiwiZm9yRWFjaCIsInByb2R1Y3Rpb24iLCJpbmRleCIsImJlZ2luIiwiZW5kIiwicHJldmlvdXNOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMiLCJzbGljZSIsInByZXZpb3VzUHJvZHVjdGlvbnMiLCJwcm9kdWN0aW9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmUiLCJpc0ltcGxpY2l0bHlMZWZ0UmVjdXJzaXZlIiwibm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uIiwiZnJvbVByb2R1Y3Rpb25BbmRQcmV2aW91c1Byb2R1Y3Rpb25zIiwicHJvZHVjdGlvbkxlZnRSZWN1cnNpdmUiLCJpc0xlZnRSZWN1cnNpdmUiLCJub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbiIsImZyb21Qcm9kdWN0aW9uIiwicmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uIiwicHVzaCIsInByb2R1Y3Rpb25OYW1lIiwiZm91bmRQcm9kdWN0aW9uIiwic29tZSIsIm5hbWUiLCJnZXROYW1lIiwibW9kdWxlIiwiZXhwb3J0cyIsImN5Y2xpY1Byb2R1Y3Rpb24iLCJjeWNsaWNQcm9kdWN0aW9uTmFtZSIsImN5Y2xpY1Byb2R1Y3Rpb25SdWxlc1Byb2R1Y3Rpb25OYW1lcyIsImdldFJ1bGVzUHJvZHVjdGlvbk5hbWVzIiwidmVydGV4TmFtZSIsImRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyIsImFkZFZlcnRleCIsImNvbXBvbmVudFByb2R1Y3Rpb25zIiwiY29tcG9uZW50IiwiY29tcG9uZW50Q3ljbGljIiwiaXNDeWNsaWMiLCJjeWNsaWNDb21wb25lbnQiLCJub25DeWNsaWNQcm9kdWN0aW9ucyIsIm5vbkN5Y2xpY1Byb2R1Y3Rpb25zRnJvbUN5Y2xpY0NvbXBvbmVudCIsIm5vbkN5Y2xpY0NvbXBvbmVudCIsInByb2R1Y3Rpb25Gcm9tTm9uQ3ljbGljQ29tcG9uZW50IiwibWFwVmVydGV4IiwidmVydGV4IiwiZmluZFByb2R1Y3Rpb24iLCJ1bml0UHJvZHVjdGlvbnMiLCJ1bml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMiLCJjeWNsaWNQcm9kdWN0aW9uRWRnZXMiLCJnZXRVbml0UHJvZHVjdGlvbnMiLCJub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleCIsImdldEZpcnN0VmVydGV4Iiwibm9uQ3ljbGljQ29tcG9uZW50Rmlyc3RWZXJ0ZXhOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsUUFBUUMsUUFBUSxVQUFSLENBQWQ7QUFBQSxJQUNNQyxtQkFBbUJELFFBQVEsNkJBQVIsQ0FEekI7QUFBQSxJQUVNRSwyQkFBMkJGLFFBQVEscUNBQVIsQ0FGakM7QUFBQSxJQUdNRyw2QkFBNkJILFFBQVEsdUNBQVIsQ0FIbkM7QUFBQSxJQUlNSSx1Q0FBdUNKLFFBQVEsaURBQVIsQ0FKN0M7O0lBTU1LLFU7Ozs7Ozs7b0NBQ21CQyxLLEVBQU87QUFDNUIsVUFBTUMsU0FBU0QsTUFBTUUsTUFBTixDQUFhLFVBQVNELE1BQVQsRUFBaUJFLElBQWpCLEVBQXVCO0FBQ2pELFlBQU1DLGFBQWFELEtBQUtFLFNBQUwsRUFBbkI7O0FBRUFKLGlCQUFTQSxPQUFPSyxNQUFQLENBQWNGLFVBQWQsQ0FBVDs7QUFFQSxlQUFPSCxNQUFQO0FBQ0QsT0FOYyxFQU1aLEVBTlksQ0FBZjs7QUFRQSxhQUFPQSxNQUFQO0FBQ0Q7OztvQ0FFc0JNLFcsRUFBYTtBQUNsQyxVQUFNQyxvQkFBb0JDLGlDQUFpQ0YsV0FBakMsQ0FBMUI7QUFBQSxVQUNNRyxRQUFRQywyQkFBMkJILGlCQUEzQixDQURkO0FBQUEsVUFFTUksYUFBYUYsTUFBTUcsYUFBTixFQUZuQjs7QUFJQU4sb0JBQWNPLDBCQUEwQkYsVUFBMUIsRUFBc0NMLFdBQXRDLENBQWQ7O0FBRUEsYUFBT0EsV0FBUDtBQUNEOzs7MkNBRTZCQSxXLEVBQWE7QUFDekMsVUFBTVEsOEJBQThCLEVBQXBDO0FBQUEsVUFDTUMsNEJBQTRCLEVBRGxDOztBQUdBVCxrQkFBWVUsT0FBWixDQUFvQixVQUFTQyxVQUFULEVBQXFCQyxLQUFyQixFQUE0QjtBQUM5QyxZQUFNQyxRQUFRLENBQWQ7QUFBQSxZQUNNQyxNQUFNRixLQURaO0FBQUEsWUFDb0I7QUFDZEcsOENBQXNDUCw0QkFBNEJRLEtBQTVCLENBQWtDSCxLQUFsQyxFQUF5Q0MsR0FBekMsQ0FGNUM7QUFBQSxZQUdNRyxzQkFBc0JGLG1DQUg1QjtBQUFBLFlBR2tFO0FBQzVERyw0Q0FBb0NQLFdBQVdRLHlCQUFYLENBQXFDRixtQkFBckMsQ0FKMUM7O0FBTUEsWUFBSUMsaUNBQUosRUFBdUM7QUFDckMsY0FBTUUsdUNBQXVDN0IscUNBQXFDOEIsb0NBQXJDLENBQTBFVixVQUExRSxFQUFzRk0sbUJBQXRGLENBQTdDOztBQUVBTix1QkFBYVMsb0NBQWIsQ0FIcUMsQ0FHZTtBQUNyRDs7QUFFRCxZQUFNRSwwQkFBMEJYLFdBQVdZLGVBQVgsRUFBaEM7O0FBRUEsWUFBSUQsdUJBQUosRUFBNkI7QUFDM0IsY0FBTUUsNkJBQTZCbEMsMkJBQTJCbUMsY0FBM0IsQ0FBMENkLFVBQTFDLENBQW5DO0FBQUEsY0FDTWUsMkJBQTJCckMseUJBQXlCb0MsY0FBekIsQ0FBd0NkLFVBQXhDLENBRGpDOztBQUdBSCxzQ0FBNEJtQixJQUE1QixDQUFpQ0gsMEJBQWpDOztBQUVBZixvQ0FBMEJrQixJQUExQixDQUErQkQsd0JBQS9CO0FBQ0QsU0FQRCxNQU9PO0FBQ0wsY0FBTUYsOEJBQTZCYixVQUFuQyxDQURLLENBQzJDOztBQUVoREgsc0NBQTRCbUIsSUFBNUIsQ0FBaUNILDJCQUFqQztBQUNEO0FBQ0YsT0EzQkQ7O0FBNkJBeEIsb0JBQWMsR0FBR0QsTUFBSCxDQUFVUywyQkFBVixFQUF1Q1QsTUFBdkMsQ0FBOENVLHlCQUE5QyxDQUFkOztBQUVBLGFBQU9ULFdBQVA7QUFDRDs7O21DQUVxQjRCLGMsRUFBZ0I1QixXLEVBQWE7QUFDakQsVUFBSTZCLGtCQUFrQixJQUF0Qjs7QUFFQTdCLGtCQUFZOEIsSUFBWixDQUFpQixVQUFTbkIsVUFBVCxFQUFxQjtBQUNwQyxZQUFNb0IsT0FBT3BCLFdBQVdxQixPQUFYLEVBQWI7O0FBRUEsWUFBSUQsU0FBU0gsY0FBYixFQUE2QjtBQUMzQkMsNEJBQWtCbEIsVUFBbEI7O0FBRUEsaUJBQU8sSUFBUDtBQUNEO0FBQ0YsT0FSRDs7QUFVQSxVQUFNQSxhQUFha0IsZUFBbkI7O0FBRUEsYUFBT2xCLFVBQVA7QUFDRDs7Ozs7O0FBR0hzQixPQUFPQyxPQUFQLEdBQWlCMUMsVUFBakI7O0FBRUEsU0FBU1UsZ0NBQVQsQ0FBMENGLFdBQTFDLEVBQXVEO0FBQ3JELE1BQU1DLG9CQUFvQkQsWUFBWUwsTUFBWixDQUFtQixVQUFTTSxpQkFBVCxFQUE0QlUsVUFBNUIsRUFBd0M7QUFDbkYsUUFBTXdCLG1CQUFtQi9DLGlCQUFpQnFDLGNBQWpCLENBQWdDZCxVQUFoQyxDQUF6Qjs7QUFFQSxRQUFJd0IscUJBQXFCLElBQXpCLEVBQStCO0FBQzdCbEMsd0JBQWtCMEIsSUFBbEIsQ0FBdUJRLGdCQUF2QjtBQUNEOztBQUVELFdBQU9sQyxpQkFBUDtBQUNELEdBUnlCLEVBUXZCLEVBUnVCLENBQTFCOztBQVVBLFNBQU9BLGlCQUFQO0FBQ0Q7O0FBRUQsU0FBU0csMEJBQVQsQ0FBb0NILGlCQUFwQyxFQUF1RDtBQUNyRCxNQUFNRSxRQUFRLElBQUlqQixLQUFKLEVBQWQ7O0FBRUFlLG9CQUFrQlMsT0FBbEIsQ0FBMEIsVUFBU3lCLGdCQUFULEVBQTJCO0FBQ25ELFFBQU1DLHVCQUF1QkQsaUJBQWlCSCxPQUFqQixFQUE3QjtBQUFBLFFBQ01LLHVDQUF1Q0YsaUJBQWlCRyx1QkFBakIsRUFEN0M7QUFBQSxRQUVNQyxhQUFhSCxvQkFGbkI7QUFBQSxRQUUwQztBQUNwQ0ksNEJBQXdCSCxvQ0FIOUIsQ0FEbUQsQ0FJaUI7O0FBRXBFbEMsVUFBTXNDLFNBQU4sQ0FBZ0JGLFVBQWhCLEVBQTRCQyxxQkFBNUI7QUFDRCxHQVBEOztBQVNBLFNBQU9yQyxLQUFQO0FBQ0Q7O0FBRUQsU0FBU0kseUJBQVQsQ0FBbUNGLFVBQW5DLEVBQStDTCxXQUEvQyxFQUE0RDtBQUMxRCxNQUFNMEMsdUJBQXVCckMsV0FBV1YsTUFBWCxDQUFrQixVQUFTK0Msb0JBQVQsRUFBK0JDLFNBQS9CLEVBQTBDO0FBQ3ZGLFFBQU1DLGtCQUFrQkQsVUFBVUUsUUFBVixFQUF4Qjs7QUFFQSxRQUFJRCxlQUFKLEVBQXFCO0FBQ25CLFVBQU1FLGtCQUFrQkgsU0FBeEI7QUFBQSxVQUFvQztBQUM5QkksNkJBQXVCQyx3Q0FBd0NGLGVBQXhDLEVBQXlEOUMsV0FBekQsQ0FEN0I7O0FBR0EwQyw2QkFBdUJBLHFCQUFxQjNDLE1BQXJCLENBQTRCZ0Qsb0JBQTVCLENBQXZCO0FBQ0QsS0FMRCxNQUtPO0FBQ0wsVUFBTUUscUJBQXFCTixTQUEzQjtBQUFBLFVBQXVDO0FBQ2pDaEMsbUJBQWF1QyxpQ0FBaUNELGtCQUFqQyxFQUFxRGpELFdBQXJELENBRG5COztBQUdBMEMsMkJBQXFCZixJQUFyQixDQUEwQmhCLFVBQTFCO0FBQ0Q7O0FBRUQsV0FBTytCLG9CQUFQO0FBQ0QsR0FoQjRCLEVBZ0IxQixFQWhCMEIsQ0FBN0I7O0FBa0JBMUMsZ0JBQWMwQyxvQkFBZCxDQW5CMEQsQ0FtQnRCOztBQUVwQyxTQUFPMUMsV0FBUDtBQUNEOztBQUVELFNBQVNnRCx1Q0FBVCxDQUFpREYsZUFBakQsRUFBa0U5QyxXQUFsRSxFQUErRTtBQUM3RSxNQUFNQyxvQkFBb0I2QyxnQkFBZ0JLLFNBQWhCLENBQTBCLFVBQVNDLE1BQVQsRUFBaUI7QUFDN0QsUUFBTWIsYUFBYWEsT0FBT3BCLE9BQVAsRUFBbkI7QUFBQSxRQUNNSSx1QkFBdUJHLFVBRDdCO0FBQUEsUUFDMEM7QUFDcEM1QixpQkFBYW5CLFdBQVc2RCxjQUFYLENBQTBCakIsb0JBQTFCLEVBQWdEcEMsV0FBaEQsQ0FGbkI7QUFBQSxRQUdNbUMsbUJBQW1CL0MsaUJBQWlCcUMsY0FBakIsQ0FBZ0NkLFVBQWhDLENBSHpCOztBQUtBLFdBQU93QixnQkFBUDtBQUNELEdBUG1CLENBQTFCO0FBQUEsTUFRTW1CLGtCQUFrQkMscUNBQXFDdEQsaUJBQXJDLENBUnhCOztBQVVBO0FBQ0Q7O0FBRUQsU0FBU3NELG9DQUFULENBQThDdEQsaUJBQTlDLEVBQWlFO0FBQy9ELE1BQU1xRCxrQkFBa0JyRCxrQkFBa0JOLE1BQWxCLENBQXlCLFVBQVMyRCxlQUFULEVBQTBCbkIsZ0JBQTFCLEVBQTRDO0FBQzNGLFFBQU1xQix3QkFBd0JyQixpQkFBaUJzQixrQkFBakIsRUFBOUI7O0FBRUFILHNCQUFrQkEsZ0JBQWdCdkQsTUFBaEIsQ0FBdUJ5RCxxQkFBdkIsQ0FBbEI7O0FBRUEsV0FBT0YsZUFBUDtBQUNELEdBTnVCLEVBTXJCLEVBTnFCLENBQXhCOztBQVFBLFNBQU9BLGVBQVA7QUFDRDs7QUFFRCxTQUFTSixnQ0FBVCxDQUEwQ0Qsa0JBQTFDLEVBQThEakQsV0FBOUQsRUFBMkU7QUFDekUsTUFBTTBELGdDQUFnQ1QsbUJBQW1CVSxjQUFuQixFQUF0QztBQUFBLE1BQ01DLG9DQUFvQ0YsOEJBQThCMUIsT0FBOUIsRUFEMUM7QUFBQSxNQUVNSixpQkFBaUJnQyxpQ0FGdkI7QUFBQSxNQUUyRDtBQUNyRGpELGVBQWFuQixXQUFXNkQsY0FBWCxDQUEwQnpCLGNBQTFCLEVBQTBDNUIsV0FBMUMsQ0FIbkI7O0FBS0EsU0FBT1csVUFBUDtBQUNEIiwiZmlsZSI6InBhcnNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgR3JhcGggPSByZXF1aXJlKCcuLi9ncmFwaCcpLFxuICAgICAgQ3ljbGljUHJvZHVjdGlvbiA9IHJlcXVpcmUoJy4uL2NvbW1vbi9wcm9kdWN0aW9uL2N5Y2xpYycpLFxuICAgICAgUmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi4vY29tbW9uL3Byb2R1Y3Rpb24vcmlnaHRSZWN1cnNpdmUnKSxcbiAgICAgIE5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi4vY29tbW9uL3Byb2R1Y3Rpb24vbm9uTGVmdFJlY3Vyc2l2ZScpLFxuICAgICAgTm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcmVxdWlyZSgnLi4vY29tbW9uL3Byb2R1Y3Rpb24vbm9uSW1wbGljaXRseUxlZnRSZWN1cnNpdmUnKTtcblxuY2xhc3MgcGFyc2VyVXRpbCB7XG4gIHN0YXRpYyB0b2tlbnNGcm9tTGluZXMobGluZXMpIHtcbiAgICBjb25zdCB0b2tlbnMgPSBsaW5lcy5yZWR1Y2UoZnVuY3Rpb24odG9rZW5zLCBsaW5lKSB7XG4gICAgICBjb25zdCBsaW5lVG9rZW5zID0gbGluZS5nZXRUb2tlbnMoKTtcblxuICAgICAgdG9rZW5zID0gdG9rZW5zLmNvbmNhdChsaW5lVG9rZW5zKTtcblxuICAgICAgcmV0dXJuIHRva2VucztcbiAgICB9LCBbXSk7XG5cbiAgICByZXR1cm4gdG9rZW5zO1xuICB9XG5cbiAgc3RhdGljIGVsaW1pbmF0ZUN5Y2xlcyhwcm9kdWN0aW9ucykge1xuICAgIGNvbnN0IGN5Y2xpY1Byb2R1Y3Rpb25zID0gY3ljbGljUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGdyYXBoID0gZ3JhcGhGcm9tQ3ljbGljUHJvZHVjdGlvbnMoY3ljbGljUHJvZHVjdGlvbnMpLFxuICAgICAgICAgIGNvbXBvbmVudHMgPSBncmFwaC5nZXRDb21wb25lbnRzKCk7XG5cbiAgICBwcm9kdWN0aW9ucyA9IHByb2R1Y3Rpb25zRnJvbUNvbXBvbmVudHMoY29tcG9uZW50cywgcHJvZHVjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25zO1xuICB9XG5cbiAgc3RhdGljIGVsaW1pbmF0ZUxlZnRSZWN1cnNpb24ocHJvZHVjdGlvbnMpIHtcbiAgICBjb25zdCBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMgPSBbXSxcbiAgICAgICAgICByaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb25zID0gW107XG5cbiAgICBwcm9kdWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHByb2R1Y3Rpb24sIGluZGV4KSB7XG4gICAgICBjb25zdCBiZWdpbiA9IDAsXG4gICAgICAgICAgICBlbmQgPSBpbmRleCwgIC8vL1xuICAgICAgICAgICAgcHJldmlvdXNOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMgPSBub25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMuc2xpY2UoYmVnaW4sIGVuZCksXG4gICAgICAgICAgICBwcmV2aW91c1Byb2R1Y3Rpb25zID0gcHJldmlvdXNOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbnMsICAvLy9cbiAgICAgICAgICAgIHByb2R1Y3Rpb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZSA9IHByb2R1Y3Rpb24uaXNJbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZShwcmV2aW91c1Byb2R1Y3Rpb25zKTtcblxuICAgICAgaWYgKHByb2R1Y3Rpb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZSkge1xuICAgICAgICBjb25zdCBub25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSBOb25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24uZnJvbVByb2R1Y3Rpb25BbmRQcmV2aW91c1Byb2R1Y3Rpb25zKHByb2R1Y3Rpb24sIHByZXZpb3VzUHJvZHVjdGlvbnMpO1xuXG4gICAgICAgIHByb2R1Y3Rpb24gPSBub25JbXBsaWNpdGx5TGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb247ICAvLy9cbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvZHVjdGlvbkxlZnRSZWN1cnNpdmUgPSBwcm9kdWN0aW9uLmlzTGVmdFJlY3Vyc2l2ZSgpO1xuXG4gICAgICBpZiAocHJvZHVjdGlvbkxlZnRSZWN1cnNpdmUpIHtcbiAgICAgICAgY29uc3Qgbm9uTGVmdFJlY3Vyc2l2ZVByb2R1Y3Rpb24gPSBOb25MZWZ0UmVjdXJzaXZlUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKSxcbiAgICAgICAgICAgICAgcmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uID0gUmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uLmZyb21Qcm9kdWN0aW9uKHByb2R1Y3Rpb24pO1xuXG4gICAgICAgIG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucy5wdXNoKG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uKTtcblxuICAgICAgICByaWdodFJlY3Vyc2l2ZVByb2R1Y3Rpb25zLnB1c2gocmlnaHRSZWN1cnNpdmVQcm9kdWN0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uID0gcHJvZHVjdGlvbjsgIC8vL1xuXG4gICAgICAgIG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucy5wdXNoKG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9uKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHByb2R1Y3Rpb25zID0gW10uY29uY2F0KG5vbkxlZnRSZWN1cnNpdmVQcm9kdWN0aW9ucykuY29uY2F0KHJpZ2h0UmVjdXJzaXZlUHJvZHVjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHByb2R1Y3Rpb25zO1xuICB9XG5cbiAgc3RhdGljIGZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucykge1xuICAgIGxldCBmb3VuZFByb2R1Y3Rpb24gPSBudWxsO1xuXG4gICAgcHJvZHVjdGlvbnMuc29tZShmdW5jdGlvbihwcm9kdWN0aW9uKSB7XG4gICAgICBjb25zdCBuYW1lID0gcHJvZHVjdGlvbi5nZXROYW1lKCk7XG5cbiAgICAgIGlmIChuYW1lID09PSBwcm9kdWN0aW9uTmFtZSkge1xuICAgICAgICBmb3VuZFByb2R1Y3Rpb24gPSBwcm9kdWN0aW9uO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcHJvZHVjdGlvbiA9IGZvdW5kUHJvZHVjdGlvbjtcblxuICAgIHJldHVybiBwcm9kdWN0aW9uO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gcGFyc2VyVXRpbDtcblxuZnVuY3Rpb24gY3ljbGljUHJvZHVjdGlvbnNGcm9tUHJvZHVjdGlvbnMocHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgY3ljbGljUHJvZHVjdGlvbnMgPSBwcm9kdWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24oY3ljbGljUHJvZHVjdGlvbnMsIHByb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBjeWNsaWNQcm9kdWN0aW9uID0gQ3ljbGljUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgIGlmIChjeWNsaWNQcm9kdWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjeWNsaWNQcm9kdWN0aW9ucy5wdXNoKGN5Y2xpY1Byb2R1Y3Rpb24pO1xuICAgIH1cblxuICAgIHJldHVybiBjeWNsaWNQcm9kdWN0aW9ucztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBjeWNsaWNQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gZ3JhcGhGcm9tQ3ljbGljUHJvZHVjdGlvbnMoY3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgZ3JhcGggPSBuZXcgR3JhcGgoKTtcblxuICBjeWNsaWNQcm9kdWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKGN5Y2xpY1Byb2R1Y3Rpb24pIHtcbiAgICBjb25zdCBjeWNsaWNQcm9kdWN0aW9uTmFtZSA9IGN5Y2xpY1Byb2R1Y3Rpb24uZ2V0TmFtZSgpLFxuICAgICAgICAgIGN5Y2xpY1Byb2R1Y3Rpb25SdWxlc1Byb2R1Y3Rpb25OYW1lcyA9IGN5Y2xpY1Byb2R1Y3Rpb24uZ2V0UnVsZXNQcm9kdWN0aW9uTmFtZXMoKSxcbiAgICAgICAgICB2ZXJ0ZXhOYW1lID0gY3ljbGljUHJvZHVjdGlvbk5hbWUsICAvLy9cbiAgICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSBjeWNsaWNQcm9kdWN0aW9uUnVsZXNQcm9kdWN0aW9uTmFtZXM7IC8vL1xuXG4gICAgZ3JhcGguYWRkVmVydGV4KHZlcnRleE5hbWUsIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyk7XG4gIH0pO1xuXG4gIHJldHVybiBncmFwaDtcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbnNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzLCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBjb21wb25lbnRQcm9kdWN0aW9ucyA9IGNvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKGNvbXBvbmVudFByb2R1Y3Rpb25zLCBjb21wb25lbnQpIHtcbiAgICBjb25zdCBjb21wb25lbnRDeWNsaWMgPSBjb21wb25lbnQuaXNDeWNsaWMoKTtcblxuICAgIGlmIChjb21wb25lbnRDeWNsaWMpIHtcbiAgICAgIGNvbnN0IGN5Y2xpY0NvbXBvbmVudCA9IGNvbXBvbmVudCwgIC8vL1xuICAgICAgICAgICAgbm9uQ3ljbGljUHJvZHVjdGlvbnMgPSBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQoY3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucyk7XG5cbiAgICAgIGNvbXBvbmVudFByb2R1Y3Rpb25zID0gY29tcG9uZW50UHJvZHVjdGlvbnMuY29uY2F0KG5vbkN5Y2xpY1Byb2R1Y3Rpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgbm9uQ3ljbGljQ29tcG9uZW50ID0gY29tcG9uZW50LCAgLy8vXG4gICAgICAgICAgICBwcm9kdWN0aW9uID0gcHJvZHVjdGlvbkZyb21Ob25DeWNsaWNDb21wb25lbnQobm9uQ3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucyk7XG5cbiAgICAgIGNvbXBvbmVudFByb2R1Y3Rpb25zLnB1c2gocHJvZHVjdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbXBvbmVudFByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcHJvZHVjdGlvbnMgPSBjb21wb25lbnRQcm9kdWN0aW9uczsgLy8vXG5cbiAgcmV0dXJuIHByb2R1Y3Rpb25zO1xufVxuXG5mdW5jdGlvbiBub25DeWNsaWNQcm9kdWN0aW9uc0Zyb21DeWNsaWNDb21wb25lbnQoY3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBjeWNsaWNQcm9kdWN0aW9ucyA9IGN5Y2xpY0NvbXBvbmVudC5tYXBWZXJ0ZXgoZnVuY3Rpb24odmVydGV4KSB7XG4gICAgICAgICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCksXG4gICAgICAgICAgICAgICAgY3ljbGljUHJvZHVjdGlvbk5hbWUgPSB2ZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgICAgICAgcHJvZHVjdGlvbiA9IHBhcnNlclV0aWwuZmluZFByb2R1Y3Rpb24oY3ljbGljUHJvZHVjdGlvbk5hbWUsIHByb2R1Y3Rpb25zKSxcbiAgICAgICAgICAgICAgICBjeWNsaWNQcm9kdWN0aW9uID0gQ3ljbGljUHJvZHVjdGlvbi5mcm9tUHJvZHVjdGlvbihwcm9kdWN0aW9uKTtcblxuICAgICAgICAgIHJldHVybiBjeWNsaWNQcm9kdWN0aW9uO1xuICAgICAgICB9KSxcbiAgICAgICAgdW5pdFByb2R1Y3Rpb25zID0gdW5pdFByb2R1Y3Rpb25zRnJvbUN5Y2xpY1Byb2R1Y3Rpb25zKGN5Y2xpY1Byb2R1Y3Rpb25zKTtcblxuICBkZWJ1Z2dlclxufVxuXG5mdW5jdGlvbiB1bml0UHJvZHVjdGlvbnNGcm9tQ3ljbGljUHJvZHVjdGlvbnMoY3ljbGljUHJvZHVjdGlvbnMpIHtcbiAgY29uc3QgdW5pdFByb2R1Y3Rpb25zID0gY3ljbGljUHJvZHVjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKHVuaXRQcm9kdWN0aW9ucywgY3ljbGljUHJvZHVjdGlvbikge1xuICAgIGNvbnN0IGN5Y2xpY1Byb2R1Y3Rpb25FZGdlcyA9IGN5Y2xpY1Byb2R1Y3Rpb24uZ2V0VW5pdFByb2R1Y3Rpb25zKCk7XG5cbiAgICB1bml0UHJvZHVjdGlvbnMgPSB1bml0UHJvZHVjdGlvbnMuY29uY2F0KGN5Y2xpY1Byb2R1Y3Rpb25FZGdlcyk7XG5cbiAgICByZXR1cm4gdW5pdFByb2R1Y3Rpb25zO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIHVuaXRQcm9kdWN0aW9ucztcbn1cblxuZnVuY3Rpb24gcHJvZHVjdGlvbkZyb21Ob25DeWNsaWNDb21wb25lbnQobm9uQ3ljbGljQ29tcG9uZW50LCBwcm9kdWN0aW9ucykge1xuICBjb25zdCBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleCA9IG5vbkN5Y2xpY0NvbXBvbmVudC5nZXRGaXJzdFZlcnRleCgpLFxuICAgICAgICBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleE5hbWUgPSBub25DeWNsaWNDb21wb25lbnRGaXJzdFZlcnRleC5nZXROYW1lKCksXG4gICAgICAgIHByb2R1Y3Rpb25OYW1lID0gbm9uQ3ljbGljQ29tcG9uZW50Rmlyc3RWZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgIHByb2R1Y3Rpb24gPSBwYXJzZXJVdGlsLmZpbmRQcm9kdWN0aW9uKHByb2R1Y3Rpb25OYW1lLCBwcm9kdWN0aW9ucyk7XG5cbiAgcmV0dXJuIHByb2R1Y3Rpb247XG59Il19